<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Skripsi - STAI Al-Mas'udiyah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBSsjGey5Akia8nDt5UC0Kucsl_lcGhNVY",
            authDomain: "bimskripsi-b3e64.firebaseapp.com",
            projectId: "bimskripsi-b3e64",
            storageBucket: "bimskripsi-b3e64.firebasestorage.app",
            messagingSenderId: "754252286102",
            appId: "1:754252286102:web:6898cd13fcbc8b13839ab7"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase functions globally available
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .step-active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .step-pending {
            background: #f3f4f6;
            color: #6b7280;
        }
        .step-completed {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-center space-x-4">
                <img src="https://iili.io/KdXnlX2.png" alt="Logo STAI Al-Mas'udiyah" class="h-16 w-16 object-contain" onerror="this.src=''; this.alt='Logo tidak dapat dimuat'; this.style.display='none';">
                <div class="text-center">
                    <h1 class="text-2xl md:text-3xl font-bold text-white">MANAJEMEN SKRIPSI/TUGAS AKHIR</h1>
                    <p class="text-blue-100 text-lg font-medium">STAI AL-MAS'UDIYAH SUKABUMI</p>
                </div>
            </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-center space-x-8 py-4">
                <button onclick="showPage('dashboard')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white">Dashboard</button>
                <button onclick="showPage('mahasiswa')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-600 hover:bg-blue-50">Mahasiswa</button>
                <button onclick="showPage('prodi')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-600 hover:bg-blue-50">Program Studi</button>
                <button onclick="showPage('dosen')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-600 hover:bg-blue-50">Dosen</button>
                <button onclick="showPage('manajemen')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-600 hover:bg-blue-50">Manajemen</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page-content">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Alur Manajemen Skripsi</h2>
                <p class="text-gray-600">Sistem manajemen skripsi terintegrasi untuk mahasiswa, program studi, dan dosen</p>
            </div>

            <!-- Process Flow -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Alur Proses Skripsi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="step-card p-4 rounded-lg border-l-4 border-blue-500 bg-blue-50">
                        <div class="font-semibold text-blue-800">1. Pengajuan Judul</div>
                        <p class="text-sm text-blue-600 mt-1">Mahasiswa mengajukan judul skripsi</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-green-500 bg-green-50">
                        <div class="font-semibold text-green-800">2. Validasi Prodi</div>
                        <p class="text-sm text-green-600 mt-1">Program Studi memvalidasi judul</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-purple-500 bg-purple-50">
                        <div class="font-semibold text-purple-800">3. Persetujuan Dosen Wali</div>
                        <p class="text-sm text-purple-600 mt-1">Dosen wali menandatangani form</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-yellow-500 bg-yellow-50">
                        <div class="font-semibold text-yellow-800">4. Penyusunan Proposal</div>
                        <p class="text-sm text-yellow-600 mt-1">Mahasiswa menyusun proposal</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-red-500 bg-red-50">
                        <div class="font-semibold text-red-800">5. Seminar Proposal</div>
                        <p class="text-sm text-red-600 mt-1">Pelaksanaan seminar proposal</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-indigo-500 bg-indigo-50">
                        <div class="font-semibold text-indigo-800">6. Penetapan Pembimbing</div>
                        <p class="text-sm text-indigo-600 mt-1">SK Pembimbing 1 dan 2</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-pink-500 bg-pink-50">
                        <div class="font-semibold text-pink-800">7. Proses Bimbingan</div>
                        <p class="text-sm text-pink-600 mt-1">Minimal 12 kali bimbingan</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-teal-500 bg-teal-50">
                        <div class="font-semibold text-teal-800">8. Pengajuan Munaqosyah</div>
                        <p class="text-sm text-teal-600 mt-1">Pengajuan sidang akhir</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-gray-500 bg-gray-50">
                        <div class="font-semibold text-gray-800">9. Jadwal Munaqosyah</div>
                        <p class="text-sm text-gray-600 mt-1">Penjadwalan sidang akhir</p>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100">
                            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Total Mahasiswa</h3>
                            <p class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Skripsi Selesai</h3>
                            <p class="text-2xl font-bold text-green-600">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100">
                            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Dalam Proses</h3>
                            <p class="text-2xl font-bold text-yellow-600">0</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Mahasiswa Page -->
        <div id="mahasiswa" class="page-content hidden">
            <!-- Login Form Mahasiswa -->
            <div id="loginMahasiswa" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Login Mahasiswa</h2>
                    <p class="text-gray-600 mt-2">Masukkan NIM untuk mengakses portal</p>

                </div>
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                        <input type="text" id="nimLogin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM Anda">
                    </div>
                    <button type="button" onclick="loginMahasiswa()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">Masuk Portal</button>
                </form>
            </div>

            <!-- Portal Mahasiswa Content -->
            <div id="portalMahasiswa" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Portal Mahasiswa</h2>
                    <div class="flex items-center space-x-4">
                        <span id="welcomeMahasiswa" class="text-gray-600"></span>
                        <button onclick="logoutMahasiswa()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">Logout</button>
                    </div>
                </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Form Pengajuan Judul -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üìù Pengajuan Judul Skripsi</h3>
                    <form class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama lengkap">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Judul Skripsi</label>
                            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Masukkan judul skripsi yang diajukan"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Latar Belakang Singkat</label>
                            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-32" placeholder="Jelaskan latar belakang penelitian"></textarea>
                        </div>
                        <button type="button" onclick="submitJudul()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Ajukan Judul</button>
                    </form>
                </div>

                <!-- Status Pengajuan -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Status Pengajuan & Notifikasi</h3>
                    <div id="statusPengajuan" class="space-y-4">
                        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium text-yellow-800">Menunggu Validasi Prodi</p>
                                    <p class="text-sm text-yellow-600">Diajukan: 15 Januari 2025</p>
                                </div>
                                <span class="px-3 py-1 bg-yellow-200 text-yellow-800 rounded-full text-sm">Pending</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notifikasi Jadwal Seminar -->
                    <div id="notifikasiSeminar" class="mt-4 space-y-3">
                        <!-- Notifikasi akan muncul di sini -->
                    </div>
                </div>
            </div>

            <!-- Form Pengajuan Seminar Proposal -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üéØ Pengajuan Seminar Proposal</h3>
                <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                        <input type="text" id="nimSeminar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Pengajuan</label>
                        <input type="date" id="tanggalSeminar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Proposal</label>
                        <textarea id="catatanProposal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Masukkan catatan atau ringkasan proposal skripsi"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <button type="button" onclick="submitSeminar()" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Ajukan Seminar Proposal</button>
                    </div>
                </form>
            </div>

            <!-- Rekapitulasi Pengajuan Seminar Proposal Mahasiswa -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Rekapitulasi Pengajuan Seminar Proposal</h3>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal Pengajuan</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="rekapSeminarMahasiswa" class="divide-y divide-gray-200">
                            <!-- Data akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Form Pengajuan Munaqosyah -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üéì Pengajuan Sidang Munaqosyah</h3>
                <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Bimbingan</label>
                        <input type="number" min="12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Minimal 12 kali">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Skripsi Final</label>
                        <textarea id="catatanSkripsi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Masukkan ringkasan atau catatan skripsi final"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Kartu Bimbingan</label>
                        <textarea id="catatanKartuBimbingan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Masukkan ringkasan kartu bimbingan"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <button type="button" onclick="submitMunaqosyah()" class="bg-purple-600 text-white py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors">Ajukan Sidang Munaqosyah</button>
                    </div>
                </form>
            </div>
            </div>
        </div>

        <!-- Program Studi Page -->
        <div id="prodi" class="page-content hidden">
            <!-- Login Form Program Studi -->
            <div id="loginProdi" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Login Program Studi</h2>
                    <p class="text-gray-600 mt-2">Masukkan username dan password</p>

                </div>
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="usernameProdi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="passwordProdi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                    </div>
                    <button type="button" onclick="loginProdi()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">Masuk Portal</button>
                </form>
            </div>

            <!-- Portal Program Studi Content -->
            <div id="portalProdi" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Portal Program Studi</h2>
                    <div class="flex items-center space-x-4">
                        <span id="welcomeProdi" class="text-gray-600"></span>
                        <button onclick="logoutProdi()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">Logout</button>
                    </div>
                </div>
            
            <!-- Notifikasi Program Studi -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üîî Notifikasi Program Studi</h3>
                <div id="notifikasiProdi" class="space-y-3">
                    <!-- Notifikasi akan muncul di sini -->
                </div>
            </div>

            <!-- Validasi Judul -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">‚úÖ Validasi Judul Skripsi</h3>
                <div class="mb-4 flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Pilih Semua</span>
                    </label>
                    <button onclick="validasiMassal('terima')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">DITERIMA</button>
                    <button onclick="validasiMassal('tolak')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">DITOLAK</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pilih</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Judul</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="judulTable" class="divide-y divide-gray-200">
                            <!-- Data akan dimuat dari Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Penjadwalan Seminar -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìÖ Penjadwalan Seminar Proposal</h3>
                <form class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mahasiswa</label>
                        <select id="mahasiswaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Mahasiswa</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal & Waktu</label>
                        <input type="datetime-local" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ruangan</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ruang 101">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Penguji 1</label>
                        <select id="penguji1Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Penguji 1</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Penguji 2</label>
                        <select id="penguji2Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Penguji 2</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="button" onclick="buatJadwalSeminar()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Buat Jadwal</button>
                    </div>
                </form>
            </div>

            <!-- Rekapitulasi Pengajuan Seminar Proposal Program Studi -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Rekapitulasi Pengajuan Seminar Proposal</h3>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal Pengajuan</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="rekapSeminarProdi" class="divide-y divide-gray-200">
                            <!-- Data akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Rekapitulasi Jadwal Seminar -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Rekapitulasi Jadwal Seminar Proposal</h3>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Mahasiswa</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal & Waktu</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Ruangan</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Penguji 1</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Penguji 2</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="rekapJadwalSeminar" class="divide-y divide-gray-200">
                            <!-- Data jadwal akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SK Pembimbing -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Penetapan Pembimbing</h3>
                <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mahasiswa</label>
                        <select id="mahasiswaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Mahasiswa</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nomor SK</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="SK/001/2025">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pembimbing 1</label>
                        <select id="penguji1Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Penguji 1</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pembimbing 2</label>
                        <select id="penguji2Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Penguji 2</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <button type="button" onclick="terbitkanSK()" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Terbitkan SK Pembimbing</button>
                    </div>
                </form>
            </div>
            </div>
        </div>

        <!-- Dosen Page -->
        <div id="dosen" class="page-content hidden">
            <!-- Login Form Dosen -->
            <div id="loginDosen" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Login Dosen</h2>
                    <p class="text-gray-600 mt-2">Masukkan username dan password</p>

                </div>
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="usernameDosen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="passwordDosen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                    </div>
                    <button type="button" onclick="loginDosen()" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors font-medium">Masuk Portal</button>
                </form>
            </div>

            <!-- Portal Dosen Content -->
            <div id="portalDosen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Portal Dosen</h2>
                    <div class="flex items-center space-x-4">
                        <span id="welcomeDosen" class="text-gray-600"></span>
                        <button onclick="logoutDosen()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">Logout</button>
                    </div>
                </div>
                
                <!-- Notifikasi Jadwal Seminar -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üîî Notifikasi Jadwal Seminar</h3>
                    <div id="notifikasiJadwalDosen" class="space-y-3">
                        <!-- Notifikasi jadwal seminar akan muncul di sini -->
                    </div>
                </div>

                <!-- Persetujuan Dosen Wali -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">‚úçÔ∏è Persetujuan Dosen Wali</h3>
                <div class="overflow-x-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Judul</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="persetujuanDosenTable" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Kartu Bimbingan -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìù Kartu Bimbingan</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Input Bimbingan Baru</h4>
                        <form class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mahasiswa</label>
                                <select id="bimbinganMahasiswaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Mahasiswa</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Bimbingan</label>
                                <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Materi Bimbingan</label>
                                <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Jelaskan materi yang dibimbing"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Catatan/Saran</label>
                                <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Catatan dan saran untuk mahasiswa"></textarea>
                            </div>
                            <button type="button" onclick="simpanBimbingan()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Simpan Bimbingan</button>
                        </form>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-700">Riwayat Bimbingan</h4>
                            <button onclick="printKartuBimbingan()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 no-print">üñ®Ô∏è Print Kartu</button>
                        </div>
                        <div id="riwayatBimbingan" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="p-3 border border-gray-200 rounded-lg">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="font-medium text-sm">Bimbingan #1</span>
                                    <span class="text-xs text-gray-500">15 Jan 2025</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-1">Pembahasan BAB I - Pendahuluan</p>
                                <p class="text-xs text-gray-500">Perbaiki latar belakang masalah</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Manajemen Page -->
        <div id="manajemen" class="page-content hidden">
            <!-- Login Form Manajemen -->
            <div id="loginManajemen" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Login Manajemen</h2>
                    <p class="text-gray-600 mt-2">Masukkan username dan password administrator</p>

                </div>
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="usernameManajemen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="passwordManajemen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                    </div>
                    <button type="button" onclick="loginManajemen()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">Masuk Portal</button>
                </form>
            </div>

            <!-- Portal Manajemen Content -->
            <div id="portalManajemen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Portal Manajemen Akun</h2>
                    <div class="flex items-center space-x-4">
                        <span id="welcomeManajemen" class="text-gray-600"></span>
                        <button onclick="logoutManajemen()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">Logout</button>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="showManajemenTab('mahasiswa')" class="tab-btn py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">Akun Mahasiswa</button>
                        <button onclick="showManajemenTab('prodi')" class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Akun Program Studi</button>
                        <button onclick="showManajemenTab('dosen')" class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Akun Dosen</button>
                    </nav>
                </div>

                <!-- Tab Mahasiswa -->
                <div id="tabMahasiswa" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üë®‚Äçüéì Tambah Akun Mahasiswa</h3>
                        <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                                <input type="text" id="newNim" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newNamaMhs" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama lengkap">
                            </div>
                            <div class="md:col-span-2">
                                <button type="button" onclick="tambahMahasiswa()" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Tambah Mahasiswa</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Daftar Akun Mahasiswa</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="mahasiswaTable" class="divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab Program Studi -->
                <div id="tabProdi" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üè´ Tambah Akun Program Studi</h3>
                        <form class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="newUsernameProdi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="newPasswordProdi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newNamaProdi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama lengkap">
                            </div>
                            <div class="md:col-span-3">
                                <button type="button" onclick="tambahProdi()" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Tambah Akun Program Studi</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Daftar Akun Program Studi</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Username</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="prodiTable" class="divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab Dosen -->
                <div id="tabDosen" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üë®‚Äçüè´ Tambah Akun Dosen</h3>
                        <form class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="newUsernameDosen" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="newPasswordDosen" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newNamaDosen" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama lengkap">
                            </div>
                            <div class="md:col-span-3">
                                <button type="button" onclick="tambahDosen()" class="bg-purple-600 text-white py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors">Tambah Akun Dosen</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Daftar Akun Dosen</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Username</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="dosenTable" class="divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Print Area for Kartu Bimbingan -->
    <div id="printArea" class="print-area hidden">
        <div class="p-8">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold">KARTU BIMBINGAN SKRIPSI</h1>
                <h2 class="text-lg">STAI AL-MAS'UDIYAH SUKABUMI</h2>
            </div>
            <div id="printContent"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-16">
        <div class="container mx-auto px-4 py-8">
            <div class="text-center">
                <h3 class="text-lg font-semibold mb-4">Sekretariat STAI Al-Mas'udiyah</h3>
                <p class="text-gray-300 mb-2">Jl. Sukabumi - Sagaranten Km. 26 Kp. Buni Ayu</p>
                <p class="text-gray-300 mb-2">Desa Kertaangsana Kec. Nyalindung Kab. Sukabumi 43196</p>
                <p class="text-gray-300 mb-4">Web: <a href="https://staimas.ac.id" class="text-blue-400 hover:text-blue-300">staimas.ac.id</a></p>
                <div class="border-t border-gray-700 pt-4">
                    <p class="text-sm text-gray-400">Copyright ¬© Lembaga Penjaminan Mutu (LPM) Tahun 2025</p>
                </div>
            </div>
            </div>
        </div>
    </footer>

    <script>
        // Firebase data management
        let currentMahasiswa = null;
        
        // Load all data from Firebase
        async function loadData() {
            try {
                // Load accounts
                await loadAccounts();
                
                // Load submissions
                await loadSubmissions();
                
                // Load notifications
                await loadNotifications();
                
                // Update dashboard statistics
                updateDashboardStats();
                
                // Update all tables and displays
                updateAllDisplays();
                
                console.log('Data loaded successfully from Firebase');
            } catch (error) {
                console.log('Firebase connection error, using local storage fallback');
                loadLocalData();
            }
        }

        // Load accounts from Firebase
        async function loadAccounts() {
            // Load mahasiswa accounts
            const mahasiswaSnapshot = await getDocs(collection(db, 'accounts_mahasiswa'));
            accounts.mahasiswa = [];
            mahasiswaSnapshot.forEach(doc => {
                accounts.mahasiswa.push({ id: doc.id, ...doc.data() });
            });

            // Load prodi accounts
            const prodiSnapshot = await getDocs(collection(db, 'accounts_prodi'));
            accounts.prodi = [];
            prodiSnapshot.forEach(doc => {
                accounts.prodi.push({ id: doc.id, ...doc.data() });
            });

            // Load dosen accounts
            const dosenSnapshot = await getDocs(collection(db, 'accounts_dosen'));
            accounts.dosen = [];
            dosenSnapshot.forEach(doc => {
                accounts.dosen.push({ id: doc.id, ...doc.data() });
            });
        }

        // Load submissions from Firebase
        async function loadSubmissions() {
            // Load pengajuan judul
            const judulSnapshot = await getDocs(collection(db, 'pengajuan_judul'));
            submissions.judulSkripsi = [];
            judulSnapshot.forEach(doc => {
                submissions.judulSkripsi.push({ id: doc.id, ...doc.data() });
            });

            // Load pengajuan seminar
            const seminarSnapshot = await getDocs(collection(db, 'pengajuan_seminar'));
            submissions.pengajuanSeminar = [];
            seminarSnapshot.forEach(doc => {
                submissions.pengajuanSeminar.push({ id: doc.id, ...doc.data() });
            });

            // Load bimbingan data
            const bimbinganSnapshot = await getDocs(query(collection(db, 'bimbingan'), orderBy('timestamp', 'desc')));
            submissions.bimbingan = [];
            bimbinganSnapshot.forEach(doc => {
                submissions.bimbingan.push({ id: doc.id, ...doc.data() });
            });

            // Load jadwal seminar
            const jadwalSnapshot = await getDocs(collection(db, 'jadwal_seminar'));
            submissions.jadwalSeminar = [];
            jadwalSnapshot.forEach(doc => {
                submissions.jadwalSeminar.push({ id: doc.id, ...doc.data() });
            });

            // Load munaqosyah
            const munaqosyahSnapshot = await getDocs(collection(db, 'pengajuan_munaqosyah'));
            submissions.munaqosyah = [];
            munaqosyahSnapshot.forEach(doc => {
                submissions.munaqosyah.push({ id: doc.id, ...doc.data() });
            });
        }

        // Load notifications from Firebase
        async function loadNotifications() {
            const notifikasiSnapshot = await getDocs(collection(db, 'notifikasi'));
            submissions.notifikasi = { mahasiswa: {}, dosen: {}, prodi: [] };
            
            notifikasiSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.nim) {
                    if (!submissions.notifikasi.mahasiswa[data.nim]) {
                        submissions.notifikasi.mahasiswa[data.nim] = [];
                    }
                    submissions.notifikasi.mahasiswa[data.nim].push({ id: doc.id, ...data });
                }
                if (data.dosen) {
                    if (!submissions.notifikasi.dosen[data.dosen]) {
                        submissions.notifikasi.dosen[data.dosen] = [];
                    }
                    submissions.notifikasi.dosen[data.dosen].push({ id: doc.id, ...data });
                }
                if (data.type === 'prodi') {
                    submissions.notifikasi.prodi.push({ id: doc.id, ...data });
                }
            });
        }

        // Load data from localStorage as fallback
        function loadLocalData() {
            const savedAccounts = localStorage.getItem('skripsi_accounts');
            const savedSubmissions = localStorage.getItem('skripsi_submissions');
            
            if (savedAccounts) {
                accounts = JSON.parse(savedAccounts);
            }
            if (savedSubmissions) {
                submissions = JSON.parse(savedSubmissions);
            }
            
            updateDashboardStats();
            updateAllDisplays();
        }

        // Save data to localStorage
        function saveLocalData() {
            localStorage.setItem('skripsi_accounts', JSON.stringify(accounts));
            localStorage.setItem('skripsi_submissions', JSON.stringify(submissions));
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            dashboardStats.totalMahasiswa = accounts.mahasiswa.filter(m => m.status === 'aktif').length;
            dashboardStats.skripsiSelesai = submissions.munaqosyah.filter(m => m.status === 'Selesai').length;
            dashboardStats.dalamProses = submissions.judulSkripsi.filter(j => j.status === 'Disetujui').length;
            
            // Update dashboard display
            const totalMahasiswaEl = document.querySelector('.text-2xl.font-bold.text-blue-600');
            const skripsiSelesaiEl = document.querySelector('.text-2xl.font-bold.text-green-600');
            const dalamProsesEl = document.querySelector('.text-2xl.font-bold.text-yellow-600');
            
            if (totalMahasiswaEl) totalMahasiswaEl.textContent = dashboardStats.totalMahasiswa;
            if (skripsiSelesaiEl) skripsiSelesaiEl.textContent = dashboardStats.skripsiSelesai;
            if (dalamProsesEl) dalamProsesEl.textContent = dashboardStats.dalamProses;
        }

        // Update all displays
        function updateAllDisplays() {
            updateMahasiswaTable();
            updateProdiTable();
            updateDosenTable();
            updateJudulValidasiTable();
            updateRekapJadwalSeminar();
            updateRekapPengajuanSeminar();
            updateDropdownOptions();
            updateRiwayatBimbingan();
            updatePersetujuanDosenTable();
        }
        
        function updateJudulTable(snapshot) {
            const tbody = document.getElementById('judulTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${data.nim}</td>
                    <td class="px-4 py-3 text-sm">${data.nama}</td>
                    <td class="px-4 py-3 text-sm">${data.judul}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${data.status || 'Menunggu'}</span></td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="validasiJudul('terima', '${doc.id}')" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">Terima</button>
                            <button onclick="validasiJudul('perbaiki', '${doc.id}')" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Perbaiki</button>
                            <button onclick="validasiJudul('tolak', '${doc.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Tolak</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateRiwayatBimbingan(snapshot) {
            const container = document.getElementById('riwayatBimbingan');
            if (!container) return;
            
            container.innerHTML = '';
            
            // If snapshot is provided (from Firebase), use it
            if (snapshot) {
                let count = 1;
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'p-3 border border-gray-200 rounded-lg';
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="font-medium text-sm">Bimbingan #${count}</span>
                            <span class="text-xs text-gray-500">${data.tanggal}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">${data.materi}</p>
                        <p class="text-xs text-gray-500">${data.catatan}</p>
                    `;
                    container.appendChild(div);
                    count++;
                });
            } else {
                // Use local submissions data
                if (submissions.bimbingan.length > 0) {
                    submissions.bimbingan.forEach((bimbingan, index) => {
                        const div = document.createElement('div');
                        div.className = 'p-3 border border-gray-200 rounded-lg';
                        div.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <span class="font-medium text-sm">Bimbingan #${index + 1}</span>
                                <span class="text-xs text-gray-500">${bimbingan.tanggal}</span>
                            </div>
                            <p class="text-sm text-gray-600 mb-1">${bimbingan.materi}</p>
                            <p class="text-xs text-gray-500">${bimbingan.catatan}</p>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">Belum ada riwayat bimbingan</p>';
                }
            }
        }
        
        // Print functionality with PDF support
        function printKartuBimbingan() {
            // Prevent default behavior
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            // Get the selected mahasiswa from the form
            const mahasiswaSelect = document.querySelector('#portalDosen form select');
            const mahasiswa = mahasiswaSelect ? mahasiswaSelect.value : 'Ahmad Fauzi (2021001)';
            
            // Get riwayat bimbingan content
            const riwayatContainer = document.getElementById('riwayatBimbingan');
            let riwayatContent = '';
            
            if (riwayatContainer && riwayatContainer.children.length > 0) {
                // Convert riwayat to print-friendly format
                Array.from(riwayatContainer.children).forEach((item, index) => {
                    const bimbinganNum = index + 1;
                    const tanggal = item.querySelector('.text-xs.text-gray-500')?.textContent || '';
                    const materi = item.querySelector('.text-sm.text-gray-600')?.textContent || '';
                    const catatan = item.querySelectorAll('.text-xs.text-gray-500')[1]?.textContent || '';
                    
                    riwayatContent += `
                        <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #d1d5db; page-break-inside: avoid;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold;">
                                <span>Bimbingan #${bimbinganNum}</span>
                                <span>${tanggal}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Materi:</strong> ${materi}
                            </div>
                            <div>
                                <strong>Catatan:</strong> ${catatan}
                            </div>
                        </div>
                    `;
                });
            } else {
                riwayatContent = `
                    <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #d1d5db; page-break-inside: avoid;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold;">
                            <span>Bimbingan #1</span>
                            <span>15 Jan 2025</span>
                        </div>
                        <div style="margin-bottom: 8px;">
                            <strong>Materi:</strong> Pembahasan BAB I - Pendahuluan
                        </div>
                        <div>
                            <strong>Catatan:</strong> Perbaiki latar belakang masalah
                        </div>
                    </div>
                `;
            }
            
            // Get current dosen name
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            const dosenNama = dosen ? dosen.nama : 'Dr. H. Abdullah, M.Pd.I';
            
            // Create print window with proper PDF styling
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Kartu Bimbingan Skripsi - ${mahasiswa}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 2cm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Times New Roman', serif;
                            font-size: 12pt;
                            line-height: 1.5;
                            color: #000;
                            background: white;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #000;
                            padding-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 18pt;
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        
                        .header h2 {
                            font-size: 14pt;
                            font-weight: normal;
                        }
                        
                        .info-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        
                        .info-table td {
                            border: 1px solid #000;
                            padding: 8px 12px;
                            vertical-align: top;
                        }
                        
                        .info-table .label {
                            background-color: #f5f5f5;
                            font-weight: bold;
                            width: 30%;
                        }
                        
                        .section-title {
                            font-size: 14pt;
                            font-weight: bold;
                            margin: 30px 0 20px 0;
                            border-bottom: 1px solid #000;
                            padding-bottom: 5px;
                        }
                        
                        .bimbingan-item {
                            margin-bottom: 16px;
                            padding: 12px;
                            border: 1px solid #ccc;
                            page-break-inside: avoid;
                        }
                        
                        .bimbingan-header {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                            font-weight: bold;
                        }
                        
                        .bimbingan-content {
                            margin-bottom: 8px;
                        }
                        
                        .signatures {
                            margin-top: 50px;
                            display: flex;
                            justify-content: space-between;
                        }
                        
                        .signature-box {
                            text-align: center;
                            width: 45%;
                        }
                        
                        .signature-line {
                            border-top: 1px solid #000;
                            margin-top: 80px;
                            padding-top: 5px;
                        }
                        
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 10pt;
                            color: #666;
                        }
                        
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            
                            .page-break {
                                page-break-before: always;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>KARTU BIMBINGAN SKRIPSI</h1>
                        <h2>STAI AL-MAS'UDIYAH SUKABUMI</h2>
                    </div>
                    
                    <table class="info-table">
                        <tr>
                            <td class="label">Nama Mahasiswa</td>
                            <td>${mahasiswa}</td>
                        </tr>
                        <tr>
                            <td class="label">Program Studi</td>
                            <td>Pendidikan Agama Islam</td>
                        </tr>
                        <tr>
                            <td class="label">Tahun Akademik</td>
                            <td>2024/2025</td>
                        </tr>
                        <tr>
                            <td class="label">Dosen Pembimbing</td>
                            <td>${dosenNama}</td>
                        </tr>
                    </table>
                    
                    <div class="section-title">RIWAYAT BIMBINGAN SKRIPSI</div>
                    
                    <div class="bimbingan-list">
                        ${riwayatContent}
                    </div>
                    
                    <div class="signatures">
                        <div class="signature-box">
                            <p>Mengetahui,</p>
                            <p style="margin-top: 10px;">Ketua Program Studi</p>
                            <div class="signature-line">
                                <p style="font-weight: bold;">Dr. H. Ahmad Syukri, M.Pd.I</p>
                                <p style="font-size: 10pt;">NIDN. 2108067801</p>
                            </div>
                        </div>
                        <div class="signature-box">
                            <p>Sukabumi, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                            <p style="margin-top: 10px;">Dosen Pembimbing</p>
                            <div class="signature-line">
                                <p style="font-weight: bold;">${dosenNama}</p>
                                <p style="font-size: 10pt;">NIDN. 2108067802</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
                        <p>Sistem Manajemen Skripsi - STAI Al-Mas'udiyah Sukabumi</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    
                    // Don't auto-close, let user close manually after printing/saving PDF
                    // This prevents the popup from closing automatically
                }, 500);
            };
        }

        // Data storage for accounts - loaded from Firebase
        let accounts = {
            mahasiswa: [],
            prodi: [],
            dosen: []
        };

        // Data storage for submissions and guidance - loaded from Firebase
        let submissions = {
            judulSkripsi: [],
            pengajuanSeminar: [],
            bimbingan: [],
            jadwalSeminar: [],
            munaqosyah: [],
            notifikasi: {
                mahasiswa: {},
                dosen: {},
                prodi: []
            }
        };

        // Dashboard statistics
        let dashboardStats = {
            totalMahasiswa: 0,
            skripsiSelesai: 0,
            dalamProses: 0
        };

        // Login functionality
        function loginMahasiswa() {
            const nim = document.getElementById('nimLogin').value;
            
            if (!nim) {
                alert('Mohon masukkan NIM Anda!');
                return;
            }
            
            // Check if NIM exists and is active
            const mahasiswa = accounts.mahasiswa.find(m => m.nim === nim && m.status === 'aktif');
            if (!mahasiswa) {
                alert('NIM tidak ditemukan atau akun tidak aktif!');
                return;
            }
            
            // Hide login form and show portal
            document.getElementById('loginMahasiswa').classList.add('hidden');
            document.getElementById('portalMahasiswa').classList.remove('hidden');
            document.getElementById('welcomeMahasiswa').textContent = `Selamat datang, ${mahasiswa.nama}`;
            
            // Store login status
            sessionStorage.setItem('mahasiswaLogin', nim);
            
            // Update notifications and rekapitulasi
            updateMahasiswaNotifications();
            updateRekapPengajuanSeminar();
        }
        
        function logoutMahasiswa() {
            document.getElementById('loginMahasiswa').classList.remove('hidden');
            document.getElementById('portalMahasiswa').classList.add('hidden');
            document.getElementById('nimLogin').value = '';
            sessionStorage.removeItem('mahasiswaLogin');
        }
        
        function loginProdi() {
            const username = document.getElementById('usernameProdi').value;
            const password = document.getElementById('passwordProdi').value;
            
            if (!username || !password) {
                alert('Mohon masukkan username dan password!');
                return;
            }
            
            // Check credentials
            const prodi = accounts.prodi.find(p => p.username === username && p.password === password && p.status === 'aktif');
            if (prodi) {
                document.getElementById('loginProdi').classList.add('hidden');
                document.getElementById('portalProdi').classList.remove('hidden');
                document.getElementById('welcomeProdi').textContent = `Selamat datang, ${prodi.nama}`;
                sessionStorage.setItem('prodiLogin', username);
                
                // Update tables and notifications
                updateJudulValidasiTable();
                updateRekapJadwalSeminar();
                updateProdiNotifications();
                updateRekapPengajuanSeminar();
            } else {
                alert('Username atau password salah atau akun tidak aktif!');
            }
        }
        
        function logoutProdi() {
            document.getElementById('loginProdi').classList.remove('hidden');
            document.getElementById('portalProdi').classList.add('hidden');
            document.getElementById('usernameProdi').value = '';
            document.getElementById('passwordProdi').value = '';
            sessionStorage.removeItem('prodiLogin');
        }
        
        function loginDosen() {
            const username = document.getElementById('usernameDosen').value;
            const password = document.getElementById('passwordDosen').value;
            
            if (!username || !password) {
                alert('Mohon masukkan username dan password!');
                return;
            }
            
            // Check credentials
            const dosen = accounts.dosen.find(d => d.username === username && d.password === password && d.status === 'aktif');
            if (dosen) {
                document.getElementById('loginDosen').classList.add('hidden');
                document.getElementById('portalDosen').classList.remove('hidden');
                document.getElementById('welcomeDosen').textContent = `Selamat datang, ${dosen.nama}`;
                sessionStorage.setItem('dosenLogin', username);
                
                // Update notifications and tables
                updateDosenNotifications();
                updatePersetujuanDosenTable();
                updateDropdownOptions();
            } else {
                alert('Username atau password salah atau akun tidak aktif!');
            }
        }
        
        function logoutDosen() {
            document.getElementById('loginDosen').classList.remove('hidden');
            document.getElementById('portalDosen').classList.add('hidden');
            document.getElementById('usernameDosen').value = '';
            document.getElementById('passwordDosen').value = '';
            sessionStorage.removeItem('dosenLogin');
        }

        // Manajemen login functions
        function loginManajemen() {
            const username = document.getElementById('usernameManajemen').value;
            const password = document.getElementById('passwordManajemen').value;
            
            if (!username || !password) {
                alert('Mohon masukkan username dan password!');
                return;
            }
            
            // Demo admin credentials
            if (username === 'admin' && password === 'admin123') {
                document.getElementById('loginManajemen').classList.add('hidden');
                document.getElementById('portalManajemen').classList.remove('hidden');
                document.getElementById('welcomeManajemen').textContent = `Selamat datang, Administrator`;
                sessionStorage.setItem('manajemenLogin', username);
                showManajemenTab('mahasiswa');
            } else {
                alert('Username atau password salah! (Demo: admin/admin123)');
            }
        }
        
        function logoutManajemen() {
            document.getElementById('loginManajemen').classList.remove('hidden');
            document.getElementById('portalManajemen').classList.add('hidden');
            document.getElementById('usernameManajemen').value = '';
            document.getElementById('passwordManajemen').value = '';
            sessionStorage.removeItem('manajemenLogin');
        }

        // Tab management for manajemen
        function showManajemenTab(tabName) {
            // Prevent default behavior if called from event
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.add('hidden'));
            
            // Show selected tab
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
            
            // Update tab buttons safely
            if (event && event.target) {
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                event.target.classList.remove('border-transparent', 'text-gray-500');
                event.target.classList.add('border-blue-500', 'text-blue-600');
            }
        }

        // Account management functions
        async function tambahMahasiswa() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const nim = document.getElementById('newNim').value;
            const nama = document.getElementById('newNamaMhs').value;
            
            if (!nim || !nama) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Check if NIM already exists
            if (accounts.mahasiswa.find(m => m.nim === nim)) {
                alert('NIM sudah terdaftar!');
                return;
            }
            
            const newMahasiswa = { nim, nama, status: 'aktif', createdAt: new Date() };
            
            try {
                // Save to Firebase
                const docRef = await addDoc(collection(db, 'accounts_mahasiswa'), newMahasiswa);
                
                // Add to local array with Firebase ID
                accounts.mahasiswa.push({ id: docRef.id, ...newMahasiswa });
                
                alert('Akun mahasiswa berhasil ditambahkan!');
            } catch (error) {
                console.log('Firebase error, saving locally');
                accounts.mahasiswa.push(newMahasiswa);
                saveLocalData();
                alert('Akun mahasiswa berhasil ditambahkan!');
            }
            
            // Update displays
            updateMahasiswaTable();
            updateDropdownOptions();
            updateDashboardStats();
            
            // Clear form
            document.getElementById('newNim').value = '';
            document.getElementById('newNamaMhs').value = '';
        }

        async function tambahProdi() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const username = document.getElementById('newUsernameProdi').value;
            const password = document.getElementById('newPasswordProdi').value;
            const nama = document.getElementById('newNamaProdi').value;
            
            if (!username || !password || !nama) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Check if username already exists
            if (accounts.prodi.find(p => p.username === username)) {
                alert('Username sudah terdaftar!');
                return;
            }
            
            const newProdi = { username, password, nama, status: 'aktif', createdAt: new Date() };
            
            try {
                // Save to Firebase
                const docRef = await addDoc(collection(db, 'accounts_prodi'), newProdi);
                
                // Add to local array with Firebase ID
                accounts.prodi.push({ id: docRef.id, ...newProdi });
                
                alert('Akun program studi berhasil ditambahkan!');
            } catch (error) {
                console.log('Firebase error, saving locally');
                accounts.prodi.push(newProdi);
                saveLocalData();
                alert('Akun program studi berhasil ditambahkan!');
            }
            
            // Update table
            updateProdiTable();
            
            // Clear form
            document.getElementById('newUsernameProdi').value = '';
            document.getElementById('newPasswordProdi').value = '';
            document.getElementById('newNamaProdi').value = '';
        }

        async function tambahDosen() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const username = document.getElementById('newUsernameDosen').value;
            const password = document.getElementById('newPasswordDosen').value;
            const nama = document.getElementById('newNamaDosen').value;
            
            if (!username || !password || !nama) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Check if username already exists
            if (accounts.dosen.find(d => d.username === username)) {
                alert('Username sudah terdaftar!');
                return;
            }
            
            const newDosen = { username, password, nama, status: 'aktif', createdAt: new Date() };
            
            try {
                // Save to Firebase
                const docRef = await addDoc(collection(db, 'accounts_dosen'), newDosen);
                
                // Add to local array with Firebase ID
                accounts.dosen.push({ id: docRef.id, ...newDosen });
                
                alert('Akun dosen berhasil ditambahkan!');
            } catch (error) {
                console.log('Firebase error, saving locally');
                accounts.dosen.push(newDosen);
                saveLocalData();
                alert('Akun dosen berhasil ditambahkan!');
            }
            
            // Update displays
            updateDosenTable();
            updateDropdownOptions();
            
            // Clear form
            document.getElementById('newUsernameDosen').value = '';
            document.getElementById('newPasswordDosen').value = '';
            document.getElementById('newNamaDosen').value = '';
        }

        // Update table functions
        function updateMahasiswaTable() {
            const tbody = document.getElementById('mahasiswaTable');
            tbody.innerHTML = '';
            
            accounts.mahasiswa.forEach(mhs => {
                const row = document.createElement('tr');
                const statusClass = mhs.status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const toggleText = mhs.status === 'aktif' ? 'Nonaktifkan' : 'Aktifkan';
                const toggleClass = mhs.status === 'aktif' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${mhs.nim}</td>
                    <td class="px-4 py-3 text-sm">${mhs.nama}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${mhs.status.charAt(0).toUpperCase() + mhs.status.slice(1)}</span></td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editMahasiswa('${mhs.nim}')" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Edit</button>
                            <button onclick="toggleStatusMahasiswa('${mhs.nim}', '${mhs.status}')" class="px-3 py-1 ${toggleClass} text-white rounded text-xs">${toggleText}</button>
                            <button onclick="hapusMahasiswa('${mhs.nim}')" class="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">Hapus</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateProdiTable() {
            const tbody = document.getElementById('prodiTable');
            tbody.innerHTML = '';
            
            accounts.prodi.forEach(prodi => {
                const row = document.createElement('tr');
                const statusClass = prodi.status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const toggleText = prodi.status === 'aktif' ? 'Nonaktifkan' : 'Aktifkan';
                const toggleClass = prodi.status === 'aktif' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${prodi.username}</td>
                    <td class="px-4 py-3 text-sm">${prodi.nama}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${prodi.status.charAt(0).toUpperCase() + prodi.status.slice(1)}</span></td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editProdi('${prodi.username}')" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Edit</button>
                            <button onclick="toggleStatusProdi('${prodi.username}', '${prodi.status}')" class="px-3 py-1 ${toggleClass} text-white rounded text-xs">${toggleText}</button>
                            <button onclick="hapusProdi('${prodi.username}')" class="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">Hapus</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDosenTable() {
            const tbody = document.getElementById('dosenTable');
            tbody.innerHTML = '';
            
            accounts.dosen.forEach(dosen => {
                const row = document.createElement('tr');
                const statusClass = dosen.status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const toggleText = dosen.status === 'aktif' ? 'Nonaktifkan' : 'Aktifkan';
                const toggleClass = dosen.status === 'aktif' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${dosen.username}</td>
                    <td class="px-4 py-3 text-sm">${dosen.nama}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${dosen.status.charAt(0).toUpperCase() + dosen.status.slice(1)}</span></td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editDosen('${dosen.username}')" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Edit</button>
                            <button onclick="toggleStatusDosen('${dosen.username}', '${dosen.status}')" class="px-3 py-1 ${toggleClass} text-white rounded text-xs">${toggleText}</button>
                            <button onclick="hapusDosen('${dosen.username}')" class="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">Hapus</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Action functions
        function editMahasiswa(nim) {
            const mahasiswa = accounts.mahasiswa.find(m => m.nim === nim);
            if (mahasiswa) {
                const newNama = prompt('Edit nama mahasiswa:', mahasiswa.nama);
                if (newNama && newNama !== mahasiswa.nama) {
                    mahasiswa.nama = newNama;
                    updateMahasiswaTable();
                    updateDropdownOptions();
                    alert('Data mahasiswa berhasil diupdate!');
                }
            }
        }

        function toggleStatusMahasiswa(nim, currentStatus) {
            const mahasiswa = accounts.mahasiswa.find(m => m.nim === nim);
            if (mahasiswa) {
                mahasiswa.status = currentStatus === 'aktif' ? 'nonaktif' : 'aktif';
                updateMahasiswaTable();
                updateDropdownOptions();
                alert(`Status mahasiswa berhasil diubah menjadi ${mahasiswa.status}!`);
            }
        }

        function hapusMahasiswa(nim) {
            if (confirm('Yakin ingin menghapus akun mahasiswa ini?')) {
                accounts.mahasiswa = accounts.mahasiswa.filter(m => m.nim !== nim);
                updateMahasiswaTable();
                updateDropdownOptions();
                alert('Akun mahasiswa berhasil dihapus!');
            }
        }

        function editProdi(username) {
            const prodi = accounts.prodi.find(p => p.username === username);
            if (prodi) {
                const newNama = prompt('Edit nama:', prodi.nama);
                const newPassword = prompt('Edit password:', prodi.password);
                if (newNama) prodi.nama = newNama;
                if (newPassword) prodi.password = newPassword;
                updateProdiTable();
                alert('Data program studi berhasil diupdate!');
            }
        }

        function toggleStatusProdi(username, currentStatus) {
            const prodi = accounts.prodi.find(p => p.username === username);
            if (prodi) {
                prodi.status = currentStatus === 'aktif' ? 'nonaktif' : 'aktif';
                updateProdiTable();
                alert(`Status akun berhasil diubah menjadi ${prodi.status}!`);
            }
        }

        function hapusProdi(username) {
            if (confirm('Yakin ingin menghapus akun program studi ini?')) {
                accounts.prodi = accounts.prodi.filter(p => p.username !== username);
                updateProdiTable();
                alert('Akun program studi berhasil dihapus!');
            }
        }

        function editDosen(username) {
            const dosen = accounts.dosen.find(d => d.username === username);
            if (dosen) {
                const newNama = prompt('Edit nama:', dosen.nama);
                const newPassword = prompt('Edit password:', dosen.password);
                if (newNama) dosen.nama = newNama;
                if (newPassword) dosen.password = newPassword;
                updateDosenTable();
                updateDropdownOptions();
                alert('Data dosen berhasil diupdate!');
            }
        }

        function toggleStatusDosen(username, currentStatus) {
            const dosen = accounts.dosen.find(d => d.username === username);
            if (dosen) {
                dosen.status = currentStatus === 'aktif' ? 'nonaktif' : 'aktif';
                updateDosenTable();
                updateDropdownOptions();
                alert(`Status akun berhasil diubah menjadi ${dosen.status}!`);
            }
        }

        function hapusDosen(username) {
            if (confirm('Yakin ingin menghapus akun dosen ini?')) {
                accounts.dosen = accounts.dosen.filter(d => d.username !== username);
                updateDosenTable();
                updateDropdownOptions();
                alert('Akun dosen berhasil dihapus!');
            }
        }

        // Navigation functionality
        function showPage(pageId) {
            // Prevent default behavior if called from event
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            // Hide all pages
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(pageId).classList.remove('hidden');
            
            // Check login status when switching pages
            if (pageId === 'mahasiswa') {
                const mahasiswaLogin = sessionStorage.getItem('mahasiswaLogin');
                if (mahasiswaLogin) {
                    const mahasiswa = accounts.mahasiswa.find(m => m.nim === mahasiswaLogin);
                    if (mahasiswa) {
                        document.getElementById('loginMahasiswa').classList.add('hidden');
                        document.getElementById('portalMahasiswa').classList.remove('hidden');
                        document.getElementById('welcomeMahasiswa').textContent = `Selamat datang, ${mahasiswa.nama}`;
                        updateMahasiswaNotifications();
                    } else {
                        document.getElementById('loginMahasiswa').classList.remove('hidden');
                        document.getElementById('portalMahasiswa').classList.add('hidden');
                    }
                } else {
                    document.getElementById('loginMahasiswa').classList.remove('hidden');
                    document.getElementById('portalMahasiswa').classList.add('hidden');
                }
            } else if (pageId === 'prodi') {
                const prodiLogin = sessionStorage.getItem('prodiLogin');
                if (prodiLogin) {
                    const prodi = accounts.prodi.find(p => p.username === prodiLogin);
                    if (prodi) {
                        document.getElementById('loginProdi').classList.add('hidden');
                        document.getElementById('portalProdi').classList.remove('hidden');
                        document.getElementById('welcomeProdi').textContent = `Selamat datang, ${prodi.nama}`;
                        updateJudulValidasiTable();
                    } else {
                        document.getElementById('loginProdi').classList.remove('hidden');
                        document.getElementById('portalProdi').classList.add('hidden');
                    }
                } else {
                    document.getElementById('loginProdi').classList.remove('hidden');
                    document.getElementById('portalProdi').classList.add('hidden');
                }
            } else if (pageId === 'dosen') {
                const dosenLogin = sessionStorage.getItem('dosenLogin');
                if (dosenLogin) {
                    const dosen = accounts.dosen.find(d => d.username === dosenLogin);
                    if (dosen) {
                        document.getElementById('loginDosen').classList.add('hidden');
                        document.getElementById('portalDosen').classList.remove('hidden');
                        document.getElementById('welcomeDosen').textContent = `Selamat datang, ${dosen.nama}`;
                        updateDosenNotifications();
                        updatePersetujuanDosenTable();
                    } else {
                        document.getElementById('loginDosen').classList.remove('hidden');
                        document.getElementById('portalDosen').classList.add('hidden');
                    }
                } else {
                    document.getElementById('loginDosen').classList.remove('hidden');
                    document.getElementById('portalDosen').classList.add('hidden');
                }
            } else if (pageId === 'manajemen') {
                const manajemenLogin = sessionStorage.getItem('manajemenLogin');
                if (manajemenLogin) {
                    document.getElementById('loginManajemen').classList.add('hidden');
                    document.getElementById('portalManajemen').classList.remove('hidden');
                    document.getElementById('welcomeManajemen').textContent = `Selamat datang, Administrator`;
                    showManajemenTab('mahasiswa');
                } else {
                    document.getElementById('loginManajemen').classList.remove('hidden');
                    document.getElementById('portalManajemen').classList.add('hidden');
                }
            }
            
            // Update navigation buttons safely
            if (event && event.target) {
                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-600', 'hover:bg-blue-50');
                });
                
                event.target.classList.remove('text-gray-600', 'hover:bg-blue-50');
                event.target.classList.add('bg-blue-600', 'text-white');
            }
        }

        // Mahasiswa functions
        async function submitJudul() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const form = event ? event.target.closest('form') : document.querySelector('#portalMahasiswa form');
            const nim = form.querySelector('input[placeholder="Masukkan NIM"]').value;
            const nama = form.querySelector('input[placeholder="Masukkan nama lengkap"]').value;
            const judul = form.querySelector('textarea[placeholder="Masukkan judul skripsi yang diajukan"]').value;
            const latarBelakang = form.querySelector('textarea[placeholder="Jelaskan latar belakang penelitian"]').value;
            
            if (!nim || !nama || !judul) {
                alert('Mohon lengkapi semua field yang wajib diisi!');
                return;
            }
            
            // Add to local storage
            const newSubmission = {
                id: Date.now().toString(),
                nim: nim,
                nama: nama,
                judul: judul,
                latarBelakang: latarBelakang,
                status: 'Menunggu',
                tanggalPengajuan: new Date().toLocaleDateString('id-ID')
            };
            
            submissions.judulSkripsi.push(newSubmission);
            
            try {
                await addDoc(collection(db, 'pengajuan_judul'), {
                    nim: nim,
                    nama: nama,
                    judul: judul,
                    latarBelakang: latarBelakang,
                    status: 'Menunggu',
                    tanggalPengajuan: new Date().toISOString(),
                    timestamp: new Date()
                });
            } catch (error) {
                console.log('Demo mode - data saved locally');
            }
            
            alert('Judul skripsi berhasil diajukan! Menunggu validasi dari Program Studi.');
            form.reset();
            
            // Update status display
            const statusDiv = document.getElementById('statusPengajuan');
            statusDiv.innerHTML = `
                <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-yellow-800">Menunggu Validasi Prodi</p>
                            <p class="text-sm text-yellow-600">Diajukan: ${new Date().toLocaleDateString('id-ID')}</p>
                        </div>
                        <span class="px-3 py-1 bg-yellow-200 text-yellow-800 rounded-full text-sm">Pending</span>
                    </div>
                </div>
            `;
            
            // Update prodi table if prodi is logged in
            updateJudulValidasiTable();
        }

        async function submitSeminar() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const nim = document.getElementById('nimSeminar').value;
            const tanggal = document.getElementById('tanggalSeminar').value;
            const catatanProposal = document.getElementById('catatanProposal').value;
            
            if (!nim || !tanggal || !catatanProposal) {
                alert('Mohon lengkapi semua field yang wajib diisi!');
                return;
            }
            
            // Find mahasiswa name
            const mahasiswa = accounts.mahasiswa.find(m => m.nim === nim);
            if (!mahasiswa) {
                alert('NIM tidak ditemukan!');
                return;
            }
            
            // Create pengajuan seminar
            const pengajuanBaru = {
                id: Date.now().toString(),
                nim: nim,
                nama: mahasiswa.nama,
                tanggalPengajuan: tanggal,
                tanggalSubmit: new Date().toLocaleDateString('id-ID'),
                catatanProposal: catatanProposal,
                status: 'Menunggu Penjadwalan'
            };
            
            // Add to local storage
            submissions.pengajuanSeminar.push(pengajuanBaru);
            
            // Add notification for prodi
            submissions.notifikasi.prodi.push({
                id: Date.now().toString(),
                type: 'pengajuan_seminar',
                message: 'Pengajuan seminar proposal baru',
                nim: nim,
                nama: mahasiswa.nama,
                tanggal: new Date().toLocaleDateString('id-ID'),
                waktu: new Date().toLocaleTimeString('id-ID')
            });
            
            try {
                await addDoc(collection(db, 'pengajuan_seminar'), pengajuanBaru);
                
                alert('Pengajuan seminar proposal berhasil disubmit! Menunggu penjadwalan dari Program Studi.');
            } catch (error) {
                console.log('Demo mode - data saved locally');
                alert('Pengajuan seminar proposal berhasil disubmit! Menunggu penjadwalan dari Program Studi.');
            }
            
            // Clear form
            document.getElementById('nimSeminar').value = '';
            document.getElementById('tanggalSeminar').value = '';
            document.getElementById('catatanProposal').value = '';
            
            // Update rekapitulasi and notifications
            updateRekapPengajuanSeminar();
            updateProdiNotifications();
        }

        async function submitMunaqosyah() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const form = event ? event.target.closest('form') : document.querySelector('#portalMahasiswa form:last-of-type');
            const nim = form.querySelector('input[placeholder="Masukkan NIM"]').value;
            const jumlahBimbingan = form.querySelector('input[type="number"]').value;
            const catatanSkripsi = document.getElementById('catatanSkripsi').value;
            const catatanKartuBimbingan = document.getElementById('catatanKartuBimbingan').value;
            
            if (!nim || !jumlahBimbingan || jumlahBimbingan < 12) {
                alert('Mohon lengkapi semua field dan pastikan minimal 12 kali bimbingan!');
                return;
            }
            
            try {
                await addDoc(collection(db, 'pengajuan_munaqosyah'), {
                    nim: nim,
                    jumlahBimbingan: parseInt(jumlahBimbingan),
                    catatanSkripsi: catatanSkripsi,
                    catatanKartuBimbingan: catatanKartuBimbingan,
                    status: 'Menunggu Penjadwalan',
                    timestamp: new Date()
                });
                
                alert('Pengajuan sidang munaqosyah berhasil disubmit! Menunggu penjadwalan dari Program Studi.');
                form.reset();
            } catch (error) {
                console.log('Demo mode - data saved locally');
                alert('Pengajuan sidang munaqosyah berhasil disubmit! Menunggu penjadwalan dari Program Studi.');
            }
        }

        // Program Studi functions
        async function validasiJudul(status, docId) {
            // Prevent default behavior
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            let message = '';
            let statusText = '';
            let statusClass = '';
            let catatan = '';
            
            if (status === 'terima') {
                message = 'Judul skripsi disetujui!';
                statusText = 'Disetujui';
                statusClass = 'bg-green-100 text-green-800';
            } else if (status === 'perbaiki') {
                catatan = prompt('Masukkan catatan perbaikan untuk mahasiswa:');
                if (!catatan) return;
                message = 'Judul perlu diperbaiki. Catatan telah dikirim ke mahasiswa.';
                statusText = 'Perlu Perbaikan';
                statusClass = 'bg-yellow-100 text-yellow-800';
            } else {
                catatan = prompt('Masukkan alasan penolakan:');
                if (!catatan) return;
                message = 'Judul ditolak. Alasan telah dikirim ke mahasiswa.';
                statusText = 'Ditolak';
                statusClass = 'bg-red-100 text-red-800';
            }
            
            // Get mahasiswa info from table row
            const row = event ? event.target.closest('tr') : null;
            if (!row) return;
            
            const nim = row.querySelector('td:nth-child(2)').textContent;
            const nama = row.querySelector('td:nth-child(3)').textContent;
            
            // Update local storage
            const submission = submissions.judulSkripsi.find(s => s.id === docId || s.nim === nim);
            if (submission) {
                submission.status = statusText;
                submission.tanggalValidasi = new Date().toLocaleDateString('id-ID');
                submission.validator = 'Program Studi';
                submission.catatan = catatan;
            }
            
            // Add notification for mahasiswa
            if (!submissions.notifikasi.mahasiswa[nim]) {
                submissions.notifikasi.mahasiswa[nim] = [];
            }
            submissions.notifikasi.mahasiswa[nim].push({
                id: Date.now().toString(),
                type: 'validasi_judul',
                status: statusText,
                message: `Judul skripsi Anda ${statusText.toLowerCase()}`,
                catatan: catatan,
                tanggal: new Date().toLocaleDateString('id-ID'),
                waktu: new Date().toLocaleTimeString('id-ID')
            });
            
            try {
                // Save to Firebase
                await updateDoc(doc(db, 'pengajuan_judul', docId), {
                    status: statusText,
                    tanggalValidasi: new Date().toISOString(),
                    validator: 'Program Studi',
                    catatan: catatan
                });
                
                // Save notification to Firebase
                await addDoc(collection(db, 'notifikasi'), {
                    nim: nim,
                    nama: nama,
                    type: 'validasi_judul',
                    status: statusText,
                    message: `Judul skripsi Anda ${statusText.toLowerCase()}`,
                    catatan: catatan,
                    timestamp: new Date()
                });
            } catch (error) {
                console.log('Demo mode - validation saved locally');
            }
            
            alert(message);
            
            // Update table status
            const statusCell = row.querySelector('td:nth-child(4)');
            statusCell.innerHTML = `<span class="px-2 py-1 ${statusClass} rounded-full text-xs">${statusText}</span>`;
            
            // Update action buttons
            const actionCell = row.querySelector('td:nth-child(5)');
            actionCell.innerHTML = `<span class="text-gray-500 text-xs">Sudah divalidasi</span>`;
            
            // Update mahasiswa notifications if logged in
            updateMahasiswaNotifications();
        }

        // Checkbox functions
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.judul-checkbox');
            
            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = selectAll.checked;
                }
            });
        }
        
        function validasiMassal(status) {
            const checkboxes = document.querySelectorAll('.judul-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Pilih minimal satu pengajuan untuk divalidasi!');
                return;
            }
            
            let catatan = '';
            if (status === 'tolak') {
                catatan = prompt('Masukkan alasan penolakan untuk semua pengajuan yang dipilih:');
                if (!catatan) return;
            }
            
            const selectedData = [];
            checkboxes.forEach(checkbox => {
                const nim = checkbox.getAttribute('data-nim');
                const nama = checkbox.getAttribute('data-nama');
                selectedData.push({ nim, nama });
            });
            
            // Process validation
            selectedData.forEach(data => {
                // Update local storage
                const submission = submissions.judulSkripsi.find(s => s.nim === data.nim);
                if (submission) {
                    submission.status = status === 'terima' ? 'Disetujui' : 'Ditolak';
                    submission.tanggalValidasi = new Date().toLocaleDateString('id-ID');
                    submission.validator = 'Program Studi';
                    submission.catatan = catatan;
                }
                
                // Add notification for mahasiswa
                if (!submissions.notifikasi.mahasiswa[data.nim]) {
                    submissions.notifikasi.mahasiswa[data.nim] = [];
                }
                submissions.notifikasi.mahasiswa[data.nim].push({
                    id: Date.now().toString() + data.nim,
                    type: 'validasi_judul',
                    status: status === 'terima' ? 'Disetujui' : 'Ditolak',
                    message: `Judul skripsi Anda ${status === 'terima' ? 'disetujui' : 'ditolak'}`,
                    catatan: catatan,
                    tanggal: new Date().toLocaleDateString('id-ID'),
                    waktu: new Date().toLocaleTimeString('id-ID')
                });
            });
            
            const statusText = status === 'terima' ? 'disetujui' : 'ditolak';
            alert(`${selectedData.length} pengajuan berhasil ${statusText}!`);
            
            // Update table
            updateJudulValidasiTable();
            updateMahasiswaNotifications();
            
            // Uncheck select all
            document.getElementById('selectAll').checked = false;
        }

        function updateJudulValidasiTable() {
            const tbody = document.getElementById('judulTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (submissions.judulSkripsi.length > 0) {
                submissions.judulSkripsi.forEach(submission => {
                    const row = document.createElement('tr');
                    let statusClass = 'bg-yellow-100 text-yellow-800';
                    if (submission.status === 'Disetujui') statusClass = 'bg-green-100 text-green-800';
                    else if (submission.status === 'Ditolak') statusClass = 'bg-red-100 text-red-800';
                    else if (submission.status === 'Perlu Perbaikan') statusClass = 'bg-yellow-100 text-yellow-800';
                    
                    const isDisabled = submission.status !== 'Menunggu';
                    const checkboxHtml = isDisabled ? 
                        `<input type="checkbox" class="judul-checkbox" disabled>` :
                        `<input type="checkbox" class="judul-checkbox" data-nim="${submission.nim}" data-nama="${submission.nama}" data-id="${submission.id}">`;
                    
                    row.innerHTML = `
                        <td class="px-4 py-3">${checkboxHtml}</td>
                        <td class="px-4 py-3 text-sm">${submission.nim}</td>
                        <td class="px-4 py-3 text-sm">${submission.nama}</td>
                        <td class="px-4 py-3 text-sm">${submission.judul}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${submission.status}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Belum ada pengajuan judul skripsi</td></tr>';
            }
        }

        async function buatJadwalSeminar() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const form = event ? event.target.closest('form') : document.querySelector('#portalProdi form');
            const mahasiswa = form.querySelector('select').value;
            const tanggal = form.querySelector('input[type="datetime-local"]').value;
            const ruangan = form.querySelector('input[placeholder="Ruang 101"]').value;
            const penguji1 = form.querySelectorAll('select')[1].value;
            const penguji2 = form.querySelectorAll('select')[2].value;
            
            if (!mahasiswa || !tanggal || !ruangan || !penguji1 || !penguji2) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Extract NIM from mahasiswa string (format: "Nama (NIM)")
            const nimMatch = mahasiswa.match(/\((\d+)\)/);
            const nim = nimMatch ? nimMatch[1] : '';
            const nama = mahasiswa.split(' (')[0];
            
            // Create jadwal object
            const jadwalBaru = {
                id: Date.now().toString(),
                mahasiswa: mahasiswa,
                nim: nim,
                nama: nama,
                tanggal: tanggal,
                ruangan: ruangan,
                penguji1: penguji1,
                penguji2: penguji2,
                status: 'Terjadwal',
                tanggalBuat: new Date().toLocaleDateString('id-ID')
            };
            
            // Add to local storage
            submissions.jadwalSeminar.push(jadwalBaru);
            
            // Add notification for mahasiswa
            if (!submissions.notifikasi.mahasiswa[nim]) {
                submissions.notifikasi.mahasiswa[nim] = [];
            }
            submissions.notifikasi.mahasiswa[nim].push({
                id: Date.now().toString(),
                type: 'jadwal_seminar',
                message: 'Jadwal seminar proposal Anda telah ditetapkan',
                tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                waktu: new Date(tanggal).toLocaleTimeString('id-ID'),
                ruangan: ruangan,
                penguji1: penguji1,
                penguji2: penguji2,
                tanggalNotif: new Date().toLocaleDateString('id-ID')
            });
            
            // Add notification for dosen
            [penguji1, penguji2].forEach(dosen => {
                if (!submissions.notifikasi.dosen[dosen]) {
                    submissions.notifikasi.dosen[dosen] = [];
                }
                submissions.notifikasi.dosen[dosen].push({
                    id: Date.now().toString(),
                    type: 'jadwal_seminar',
                    message: `Anda ditugaskan sebagai penguji seminar proposal`,
                    mahasiswa: nama,
                    nim: nim,
                    tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                    waktu: new Date(tanggal).toLocaleTimeString('id-ID'),
                    ruangan: ruangan,
                    tanggalNotif: new Date().toLocaleDateString('id-ID')
                });
            });
            
            try {
                // Save to Firebase
                await addDoc(collection(db, 'jadwal_seminar'), jadwalBaru);
                
                // Save notifications to Firebase
                await addDoc(collection(db, 'notifikasi'), {
                    nim: nim,
                    nama: nama,
                    type: 'jadwal_seminar',
                    message: 'Jadwal seminar proposal Anda telah ditetapkan',
                    tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                    waktu: new Date(tanggal).toLocaleTimeString('id-ID'),
                    ruangan: ruangan,
                    penguji1: penguji1,
                    penguji2: penguji2,
                    timestamp: new Date()
                });
            } catch (error) {
                console.log('Demo mode - jadwal saved locally');
            }
            
            alert(`Jadwal seminar proposal berhasil dibuat!\n\nMahasiswa: ${mahasiswa}\nTanggal: ${new Date(tanggal).toLocaleString('id-ID')}\nRuangan: ${ruangan}\nPenguji 1: ${penguji1}\nPenguji 2: ${penguji2}\n\nNotifikasi telah dikirim ke mahasiswa dan dosen penguji.`);
            form.reset();
            
            // Update rekapitulasi table
            updateRekapJadwalSeminar();
            
            // Update notifications
            updateMahasiswaNotifications();
            updateDosenNotifications();
        }

        function terbitkanSK() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const form = event ? event.target.closest('form') : document.querySelector('#portalProdi form:last-of-type');
            const mahasiswa = form.querySelector('select').value;
            const nomorSK = form.querySelector('input[placeholder="SK/001/2025"]').value;
            const pembimbing1 = form.querySelectorAll('select')[1].value;
            const pembimbing2 = form.querySelectorAll('select')[2].value;
            
            if (!mahasiswa || !nomorSK || !pembimbing1 || !pembimbing2) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            alert(`SK Pembimbing berhasil diterbitkan!\n\nNomor SK: ${nomorSK}\nMahasiswa: ${mahasiswa}\nPembimbing 1: ${pembimbing1}\nPembimbing 2: ${pembimbing2}\n\nDokumen akan dikirim ke dosen pembimbing.`);
            form.reset();
        }

        // Dosen functions
        async function tandatanganiForm(nim) {
            // Prevent default behavior
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            // Find submission and update approval status
            const submission = submissions.judulSkripsi.find(s => s.nim === nim);
            if (submission) {
                submission.dosenWaliApproval = true;
                submission.tanggalPersetujuanDosen = new Date().toLocaleDateString('id-ID');
                
                try {
                    // Update in Firebase if available
                    if (submission.id) {
                        await updateDoc(doc(db, 'pengajuan_judul', submission.id), {
                            dosenWaliApproval: true,
                            tanggalPersetujuanDosen: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    console.log('Demo mode - approval saved locally');
                    saveLocalData();
                }
                
                alert('Form pengajuan judul berhasil ditandatangani!');
                
                // Update table display
                updatePersetujuanDosenTable();
            }
        }

        async function simpanBimbingan() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const form = event ? event.target.closest('form') : document.querySelector('#portalDosen form');
            const mahasiswa = document.getElementById('bimbinganMahasiswaSelect').value;
            const tanggal = form.querySelector('input[type="date"]').value;
            const materi = form.querySelector('textarea[placeholder="Jelaskan materi yang dibimbing"]').value;
            const catatan = form.querySelector('textarea[placeholder="Catatan dan saran untuk mahasiswa"]').value;
            
            if (!mahasiswa || !tanggal || !materi || !catatan) {
                alert('Mohon lengkapi semua field bimbingan!');
                return;
            }
            
            // Get dosen name from login
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            const dosenNama = dosen ? dosen.nama : 'Dosen Pembimbing';
            
            // Add to local storage
            const newBimbingan = {
                id: Date.now().toString(),
                mahasiswa: mahasiswa,
                tanggal: tanggal,
                materi: materi,
                catatan: catatan,
                pembimbing: dosenNama,
                timestamp: new Date()
            };
            
            submissions.bimbingan.push(newBimbingan);
            
            try {
                await addDoc(collection(db, 'bimbingan'), newBimbingan);
            } catch (error) {
                console.log('Demo mode - data saved locally');
                saveLocalData();
            }
            
            alert('Data bimbingan berhasil disimpan!');
            form.reset();
            
            // Update riwayat bimbingan display
            updateRiwayatBimbingan();
        }

        // Update dropdown options based on accounts
        function updateDropdownOptions() {
            // Update mahasiswa dropdowns
            const mahasiswaSelects = document.querySelectorAll('#mahasiswaSelect, select[id*="mahasiswa"]');
            mahasiswaSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Pilih Mahasiswa</option>';
                accounts.mahasiswa.forEach(mhs => {
                    if (mhs.status === 'aktif') {
                        const option = document.createElement('option');
                        option.value = `${mhs.nama} (${mhs.nim})`;
                        option.textContent = `${mhs.nama} (${mhs.nim})`;
                        if (option.value === currentValue) option.selected = true;
                        select.appendChild(option);
                    }
                });
            });
            
            // Update dosen dropdowns for penguji/pembimbing
            const dosenSelects = document.querySelectorAll('#penguji1Select, #penguji2Select, select[id*="pembimbing"], select[id*="penguji"]');
            dosenSelects.forEach(select => {
                const currentValue = select.value;
                const placeholder = select.id.includes('penguji1') || select.id.includes('pembimbing1') ? 'Pilih Penguji 1' : 
                                  select.id.includes('penguji2') || select.id.includes('pembimbing2') ? 'Pilih Penguji 2' : 'Pilih Dosen';
                select.innerHTML = `<option value="">${placeholder}</option>`;
                accounts.dosen.forEach(dosen => {
                    if (dosen.status === 'aktif') {
                        const option = document.createElement('option');
                        option.value = dosen.nama;
                        option.textContent = dosen.nama;
                        if (option.value === currentValue) option.selected = true;
                        select.appendChild(option);
                    }
                });
            });

            // Update dosen dropdown in bimbingan form
            const bimbinganMahasiswaSelect = document.getElementById('bimbinganMahasiswaSelect');
            if (bimbinganMahasiswaSelect) {
                const currentValue = bimbinganMahasiswaSelect.value;
                bimbinganMahasiswaSelect.innerHTML = '<option value="">Pilih Mahasiswa</option>';
                accounts.mahasiswa.forEach(mhs => {
                    if (mhs.status === 'aktif') {
                        const option = document.createElement('option');
                        option.value = `${mhs.nama} (${mhs.nim})`;
                        option.textContent = `${mhs.nama} (${mhs.nim})`;
                        if (option.value === currentValue) option.selected = true;
                        bimbinganMahasiswaSelect.appendChild(option);
                    }
                });
            }
        }

        // Update notification functions
        function updateMahasiswaNotifications() {
            const nimLogin = sessionStorage.getItem('mahasiswaLogin');
            if (!nimLogin) return;
            
            const statusDiv = document.getElementById('statusPengajuan');
            const notifikasiDiv = document.getElementById('notifikasiSeminar');
            if (!statusDiv || !notifikasiDiv) return;
            
            // Update status pengajuan
            const submission = submissions.judulSkripsi.find(s => s.nim === nimLogin);
            if (submission) {
                let statusClass = 'bg-yellow-100 text-yellow-800 border-yellow-400';
                if (submission.status === 'Disetujui') statusClass = 'bg-green-100 text-green-800 border-green-400';
                else if (submission.status === 'Ditolak') statusClass = 'bg-red-100 text-red-800 border-red-400';
                
                statusDiv.innerHTML = `
                    <div class="p-4 ${statusClass} border-l-4 rounded">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium">${submission.status}</p>
                                <p class="text-sm">Diajukan: ${submission.tanggalPengajuan}</p>
                                ${submission.catatan ? `<p class="text-sm mt-1 font-medium">Catatan: ${submission.catatan}</p>` : ''}
                            </div>
                            <span class="px-3 py-1 bg-white bg-opacity-50 rounded-full text-sm">${submission.status}</span>
                        </div>
                    </div>
                `;
            }
            
            // Update notifikasi seminar
            const notifikasi = submissions.notifikasi.mahasiswa[nimLogin] || [];
            const jadwalNotif = notifikasi.filter(n => n.type === 'jadwal_seminar');
            
            if (jadwalNotif.length > 0) {
                notifikasiDiv.innerHTML = jadwalNotif.map(notif => `
                    <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-blue-800">üìÖ ${notif.message}</p>
                                <p class="text-sm text-blue-600">Tanggal: ${notif.tanggal} - ${notif.waktu}</p>
                                <p class="text-sm text-blue-600">Ruangan: ${notif.ruangan}</p>
                                <p class="text-sm text-blue-600">Penguji 1: ${notif.penguji1}</p>
                                <p class="text-sm text-blue-600">Penguji 2: ${notif.penguji2}</p>
                            </div>
                            <span class="px-2 py-1 bg-blue-200 text-blue-800 rounded-full text-xs">Baru</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function updateDosenNotifications() {
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            if (!dosenLogin) return;
            
            const notifikasiDiv = document.getElementById('notifikasiJadwalDosen');
            if (!notifikasiDiv) return;
            
            // Find dosen name from accounts
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            if (!dosen) return;
            
            const notifikasi = submissions.notifikasi.dosen[dosen.nama] || [];
            
            if (notifikasi.length > 0) {
                notifikasiDiv.innerHTML = notifikasi.map(notif => `
                    <div class="p-4 bg-purple-50 border-l-4 border-purple-400 rounded">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-purple-800">üìÖ ${notif.message}</p>
                                <p class="text-sm text-purple-600">Mahasiswa: ${notif.mahasiswa} (${notif.nim})</p>
                                <p class="text-sm text-purple-600">Tanggal: ${notif.tanggal} - ${notif.waktu}</p>
                                <p class="text-sm text-purple-600">Ruangan: ${notif.ruangan}</p>
                            </div>
                            <span class="px-2 py-1 bg-purple-200 text-purple-800 rounded-full text-xs">Baru</span>
                        </div>
                    </div>
                `).join('');
            } else {
                notifikasiDiv.innerHTML = '<p class="text-gray-500 text-sm">Belum ada jadwal seminar yang ditugaskan.</p>';
            }
        }

        function updatePersetujuanDosenTable() {
            const tbody = document.getElementById('persetujuanDosenTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get approved titles that need dosen wali approval
            const approvedTitles = submissions.judulSkripsi.filter(s => s.status === 'Disetujui');
            
            if (approvedTitles.length > 0) {
                approvedTitles.forEach(submission => {
                    const row = document.createElement('tr');
                    const statusClass = submission.dosenWaliApproval ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const statusText = submission.dosenWaliApproval ? 'Disetujui Dosen Wali' : 'Menunggu Persetujuan';
                    const actionHtml = submission.dosenWaliApproval ? 
                        '<span class="text-green-600 text-xs">‚úì Sudah Ditandatangani</span>' :
                        `<button onclick="tandatanganiForm('${submission.nim}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">Tandatangani</button>`;
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${submission.nim}</td>
                        <td class="px-4 py-3 text-sm">${submission.nama}</td>
                        <td class="px-4 py-3 text-sm">${submission.judul}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${statusText}</span></td>
                        <td class="px-4 py-3">${actionHtml}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Belum ada judul yang perlu persetujuan dosen wali</td></tr>';
            }
        }
        
        function updateRekapJadwalSeminar() {
            const tbody = document.getElementById('rekapJadwalSeminar');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            submissions.jadwalSeminar.forEach(jadwal => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${jadwal.mahasiswa}</td>
                    <td class="px-4 py-3 text-sm">${new Date(jadwal.tanggal).toLocaleString('id-ID')}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.ruangan}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.penguji1}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.penguji2}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">${jadwal.status}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            if (submissions.jadwalSeminar.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-8 text-center text-gray-500">Belum ada jadwal seminar yang dibuat</td></tr>';
            }
        }

        function updateProdiNotifications() {
            const notifikasiDiv = document.getElementById('notifikasiProdi');
            if (!notifikasiDiv) return;
            
            const notifikasi = submissions.notifikasi.prodi || [];
            
            if (notifikasi.length > 0) {
                notifikasiDiv.innerHTML = notifikasi.map(notif => `
                    <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-blue-800">üìù ${notif.message}</p>
                                <p class="text-sm text-blue-600">Mahasiswa: ${notif.nama} (${notif.nim})</p>
                                <p class="text-sm text-blue-600">Waktu: ${notif.tanggal} - ${notif.waktu}</p>
                            </div>
                            <span class="px-2 py-1 bg-blue-200 text-blue-800 rounded-full text-xs">Baru</span>
                        </div>
                    </div>
                `).join('');
            } else {
                notifikasiDiv.innerHTML = '<p class="text-gray-500 text-sm">Belum ada notifikasi baru.</p>';
            }
        }

        function updateRekapPengajuanSeminar() {
            // Update for mahasiswa
            const tbodyMahasiswa = document.getElementById('rekapSeminarMahasiswa');
            if (tbodyMahasiswa) {
                const nimLogin = sessionStorage.getItem('mahasiswaLogin');
                tbodyMahasiswa.innerHTML = '';
                
                const pengajuanMahasiswa = submissions.pengajuanSeminar.filter(p => p.nim === nimLogin);
                
                if (pengajuanMahasiswa.length > 0) {
                    pengajuanMahasiswa.forEach(pengajuan => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm">${pengajuan.nim}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.nama}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.tanggalSubmit}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${pengajuan.status}</span></td>
                        `;
                        tbodyMahasiswa.appendChild(row);
                    });
                } else {
                    tbodyMahasiswa.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Belum ada pengajuan seminar proposal</td></tr>';
                }
            }
            
            // Update for prodi
            const tbodyProdi = document.getElementById('rekapSeminarProdi');
            if (tbodyProdi) {
                tbodyProdi.innerHTML = '';
                
                if (submissions.pengajuanSeminar.length > 0) {
                    submissions.pengajuanSeminar.forEach(pengajuan => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm">${pengajuan.nim}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.nama}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.tanggalSubmit}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${pengajuan.status}</span></td>
                        `;
                        tbodyProdi.appendChild(row);
                    });
                } else {
                    tbodyProdi.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Belum ada pengajuan seminar proposal</td></tr>';
                }
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize without triggering events
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Set initial navigation state
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-blue-50');
            });
            navButtons[0].classList.remove('text-gray-600', 'hover:bg-blue-50');
            navButtons[0].classList.add('bg-blue-600', 'text-white');
            
            // Load data from Firebase
            loadData();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97feaacea676aa1c',t:'MTc1ODAwNzkxOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
