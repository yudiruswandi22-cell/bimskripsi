<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Skripsi - STAI Al-Mas'udiyah</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBSsjGey5Akia8nDt5UC0Kucsl_lcGhNVY",
            authDomain: "bimskripsi-b3e64.firebaseapp.com",
            projectId: "bimskripsi-b3e64",
            storageBucket: "bimskripsi-b3e64.firebasestorage.app",
            messagingSenderId: "754252286102",
            appId: "1:754252286102:web:6898cd13fcbc8b13839ab7"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase functions globally available
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.doc = doc;
        window.query = query;
        window.orderBy = orderBy;
        window.onSnapshot = onSnapshot;
    </script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .step-active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .step-pending {
            background: #f3f4f6;
            color: #6b7280;
        }
        .step-completed {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
        }
        
        /* Print styles */
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-center space-x-4">
                <img src="https://iili.io/KdXnlX2.png" alt="Logo STAI Al-Mas'udiyah" class="h-16 w-16 object-contain" onerror="this.src=''; this.alt='Logo tidak dapat dimuat'; this.style.display='none';">
                <div class="text-center">
                    <h1 class="text-2xl md:text-3xl font-bold text-white">MANAJEMEN SKRIPSI/TUGAS AKHIR</h1>
                    <p class="text-blue-100 text-lg font-medium">STAI AL-MAS'UDIYAH SUKABUMI</p>
                </div>
            </div>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-center space-x-8 py-4">
                <button onclick="showPage('dashboard')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors bg-blue-600 text-white">Dashboard</button>
                <button onclick="showPage('mahasiswa')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-600 hover:bg-blue-50">Mahasiswa</button>
                <button onclick="showPage('prodi')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-600 hover:bg-blue-50">Program Studi</button>
                <button onclick="showPage('dosen')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-600 hover:bg-blue-50">Dosen</button>
                <button onclick="showPage('manajemen')" class="nav-btn px-4 py-2 rounded-lg font-medium transition-colors text-gray-600 hover:bg-blue-50">Manajemen</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Dashboard Page -->
        <div id="dashboard" class="page-content">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Alur Manajemen Skripsi</h2>
                <p class="text-gray-600">Sistem manajemen skripsi terintegrasi untuk mahasiswa, program studi, dan dosen</p>
            </div>

            <!-- Process Flow -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                <h3 class="text-xl font-bold text-gray-800 mb-6">Alur Proses Skripsi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="step-card p-4 rounded-lg border-l-4 border-blue-500 bg-blue-50">
                        <div class="font-semibold text-blue-800">1. Pengajuan Judul</div>
                        <p class="text-sm text-blue-600 mt-1">Mahasiswa mengajukan judul skripsi</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-green-500 bg-green-50">
                        <div class="font-semibold text-green-800">2. Validasi Prodi</div>
                        <p class="text-sm text-green-600 mt-1">Program Studi memvalidasi judul</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-purple-500 bg-purple-50">
                        <div class="font-semibold text-purple-800">3. Persetujuan Dosen Wali</div>
                        <p class="text-sm text-purple-600 mt-1">Dosen wali menandatangani form</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-yellow-500 bg-yellow-50">
                        <div class="font-semibold text-yellow-800">4. Penyusunan Proposal</div>
                        <p class="text-sm text-yellow-600 mt-1">Mahasiswa menyusun proposal</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-red-500 bg-red-50">
                        <div class="font-semibold text-red-800">5. Seminar Proposal</div>
                        <p class="text-sm text-red-600 mt-1">Pelaksanaan seminar proposal</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-indigo-500 bg-indigo-50">
                        <div class="font-semibold text-indigo-800">6. Penetapan Pembimbing</div>
                        <p class="text-sm text-indigo-600 mt-1">SK Pembimbing 1 dan 2</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-pink-500 bg-pink-50">
                        <div class="font-semibold text-pink-800">7. Proses Bimbingan</div>
                        <p class="text-sm text-pink-600 mt-1">Minimal 12 kali bimbingan</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-teal-500 bg-teal-50">
                        <div class="font-semibold text-teal-800">8. Pengajuan Munaqosyah</div>
                        <p class="text-sm text-teal-600 mt-1">Pengajuan sidang akhir</p>
                    </div>
                    <div class="step-card p-4 rounded-lg border-l-4 border-gray-500 bg-gray-50">
                        <div class="font-semibold text-gray-800">9. Jadwal Munaqosyah</div>
                        <p class="text-sm text-gray-600 mt-1">Penjadwalan sidang akhir</p>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-blue-100">
                            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Total Mahasiswa</h3>
                            <p class="text-2xl font-bold text-blue-600">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-green-100">
                            <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Skripsi Selesai</h3>
                            <p class="text-2xl font-bold text-green-600">0</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                    <div class="flex items-center">
                        <div class="p-3 rounded-full bg-yellow-100">
                            <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="ml-4">
                            <h3 class="text-lg font-semibold text-gray-800">Dalam Proses</h3>
                            <p class="text-2xl font-bold text-yellow-600">0</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Mahasiswa Page -->
        <div id="mahasiswa" class="page-content hidden">
            <!-- Login Form Mahasiswa -->
            <div id="loginMahasiswa" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Login Mahasiswa</h2>
                    <p class="text-gray-600 mt-2">Masukkan NIM untuk mengakses portal</p>

                </div>
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                        <input type="text" id="nimLogin" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM Anda">
                    </div>
                    <button type="button" onclick="loginMahasiswa()" class="w-full bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors font-medium">Masuk Portal</button>
                </form>
            </div>

            <!-- Portal Mahasiswa Content -->
            <div id="portalMahasiswa" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Portal Mahasiswa</h2>
                    <div class="flex items-center space-x-4">
                        <span id="welcomeMahasiswa" class="text-gray-600"></span>
                        <button onclick="logoutMahasiswa()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">Logout</button>
                    </div>
                </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Form Pengajuan Judul -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üìù Pengajuan Judul Skripsi</h3>
                    <form class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama lengkap">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Judul Skripsi</label>
                            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Masukkan judul skripsi yang diajukan"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Latar Belakang Singkat</label>
                            <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-32" placeholder="Jelaskan latar belakang penelitian"></textarea>
                        </div>
                        <button type="button" onclick="submitJudul()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Ajukan Judul</button>
                    </form>
                </div>

                <!-- Status Pengajuan -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Status Pengajuan & Notifikasi</h3>
                    <div id="statusPengajuan" class="space-y-4">
                        <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-medium text-yellow-800">Menunggu Validasi Prodi</p>
                                    <p class="text-sm text-yellow-600">Diajukan: 15 Januari 2025</p>
                                </div>
                                <span class="px-3 py-1 bg-yellow-200 text-yellow-800 rounded-full text-sm">Pending</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Notifikasi Jadwal Seminar -->
                    <div id="notifikasiSeminar" class="mt-4 space-y-3">
                        <!-- Notifikasi akan muncul di sini -->
                    </div>
                </div>
            </div>

            <!-- Form Pengajuan Seminar Proposal -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üéØ Pengajuan Seminar Proposal</h3>
                <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                        <input type="text" id="nimSeminar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Pengajuan</label>
                        <input type="date" id="tanggalSeminar" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Proposal</label>
                        <textarea id="catatanProposal" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Masukkan catatan atau ringkasan proposal skripsi"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <button type="button" onclick="submitSeminar()" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Ajukan Seminar Proposal</button>
                    </div>
                </form>
            </div>

            <!-- Rekapitulasi Pengajuan Seminar Proposal Mahasiswa -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Rekapitulasi Pengajuan Seminar Proposal</h3>
                <div class="mb-4 flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAllSeminarMhs" onchange="toggleSelectAllSeminarMhs()" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Pilih Semua</span>
                    </label>
                    <button onclick="hapusDataTerpilih('seminarMhs')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">HAPUS DATA</button>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pilih</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal Pengajuan</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="rekapSeminarMahasiswa" class="divide-y divide-gray-200">
                            <!-- Data akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Form Pengajuan Munaqosyah -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üéì Pengajuan Sidang Munaqosyah</h3>
                <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah Bimbingan</label>
                        <input type="number" min="12" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Minimal 12 kali">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Skripsi Final</label>
                        <textarea id="catatanSkripsi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Masukkan ringkasan atau catatan skripsi final"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan Kartu Bimbingan</label>
                        <textarea id="catatanKartuBimbingan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Masukkan ringkasan kartu bimbingan"></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <button type="button" onclick="submitMunaqosyah()" class="bg-purple-600 text-white py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors">Ajukan Sidang Munaqosyah</button>
                    </div>
                </form>
            </div>

            <!-- Panel Input Berkas -->
            <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìÅ Input Berkas Skripsi</h3>
                <div class="text-center">
                    <div class="mb-4">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        <h4 class="text-lg font-semibold text-gray-800 mb-2">Upload Berkas Skripsi</h4>
                        <p class="text-gray-600 mb-6">Klik tombol di bawah untuk mengakses folder Google Drive dan upload berkas skripsi Anda</p>
                    </div>
                    <button onclick="openGoogleDrive()" 
                            class="inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors shadow-md hover:shadow-lg">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        Buka Folder Google Drive
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </button>
                    
                    <!-- Alternative link jika popup diblokir -->
                    <div id="alternativeLink" class="mt-3 hidden">
                        <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <p class="text-sm text-yellow-800 mb-2">
                                <strong>Popup diblokir?</strong> Klik link di bawah ini:
                            </p>
                            <a href="https://drive.google.com/drive/folders/1OUW7LhUaQ20ubFQ6h8zADqGCu5CX21Lh?usp=drive_link" 
                               target="_blank" 
                               class="text-blue-600 hover:text-blue-800 underline text-sm font-medium">
                                üìÅ https://drive.google.com/drive/folders/1OUW7LhUaQ20ubFQ6h8zADqGCu5CX21Lh
                            </a>
                            <p class="text-xs text-gray-600 mt-1">
                                Atau copy-paste link di atas ke browser baru
                            </p>
                        </div>
                    </div>
                    <div class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded text-left">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-700">
                                    <strong>Petunjuk:</strong> Pastikan Anda sudah login dengan akun Google yang sesuai. Upload berkas dalam format PDF dengan nama file yang jelas (contoh: NIM_Nama_Skripsi.pdf).
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Program Studi Page -->
        <div id="prodi" class="page-content hidden">
            <!-- Login Form Program Studi -->
            <div id="loginProdi" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Login Program Studi</h2>
                    <p class="text-gray-600 mt-2">Masukkan username dan password</p>

                </div>
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="usernameProdi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="passwordProdi" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                    </div>
                    <button type="button" onclick="loginProdi()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">Masuk Portal</button>
                </form>
            </div>

            <!-- Portal Program Studi Content -->
            <div id="portalProdi" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Portal Program Studi</h2>
                    <div class="flex items-center space-x-4">
                        <span id="welcomeProdi" class="text-gray-600"></span>
                        <button onclick="logoutProdi()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">Logout</button>
                    </div>
                </div>
            
            <!-- Notifikasi Program Studi -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üîî Notifikasi Program Studi</h3>
                <div id="notifikasiProdi" class="space-y-3">
                    <!-- Notifikasi akan muncul di sini -->
                </div>
            </div>

            <!-- Validasi Judul -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">‚úÖ Validasi Judul Skripsi</h3>
                <div class="mb-4 flex items-center space-x-4 flex-wrap gap-2">
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Pilih Semua</span>
                    </label>
                    <button onclick="validasiMassal('terima')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">DITERIMA</button>
                    <button onclick="validasiMassal('tolak')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">DITOLAK</button>
                    <button onclick="hapusDataTerpilih('judul')" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">HAPUS DATA</button>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pilih</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Judul</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="judulTable" class="divide-y divide-gray-200">
                            <!-- Data akan dimuat dari Firebase -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Penjadwalan Seminar -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìÖ Penjadwalan Seminar Proposal</h3>
                <form class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mahasiswa</label>
                        <select id="mahasiswaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Mahasiswa</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal & Waktu</label>
                        <input type="datetime-local" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ruangan</label>
                        <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ruang 101">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Penguji 1</label>
                        <select id="penguji1Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Penguji 1</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Penguji 2</label>
                        <select id="penguji2Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Penguji 2</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="button" onclick="buatJadwalSeminar()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Buat Jadwal</button>
                    </div>
                </form>
            </div>

            <!-- Rekapitulasi Pengajuan Seminar Proposal Program Studi -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Rekapitulasi Pengajuan Seminar Proposal</h3>
                <div class="mb-4 flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAllSeminar" onchange="toggleSelectAllSeminar()" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Pilih Semua</span>
                    </label>
                    <button onclick="hapusDataTerpilih('seminar')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">HAPUS DATA</button>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pilih</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal Pengajuan</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="rekapSeminarProdi" class="divide-y divide-gray-200">
                            <!-- Data akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Rekapitulasi Jadwal Seminar -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Rekapitulasi Jadwal Seminar Proposal</h3>
                <div class="mb-4 flex items-center space-x-4 flex-wrap gap-2">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Filter Tanggal:</label>
                        <input type="date" id="filterTanggalSeminar" onchange="filterJadwalSeminar()" class="px-3 py-1 border border-gray-300 rounded text-sm">
                        <button onclick="clearFilterSeminar()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">Clear</button>
                    </div>
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAllJadwalSeminar" onchange="toggleSelectAllJadwalSeminar()" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Pilih Semua</span>
                    </label>
                    <button onclick="hapusDataTerpilih('jadwalSeminar')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">HAPUS DATA</button>
                    <button onclick="printJadwalSeminar()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">üñ®Ô∏è PRINT JADWAL</button>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pilih</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Mahasiswa</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal & Waktu</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Ruangan</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Penguji 1</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Penguji 2</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="rekapJadwalSeminar" class="divide-y divide-gray-200">
                            <!-- Data jadwal akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SK Pembimbing -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Penetapan Pembimbing</h3>
                <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mahasiswa</label>
                        <div class="relative">
                            <input type="text" id="mahasiswaSearchInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ketik nama mahasiswa untuk mencari..." onkeyup="searchMahasiswa()" onclick="showMahasiswaOptions()">
                            <div id="mahasiswaOptions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto hidden">
                                <!-- Options akan muncul di sini -->
                            </div>
                        </div>
                        <input type="hidden" id="selectedMahasiswaNim" value="">
                        <input type="hidden" id="selectedMahasiswaNama" value="">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nomor SK</label>
                        <input type="text" id="nomorSKInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="SK/001/2025">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pembimbing 1</label>
                        <select id="pembimbing1Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Pembimbing 1</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Pembimbing 2</label>
                        <select id="pembimbing2Select" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Pembimbing 2</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <button type="button" onclick="terbitkanSK()" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Terbitkan SK Pembimbing</button>
                    </div>
                </form>
            </div>

            <!-- Rekapitulasi Pembimbing -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Rekapitulasi Penetapan Pembimbing</h3>
                <div class="mb-4 flex items-center space-x-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAllPembimbing" onchange="toggleSelectAllPembimbing()" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Pilih Semua</span>
                    </label>
                    <button onclick="hapusDataTerpilih('pembimbing')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">HAPUS DATA</button>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pilih</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama Mahasiswa</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nomor SK</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pembimbing 1</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pembimbing 2</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal SK</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="rekapPembimbingTable" class="divide-y divide-gray-200">
                            <!-- Data akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Penjadwalan Sidang Munaqosyah -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üéì Penjadwalan Sidang Munaqosyah</h3>
                <form class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Mahasiswa</label>
                        <select id="munaqosyahMahasiswaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Mahasiswa</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal & Waktu</label>
                        <input type="datetime-local" id="munaqosyahDateTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Ruangan</label>
                        <input type="text" id="munaqosyahRuangan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ruang 201">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Penguji 1</label>
                        <select id="munaqosyahPenguji1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Penguji 1</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Penguji 2</label>
                        <select id="munaqosyahPenguji2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Pilih Penguji 2</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button type="button" onclick="buatJadwalMunaqosyah()" class="w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 transition-colors">Buat Jadwal Munaqosyah</button>
                    </div>
                </form>
            </div>

            <!-- Panel Manajemen Status Skripsi -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìä Manajemen Status Skripsi</h3>
                <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                    <p class="text-sm text-blue-800">
                        <strong>Petunjuk:</strong> Panel ini digunakan untuk mengubah status skripsi mahasiswa menjadi "Selesai" atau "Dalam Proses" 
                        yang akan mempengaruhi statistik di Dashboard.
                    </p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Update Status Individual -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Update Status Individual</h4>
                        <form class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Mahasiswa</label>
                                <select id="statusMahasiswaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Mahasiswa</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status Skripsi</label>
                                <select id="statusSkripsiSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Status</option>
                                    <option value="Dalam Proses">Dalam Proses</option>
                                    <option value="Selesai">Selesai</option>
                                    <option value="Belum Mulai">Belum Mulai</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Catatan (Opsional)</label>
                                <textarea id="statusCatatan" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-20" placeholder="Catatan tambahan..."></textarea>
                            </div>
                            <button type="button" onclick="updateStatusSkripsi()" class="w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">Update Status</button>
                        </form>
                    </div>
                    
                    <!-- Rekapitulasi Status -->
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Rekapitulasi Status Skripsi</h4>
                        <div class="space-y-3 max-h-80 overflow-y-auto">
                            <div id="rekapStatusSkripsi" class="space-y-2">
                                <!-- Status akan muncul di sini -->
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div class="p-3 bg-green-50 rounded-lg">
                                    <div class="text-lg font-bold text-green-600" id="countSelesai">0</div>
                                    <div class="text-xs text-green-600">Selesai</div>
                                </div>
                                <div class="p-3 bg-yellow-50 rounded-lg">
                                    <div class="text-lg font-bold text-yellow-600" id="countProses">0</div>
                                    <div class="text-xs text-yellow-600">Dalam Proses</div>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <div class="text-lg font-bold text-gray-600" id="countBelum">0</div>
                                    <div class="text-xs text-gray-600">Belum Mulai</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rekapitulasi Jadwal Munaqosyah -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Rekapitulasi Jadwal Sidang Munaqosyah</h3>
                <div class="mb-4 flex items-center space-x-4 flex-wrap gap-2">
                    <div class="flex items-center space-x-2">
                        <label class="text-sm font-medium text-gray-700">Filter Tanggal:</label>
                        <input type="date" id="filterTanggalMunaqosyah" onchange="filterJadwalMunaqosyah()" class="px-3 py-1 border border-gray-300 rounded text-sm">
                        <button onclick="clearFilterMunaqosyah()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">Clear</button>
                    </div>
                    <label class="flex items-center">
                        <input type="checkbox" id="selectAllJadwalMunaqosyah" onchange="toggleSelectAllJadwalMunaqosyah()" class="mr-2">
                        <span class="text-sm font-medium text-gray-700">Pilih Semua</span>
                    </label>
                    <button onclick="hapusDataTerpilih('jadwalMunaqosyah')" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 text-sm">HAPUS DATA</button>
                    <button onclick="printJadwalMunaqosyah()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm">üñ®Ô∏è PRINT JADWAL</button>
                </div>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Pilih</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Mahasiswa</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal & Waktu</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Ruangan</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Penguji 1</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Penguji 2</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="rekapJadwalMunaqosyah" class="divide-y divide-gray-200">
                            <!-- Data jadwal akan muncul di sini -->
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Dosen Page -->
        <div id="dosen" class="page-content hidden">
            <!-- Login Form Dosen -->
            <div id="loginDosen" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Login Dosen</h2>
                    <p class="text-gray-600 mt-2">Masukkan username dan password</p>

                </div>
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="usernameDosen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="passwordDosen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                    </div>
                    <button type="button" onclick="loginDosen()" class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors font-medium">Masuk Portal</button>
                </form>
            </div>

            <!-- Portal Dosen Content -->
            <div id="portalDosen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Portal Dosen</h2>
                    <div class="flex items-center space-x-4">
                        <span id="welcomeDosen" class="text-gray-600"></span>
                        <button onclick="logoutDosen()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">Logout</button>
                    </div>
                </div>
                
                <!-- Notifikasi Jadwal Seminar -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">üîî Notifikasi Jadwal Seminar</h3>
                    <div id="notifikasiJadwalDosen" class="space-y-3">
                        <!-- Notifikasi jadwal seminar akan muncul di sini -->
                    </div>
                </div>

                <!-- Persetujuan Dosen Wali -->
            <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">‚úçÔ∏è Persetujuan Dosen Wali</h3>
                <div class="overflow-x-auto max-h-96 overflow-y-auto">
                    <table class="w-full table-auto">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Judul</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="persetujuanDosenTable" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Kartu Bimbingan -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">üìù Kartu Bimbingan</h3>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Input Bimbingan Baru</h4>
                        <form class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Mahasiswa</label>
                                <select id="bimbinganMahasiswaSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Mahasiswa</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Bimbingan</label>
                                <input type="date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Materi Bimbingan</label>
                                <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Jelaskan materi yang dibimbing"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Catatan/Saran</label>
                                <textarea class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 h-24" placeholder="Catatan dan saran untuk mahasiswa"></textarea>
                            </div>
                            <button type="button" onclick="simpanBimbingan()" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Simpan Bimbingan</button>
                        </form>
                    </div>
                    
                    <div>
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-700">Riwayat Bimbingan</h4>
                            <div class="flex space-x-2">
                                <button onclick="hapusDataTerpilih('bimbingan')" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700 no-print">üóëÔ∏è Hapus Data</button>
                                <button onclick="printKartuBimbingan()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 no-print">üñ®Ô∏è Print Kartu</button>
                            </div>
                        </div>
                        
                        <!-- Filter Mahasiswa -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Filter Mahasiswa</label>
                            <div class="relative">
                                <input type="text" id="filterMahasiswaInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Ketik nama mahasiswa untuk mencari..." onkeyup="filterMahasiswa()" onclick="showMahasiswaDropdown()">
                                <div id="mahasiswaDropdown" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto hidden">
                                    <!-- Dropdown options akan muncul di sini -->
                                </div>
                            </div>
                            <div class="mt-2 flex items-center space-x-4">
                                <button onclick="clearFilter()" class="px-3 py-1 bg-gray-500 text-white rounded text-sm hover:bg-gray-600">Tampilkan Semua</button>
                                <label class="flex items-center">
                                    <input type="checkbox" id="selectAllBimbingan" onchange="toggleSelectAllBimbingan()" class="mr-2">
                                    <span class="text-sm font-medium text-gray-700">Pilih Semua</span>
                                </label>
                                <span id="selectedMahasiswaInfo" class="text-sm text-gray-600"></span>
                            </div>
                        </div>
                        
                        <div id="riwayatBimbingan" class="space-y-3 max-h-96 overflow-y-auto">
                            <div class="p-3 border border-gray-200 rounded-lg text-center text-gray-500">
                                <p class="text-sm">Pilih mahasiswa untuk melihat riwayat bimbingan</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>

        <!-- Manajemen Page -->
        <div id="manajemen" class="page-content hidden">
            <!-- Login Form Manajemen -->
            <div id="loginManajemen" class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-8">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Login Manajemen</h2>
                    <p class="text-gray-600 mt-2">Masukkan username dan password administrator</p>

                </div>
                <form class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                        <input type="text" id="usernameManajemen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="passwordManajemen" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                    </div>
                    <button type="button" onclick="loginManajemen()" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg hover:bg-green-700 transition-colors font-medium">Masuk Portal</button>
                </form>
            </div>

            <!-- Portal Manajemen Content -->
            <div id="portalManajemen" class="hidden">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Portal Manajemen Akun</h2>
                    <div class="flex items-center space-x-4">
                        <span id="welcomeManajemen" class="text-gray-600"></span>
                        <button onclick="logoutManajemen()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm">Logout</button>
                    </div>
                </div>

                <!-- Tab Navigation -->
                <div class="border-b border-gray-200 mb-6">
                    <nav class="-mb-px flex space-x-8">
                        <button onclick="showManajemenTab('mahasiswa')" class="tab-btn py-2 px-1 border-b-2 border-blue-500 text-blue-600 font-medium text-sm">Akun Mahasiswa</button>
                        <button onclick="showManajemenTab('prodi')" class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Akun Program Studi</button>
                        <button onclick="showManajemenTab('dosen')" class="tab-btn py-2 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-medium text-sm">Akun Dosen</button>
                    </nav>
                </div>

                <!-- Tab Mahasiswa -->
                <div id="tabMahasiswa" class="tab-content">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üë®‚Äçüéì Tambah Akun Mahasiswa</h3>
                        <form class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">NIM</label>
                                <input type="text" id="newNim" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan NIM">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newNamaMhs" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama lengkap">
                            </div>
                            <div class="md:col-span-2">
                                <button type="button" onclick="tambahMahasiswa()" class="bg-blue-600 text-white py-2 px-6 rounded-lg hover:bg-blue-700 transition-colors">Tambah Mahasiswa</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Daftar Akun Mahasiswa</h3>
                        <div class="overflow-x-auto max-h-96 overflow-y-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">NIM</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="mahasiswaTable" class="divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab Program Studi -->
                <div id="tabProdi" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üè´ Tambah Akun Program Studi</h3>
                        <form class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="newUsernameProdi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="newPasswordProdi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newNamaProdi" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama lengkap">
                            </div>
                            <div class="md:col-span-3">
                                <button type="button" onclick="tambahProdi()" class="bg-green-600 text-white py-2 px-6 rounded-lg hover:bg-green-700 transition-colors">Tambah Akun Program Studi</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Daftar Akun Program Studi</h3>
                        <div class="overflow-x-auto max-h-96 overflow-y-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Username</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="prodiTable" class="divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Tab Dosen -->
                <div id="tabDosen" class="tab-content hidden">
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üë®‚Äçüè´ Tambah Akun Dosen</h3>
                        <form class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Username</label>
                                <input type="text" id="newUsernameDosen" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                                <input type="password" id="newPasswordDosen" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan password">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                                <input type="text" id="newNamaDosen" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan nama lengkap">
                            </div>
                            <div class="md:col-span-3">
                                <button type="button" onclick="tambahDosen()" class="bg-purple-600 text-white py-2 px-6 rounded-lg hover:bg-purple-700 transition-colors">Tambah Akun Dosen</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">üìã Daftar Akun Dosen</h3>
                        <div class="overflow-x-auto max-h-96 overflow-y-auto">
                            <table class="w-full table-auto">
                                <thead>
                                    <tr class="bg-gray-50">
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Username</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Nama</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Status</th>
                                        <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="dosenTable" class="divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Print Area for Kartu Bimbingan -->
    <div id="printArea" class="print-area hidden">
        <div class="p-8">
            <div class="text-center mb-6">
                <h1 class="text-2xl font-bold">KARTU BIMBINGAN SKRIPSI</h1>
                <h2 class="text-lg">STAI AL-MAS'UDIYAH SUKABUMI</h2>
            </div>
            <div id="printContent"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white mt-16">
        <div class="container mx-auto px-4 py-8">
            <div class="text-center">
                <h3 class="text-lg font-semibold mb-4">Sekretariat STAI Al-Mas'udiyah</h3>
                <p class="text-gray-300 mb-2">Jl. Sukabumi - Sagaranten Km. 26 Kp. Buni Ayu</p>
                <p class="text-gray-300 mb-2">Desa Kertaangsana Kec. Nyalindung Kab. Sukabumi 43196</p>
                <p class="text-gray-300 mb-4">Web: <a href="https://staimas.ac.id" class="text-blue-400 hover:text-blue-300">staimas.ac.id</a></p>
                <div class="border-t border-gray-700 pt-4">
                    <p class="text-sm text-gray-400">Copyright ¬© Lembaga Penjaminan Mutu (LPM) Tahun 2025</p>
                </div>
            </div>
            </div>
        </div>
    </footer>

    <script>
        // Firebase data management
        let currentMahasiswa = null;
        
        // Load all data from Firebase
        async function loadData() {
            try {
                // Load accounts
                await loadAccounts();
                
                // Load submissions
                await loadSubmissions();
                
                // Load notifications
                await loadNotifications();
                
                // Update dashboard statistics
                updateDashboardStats();
                
                // Update all tables and displays
                updateAllDisplays();
                
                console.log('Data loaded successfully from Firebase');
            } catch (error) {
                console.log('Firebase connection error, using local storage fallback');
                loadLocalData();
            }
        }

        // Load accounts from Firebase
        async function loadAccounts() {
            // Load mahasiswa accounts
            const mahasiswaSnapshot = await getDocs(collection(db, 'accounts_mahasiswa'));
            accounts.mahasiswa = [];
            mahasiswaSnapshot.forEach(doc => {
                accounts.mahasiswa.push({ id: doc.id, ...doc.data() });
            });

            // Load prodi accounts
            const prodiSnapshot = await getDocs(collection(db, 'accounts_prodi'));
            accounts.prodi = [];
            prodiSnapshot.forEach(doc => {
                accounts.prodi.push({ id: doc.id, ...doc.data() });
            });

            // Load dosen accounts
            const dosenSnapshot = await getDocs(collection(db, 'accounts_dosen'));
            accounts.dosen = [];
            dosenSnapshot.forEach(doc => {
                accounts.dosen.push({ id: doc.id, ...doc.data() });
            });
        }

        // Load submissions from Firebase
        async function loadSubmissions() {
            // Load pengajuan judul
            const judulSnapshot = await getDocs(collection(db, 'pengajuan_judul'));
            submissions.judulSkripsi = [];
            judulSnapshot.forEach(doc => {
                submissions.judulSkripsi.push({ id: doc.id, ...doc.data() });
            });

            // Load pengajuan seminar
            const seminarSnapshot = await getDocs(collection(db, 'pengajuan_seminar'));
            submissions.pengajuanSeminar = [];
            seminarSnapshot.forEach(doc => {
                submissions.pengajuanSeminar.push({ id: doc.id, ...doc.data() });
            });

            // Load bimbingan data
            const bimbinganSnapshot = await getDocs(query(collection(db, 'bimbingan'), orderBy('timestamp', 'desc')));
            submissions.bimbingan = [];
            bimbinganSnapshot.forEach(doc => {
                submissions.bimbingan.push({ id: doc.id, ...doc.data() });
            });

            // Load jadwal seminar
            const jadwalSnapshot = await getDocs(collection(db, 'jadwal_seminar'));
            submissions.jadwalSeminar = [];
            jadwalSnapshot.forEach(doc => {
                submissions.jadwalSeminar.push({ id: doc.id, ...doc.data() });
            });

            // Load munaqosyah
            const munaqosyahSnapshot = await getDocs(collection(db, 'pengajuan_munaqosyah'));
            submissions.munaqosyah = [];
            munaqosyahSnapshot.forEach(doc => {
                submissions.munaqosyah.push({ id: doc.id, ...doc.data() });
            });

            // Load pembimbing data
            const pembimbingSnapshot = await getDocs(collection(db, 'penetapan_pembimbing'));
            submissions.pembimbing = [];
            pembimbingSnapshot.forEach(doc => {
                submissions.pembimbing.push({ id: doc.id, ...doc.data() });
            });
        }

        // Load notifications from Firebase
        async function loadNotifications() {
            const notifikasiSnapshot = await getDocs(collection(db, 'notifikasi'));
            submissions.notifikasi = { mahasiswa: {}, dosen: {}, prodi: [] };
            
            notifikasiSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.nim) {
                    if (!submissions.notifikasi.mahasiswa[data.nim]) {
                        submissions.notifikasi.mahasiswa[data.nim] = [];
                    }
                    submissions.notifikasi.mahasiswa[data.nim].push({ id: doc.id, ...data });
                }
                if (data.dosen) {
                    if (!submissions.notifikasi.dosen[data.dosen]) {
                        submissions.notifikasi.dosen[data.dosen] = [];
                    }
                    submissions.notifikasi.dosen[data.dosen].push({ id: doc.id, ...data });
                }
                if (data.type === 'prodi') {
                    submissions.notifikasi.prodi.push({ id: doc.id, ...data });
                }
            });
        }

        // Load data from localStorage as fallback
        function loadLocalData() {
            const savedAccounts = localStorage.getItem('skripsi_accounts');
            const savedSubmissions = localStorage.getItem('skripsi_submissions');
            
            if (savedAccounts) {
                accounts = JSON.parse(savedAccounts);
            }
            if (savedSubmissions) {
                submissions = JSON.parse(savedSubmissions);
            }
            
            updateDashboardStats();
            updateAllDisplays();
        }

        // Save data to localStorage
        function saveLocalData() {
            localStorage.setItem('skripsi_accounts', JSON.stringify(accounts));
            localStorage.setItem('skripsi_submissions', JSON.stringify(submissions));
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            dashboardStats.totalMahasiswa = accounts.mahasiswa.filter(m => m.status === 'aktif').length;
            
            // Calculate based on status skripsi data
            dashboardStats.skripsiSelesai = submissions.statusSkripsi.filter(s => s.status === 'Selesai').length;
            dashboardStats.dalamProses = submissions.statusSkripsi.filter(s => s.status === 'Dalam Proses').length;
            
            // Update dashboard display
            const totalMahasiswaEl = document.querySelector('.text-2xl.font-bold.text-blue-600');
            const skripsiSelesaiEl = document.querySelector('.text-2xl.font-bold.text-green-600');
            const dalamProsesEl = document.querySelector('.text-2xl.font-bold.text-yellow-600');
            
            if (totalMahasiswaEl) totalMahasiswaEl.textContent = dashboardStats.totalMahasiswa;
            if (skripsiSelesaiEl) skripsiSelesaiEl.textContent = dashboardStats.skripsiSelesai;
            if (dalamProsesEl) dalamProsesEl.textContent = dashboardStats.dalamProses;
        }

        // Update all displays
        function updateAllDisplays() {
            updateMahasiswaTable();
            updateProdiTable();
            updateDosenTable();
            updateJudulValidasiTable();
            updateRekapJadwalSeminar();
            updateRekapJadwalMunaqosyah();
            updateRekapPengajuanSeminar();
            updateRekapPembimbingTable();
            updateDropdownOptions();
            updateRiwayatBimbingan();
            updatePersetujuanDosenTable();
            updateRekapStatusSkripsi();
            updateStatusDropdownOptions();
        }
        
        function updateJudulTable(snapshot) {
            const tbody = document.getElementById('judulTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${data.nim}</td>
                    <td class="px-4 py-3 text-sm">${data.nama}</td>
                    <td class="px-4 py-3 text-sm">${data.judul}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${data.status || 'Menunggu'}</span></td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="validasiJudul('terima', '${doc.id}')" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700">Terima</button>
                            <button onclick="validasiJudul('perbaiki', '${doc.id}')" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Perbaiki</button>
                            <button onclick="validasiJudul('tolak', '${doc.id}')" class="px-3 py-1 bg-red-600 text-white rounded text-xs hover:bg-red-700">Tolak</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Global variable to store selected mahasiswa for filtering
        let selectedMahasiswaFilter = null;

        function updateRiwayatBimbingan(snapshot, filterMahasiswa = null) {
            const container = document.getElementById('riwayatBimbingan');
            if (!container) return;
            
            container.innerHTML = '';
            
            let bimbinganData = [];
            
            // If snapshot is provided (from Firebase), use it
            if (snapshot) {
                snapshot.forEach(doc => {
                    bimbinganData.push(doc.data());
                });
            } else {
                // Use local submissions data
                bimbinganData = submissions.bimbingan;
            }
            
            // Filter by selected mahasiswa if specified
            if (filterMahasiswa) {
                bimbinganData = bimbinganData.filter(bimbingan => 
                    bimbingan.mahasiswa === filterMahasiswa
                );
            }
            
            if (bimbinganData.length > 0) {
                bimbinganData.forEach((bimbingan, index) => {
                    const div = document.createElement('div');
                    div.className = 'p-3 border border-gray-200 rounded-lg';
                    
                    // Ensure we have a valid ID for the checkbox
                    const bimbinganId = bimbingan.id || `bimbingan_${Date.now()}_${index}`;
                    const mahasiswaName = bimbingan.mahasiswa || 'Unknown';
                    
                    const checkboxHtml = `<input type="checkbox" class="bimbingan-checkbox" data-id="${bimbinganId}" data-mahasiswa="${mahasiswaName}">`;
                    
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex items-center space-x-2">
                                ${checkboxHtml}
                                <span class="font-medium text-sm">Bimbingan #${index + 1}</span>
                            </div>
                            <span class="text-xs text-gray-500">${bimbingan.tanggal || 'Tanggal tidak tersedia'}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1"><strong>Mahasiswa:</strong> ${mahasiswaName}</p>
                        <p class="text-sm text-gray-600 mb-1"><strong>Materi:</strong> ${bimbingan.materi || 'Tidak ada materi'}</p>
                        <p class="text-xs text-gray-500"><strong>Catatan:</strong> ${bimbingan.catatan || 'Tidak ada catatan'}</p>
                    `;
                    container.appendChild(div);
                });
            } else {
                const message = filterMahasiswa ? 
                    `Belum ada riwayat bimbingan untuk ${filterMahasiswa}` : 
                    'Pilih mahasiswa untuk melihat riwayat bimbingan';
                container.innerHTML = `<div class="p-3 border border-gray-200 rounded-lg text-center text-gray-500"><p class="text-sm">${message}</p></div>`;
            }
        }

        // Show mahasiswa dropdown - only show assigned mahasiswa
        function showMahasiswaDropdown() {
            const dropdown = document.getElementById('mahasiswaDropdown');
            const input = document.getElementById('filterMahasiswaInput');
            
            if (!dropdown || !input) return;
            
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            if (!dosenLogin) return;
            
            // Find dosen name from accounts
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            if (!dosen) return;
            
            // Get mahasiswa that are assigned to this dosen as pembimbing
            const assignedMahasiswa = submissions.pembimbing.filter(p => 
                p.pembimbing1 === dosen.nama || p.pembimbing2 === dosen.nama
            );
            
            dropdown.innerHTML = '';
            
            if (assignedMahasiswa.length > 0) {
                assignedMahasiswa.forEach(pembimbing => {
                    const mahasiswaName = `${pembimbing.nama} (${pembimbing.nim})`;
                    if (mahasiswaName.toLowerCase().includes(input.value.toLowerCase())) {
                        const option = document.createElement('div');
                        option.className = 'px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm';
                        option.textContent = mahasiswaName;
                        option.onclick = () => selectMahasiswa(mahasiswaName);
                        dropdown.appendChild(option);
                    }
                });
            } else {
                const option = document.createElement('div');
                option.className = 'px-3 py-2 text-gray-500 text-sm';
                option.textContent = 'Belum ada mahasiswa bimbingan yang ditetapkan';
                dropdown.appendChild(option);
            }
            
            dropdown.classList.remove('hidden');
        }

        // Filter mahasiswa based on input - only show assigned mahasiswa
        function filterMahasiswa() {
            const input = document.getElementById('filterMahasiswaInput');
            const dropdown = document.getElementById('mahasiswaDropdown');
            
            if (!input || !dropdown) return;
            
            const searchTerm = input.value.toLowerCase();
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            if (!dosenLogin) return;
            
            // Find dosen name from accounts
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            if (!dosen) return;
            
            // Get mahasiswa that are assigned to this dosen as pembimbing
            const assignedMahasiswa = submissions.pembimbing.filter(p => 
                p.pembimbing1 === dosen.nama || p.pembimbing2 === dosen.nama
            );
            
            dropdown.innerHTML = '';
            
            if (assignedMahasiswa.length > 0) {
                const filteredMahasiswa = assignedMahasiswa.filter(pembimbing => {
                    const mahasiswaName = `${pembimbing.nama} (${pembimbing.nim})`;
                    return mahasiswaName.toLowerCase().includes(searchTerm);
                });
                
                if (filteredMahasiswa.length > 0) {
                    filteredMahasiswa.forEach(pembimbing => {
                        const mahasiswaName = `${pembimbing.nama} (${pembimbing.nim})`;
                        const option = document.createElement('div');
                        option.className = 'px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm';
                        option.textContent = mahasiswaName;
                        option.onclick = () => selectMahasiswa(mahasiswaName);
                        dropdown.appendChild(option);
                    });
                } else {
                    const option = document.createElement('div');
                    option.className = 'px-3 py-2 text-gray-500 text-sm';
                    option.textContent = 'Tidak ada mahasiswa yang cocok';
                    dropdown.appendChild(option);
                }
            } else {
                const option = document.createElement('div');
                option.className = 'px-3 py-2 text-gray-500 text-sm';
                option.textContent = 'Belum ada mahasiswa bimbingan yang ditetapkan';
                dropdown.appendChild(option);
            }
            
            dropdown.classList.remove('hidden');
        }

        // Select mahasiswa from dropdown
        function selectMahasiswa(mahasiswa) {
            const input = document.getElementById('filterMahasiswaInput');
            const dropdown = document.getElementById('mahasiswaDropdown');
            const info = document.getElementById('selectedMahasiswaInfo');
            
            if (input) input.value = mahasiswa;
            if (dropdown) dropdown.classList.add('hidden');
            if (info) info.textContent = `Menampilkan riwayat: ${mahasiswa}`;
            
            selectedMahasiswaFilter = mahasiswa;
            
            // Update riwayat bimbingan with filter
            updateRiwayatBimbingan(null, mahasiswa);
        }

        // Clear filter
        function clearFilter() {
            const input = document.getElementById('filterMahasiswaInput');
            const dropdown = document.getElementById('mahasiswaDropdown');
            const info = document.getElementById('selectedMahasiswaInfo');
            
            if (input) input.value = '';
            if (dropdown) dropdown.classList.add('hidden');
            if (info) info.textContent = '';
            
            selectedMahasiswaFilter = null;
            
            // Update riwayat bimbingan without filter
            updateRiwayatBimbingan();
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('mahasiswaDropdown');
            const input = document.getElementById('filterMahasiswaInput');
            const dropdown2 = document.getElementById('mahasiswaOptions');
            const input2 = document.getElementById('mahasiswaSearchInput');
            
            if (dropdown && input && !dropdown.contains(event.target) && event.target !== input) {
                dropdown.classList.add('hidden');
            }
            
            if (dropdown2 && input2 && !dropdown2.contains(event.target) && event.target !== input2) {
                dropdown2.classList.add('hidden');
            }
        });
        
        // Print functionality with PDF support
        function printKartuBimbingan() {
            // Prevent default behavior
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            // Get the selected mahasiswa from filter or form
            let mahasiswa = selectedMahasiswaFilter;
            if (!mahasiswa) {
                const mahasiswaSelect = document.querySelector('#portalDosen form select');
                mahasiswa = mahasiswaSelect ? mahasiswaSelect.value : 'Ahmad Fauzi (2021001)';
            }
            
            // If no mahasiswa selected, show alert
            if (!mahasiswa || mahasiswa === '') {
                alert('Silakan pilih mahasiswa terlebih dahulu untuk mencetak kartu bimbingan!');
                return;
            }
            
            // Get filtered bimbingan data
            let bimbinganData = submissions.bimbingan.filter(b => b.mahasiswa === mahasiswa);
            let riwayatContent = '';
            
            if (bimbinganData.length > 0) {
                bimbinganData.forEach((bimbingan, index) => {
                    const bimbinganNum = index + 1;
                    const tanggal = bimbingan.tanggal || '';
                    const materi = bimbingan.materi || '';
                    const catatan = bimbingan.catatan || '';
                    
                    riwayatContent += `
                        <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #d1d5db; page-break-inside: avoid;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold;">
                                <span>Bimbingan #${bimbinganNum}</span>
                                <span>${tanggal}</span>
                            </div>
                            <div style="margin-bottom: 8px;">
                                <strong>Materi:</strong> ${materi}
                            </div>
                            <div>
                                <strong>Catatan:</strong> ${catatan}
                            </div>
                        </div>
                    `;
                });
            } else {
                riwayatContent = `
                    <div style="margin-bottom: 16px; padding: 12px; border: 1px solid #d1d5db; page-break-inside: avoid; text-align: center; color: #666;">
                        <p>Belum ada riwayat bimbingan untuk mahasiswa ini</p>
                    </div>
                `;
            }
            
            // Get current dosen name
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            const dosenNama = dosen ? dosen.nama : 'Dr. H. Abdullah, M.Pd.I';
            
            // Create print window with proper PDF styling
            const printWindow = window.open('', '_blank');
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Kartu Bimbingan Skripsi - ${mahasiswa}</title>
                    <style>
                        @page {
                            size: A4;
                            margin: 2cm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Times New Roman', serif;
                            font-size: 12pt;
                            line-height: 1.5;
                            color: #000;
                            background: white;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #000;
                            padding-bottom: 20px;
                        }
                        
                        .header h1 {
                            font-size: 18pt;
                            font-weight: bold;
                            margin-bottom: 5px;
                        }
                        
                        .header h2 {
                            font-size: 14pt;
                            font-weight: normal;
                        }
                        
                        .info-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        
                        .info-table td {
                            border: 1px solid #000;
                            padding: 8px 12px;
                            vertical-align: top;
                        }
                        
                        .info-table .label {
                            background-color: #f5f5f5;
                            font-weight: bold;
                            width: 30%;
                        }
                        
                        .section-title {
                            font-size: 14pt;
                            font-weight: bold;
                            margin: 30px 0 20px 0;
                            border-bottom: 1px solid #000;
                            padding-bottom: 5px;
                        }
                        
                        .bimbingan-item {
                            margin-bottom: 16px;
                            padding: 12px;
                            border: 1px solid #ccc;
                            page-break-inside: avoid;
                        }
                        
                        .bimbingan-header {
                            display: flex;
                            justify-content: space-between;
                            margin-bottom: 8px;
                            font-weight: bold;
                        }
                        
                        .bimbingan-content {
                            margin-bottom: 8px;
                        }
                        
                        .signatures {
                            margin-top: 50px;
                            display: flex;
                            justify-content: space-between;
                        }
                        
                        .signature-box {
                            text-align: center;
                            width: 45%;
                        }
                        
                        .signature-line {
                            border-top: 1px solid #000;
                            margin-top: 80px;
                            padding-top: 5px;
                        }
                        
                        .footer {
                            margin-top: 30px;
                            text-align: center;
                            font-size: 10pt;
                            color: #666;
                        }
                        
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            
                            .page-break {
                                page-break-before: always;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>KARTU BIMBINGAN SKRIPSI</h1>
                        <h2>STAI AL-MAS'UDIYAH SUKABUMI</h2>
                    </div>
                    
                    <table class="info-table">
                        <tr>
                            <td class="label">Nama Mahasiswa</td>
                            <td>${mahasiswa}</td>
                        </tr>
                        <tr>
                            <td class="label">Program Studi</td>
                            <td>Pendidikan Agama Islam</td>
                        </tr>
                        <tr>
                            <td class="label">Tahun Akademik</td>
                            <td>2024/2025</td>
                        </tr>
                        <tr>
                            <td class="label">Dosen Pembimbing</td>
                            <td>${dosenNama}</td>
                        </tr>
                    </table>
                    
                    <div class="section-title">RIWAYAT BIMBINGAN SKRIPSI</div>
                    
                    <div class="bimbingan-list">
                        ${riwayatContent}
                    </div>
                    
                    <div class="signatures">
                        <div class="signature-box">
                            <p>Mengetahui,</p>
                            <p style="margin-top: 10px;">Ketua Program Studi</p>
                            <div class="signature-line">
                                <p style="font-weight: bold;">Dr. H. Ahmad Syukri, M.Pd.I</p>
                                <p style="font-size: 10pt;">NIDN. 2108067801</p>
                            </div>
                        </div>
                        <div class="signature-box">
                            <p>Sukabumi, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                            <p style="margin-top: 10px;">Dosen Pembimbing</p>
                            <div class="signature-line">
                                <p style="font-weight: bold;">${dosenNama}</p>
                                <p style="font-size: 10pt;">NIDN. 2108067802</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="footer">
                        <p>Dicetak pada: ${new Date().toLocaleString('id-ID')}</p>
                        <p>Sistem Manajemen Skripsi - STAI Al-Mas'udiyah Sukabumi</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    
                    // Don't auto-close, let user close manually after printing/saving PDF
                    // This prevents the popup from closing automatically
                }, 500);
            };
        }

        // Data storage for accounts - loaded from Firebase
        let accounts = {
            mahasiswa: [],
            prodi: [],
            dosen: []
        };

        // Data storage for submissions and guidance - loaded from Firebase
        let submissions = {
            judulSkripsi: [],
            pengajuanSeminar: [],
            bimbingan: [],
            jadwalSeminar: [],
            jadwalMunaqosyah: [],
            munaqosyah: [],
            pembimbing: [],
            statusSkripsi: [], // New: untuk menyimpan status skripsi mahasiswa
            notifikasi: {
                mahasiswa: {},
                dosen: {},
                prodi: []
            }
        };

        // Dashboard statistics
        let dashboardStats = {
            totalMahasiswa: 0,
            skripsiSelesai: 0,
            dalamProses: 0
        };

        // Session management with unique session ID
        function generateSessionId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function createSession(type, identifier, userData) {
            const sessionId = generateSessionId();
            const sessionData = {
                sessionId: sessionId,
                type: type,
                identifier: identifier,
                userData: userData,
                timestamp: Date.now(),
                tabId: generateSessionId() // Unique for each tab
            };
            
            // Store in sessionStorage (tab-specific)
            sessionStorage.setItem(`${type}Login`, identifier);
            sessionStorage.setItem(`${type}Session`, JSON.stringify(sessionData));
            
            return sessionId;
        }

        function validateSession(type) {
            const loginData = sessionStorage.getItem(`${type}Login`);
            const sessionData = sessionStorage.getItem(`${type}Session`);
            
            if (!loginData || !sessionData) {
                return false;
            }
            
            try {
                const session = JSON.parse(sessionData);
                // Session expires after 8 hours of inactivity
                const maxAge = 8 * 60 * 60 * 1000; // 8 hours in milliseconds
                
                if (Date.now() - session.timestamp > maxAge) {
                    clearSession(type);
                    return false;
                }
                
                // Update timestamp for activity
                session.timestamp = Date.now();
                sessionStorage.setItem(`${type}Session`, JSON.stringify(session));
                
                return true;
            } catch (error) {
                clearSession(type);
                return false;
            }
        }

        function clearSession(type) {
            sessionStorage.removeItem(`${type}Login`);
            sessionStorage.removeItem(`${type}Session`);
        }

        // Login functionality with session management
        function loginMahasiswa() {
            const nim = document.getElementById('nimLogin').value;
            
            if (!nim) {
                alert('Mohon masukkan NIM Anda!');
                return;
            }
            
            // Check if NIM exists and is active
            const mahasiswa = accounts.mahasiswa.find(m => m.nim === nim && m.status === 'aktif');
            if (!mahasiswa) {
                alert('NIM tidak ditemukan atau akun tidak aktif!');
                return;
            }
            
            // Create new session
            createSession('mahasiswa', nim, mahasiswa);
            
            // Hide login form and show portal
            document.getElementById('loginMahasiswa').classList.add('hidden');
            document.getElementById('portalMahasiswa').classList.remove('hidden');
            document.getElementById('welcomeMahasiswa').textContent = `Selamat datang, ${mahasiswa.nama}`;
            
            // Update notifications and rekapitulasi
            updateMahasiswaNotifications();
            updateRekapPengajuanSeminar();
        }
        
        function logoutMahasiswa() {
            clearSession('mahasiswa');
            document.getElementById('loginMahasiswa').classList.remove('hidden');
            document.getElementById('portalMahasiswa').classList.add('hidden');
            document.getElementById('nimLogin').value = '';
        }
        
        function loginProdi() {
            const username = document.getElementById('usernameProdi').value;
            const password = document.getElementById('passwordProdi').value;
            
            if (!username || !password) {
                alert('Mohon masukkan username dan password!');
                return;
            }
            
            // Check credentials
            const prodi = accounts.prodi.find(p => p.username === username && p.password === password && p.status === 'aktif');
            if (prodi) {
                // Create new session
                createSession('prodi', username, prodi);
                
                document.getElementById('loginProdi').classList.add('hidden');
                document.getElementById('portalProdi').classList.remove('hidden');
                document.getElementById('welcomeProdi').textContent = `Selamat datang, ${prodi.nama}`;
                
                // Update tables and notifications
                updateJudulValidasiTable();
                updateRekapJadwalSeminar();
                updateProdiNotifications();
                updateRekapPengajuanSeminar();
            } else {
                alert('Username atau password salah atau akun tidak aktif!');
            }
        }
        
        function logoutProdi() {
            clearSession('prodi');
            document.getElementById('loginProdi').classList.remove('hidden');
            document.getElementById('portalProdi').classList.add('hidden');
            document.getElementById('usernameProdi').value = '';
            document.getElementById('passwordProdi').value = '';
        }
        
        function loginDosen() {
            const username = document.getElementById('usernameDosen').value;
            const password = document.getElementById('passwordDosen').value;
            
            if (!username || !password) {
                alert('Mohon masukkan username dan password!');
                return;
            }
            
            // Check credentials
            const dosen = accounts.dosen.find(d => d.username === username && d.password === password && d.status === 'aktif');
            if (dosen) {
                // Create new session
                createSession('dosen', username, dosen);
                
                document.getElementById('loginDosen').classList.add('hidden');
                document.getElementById('portalDosen').classList.remove('hidden');
                document.getElementById('welcomeDosen').textContent = `Selamat datang, ${dosen.nama}`;
                
                // Update notifications and tables
                updateDosenNotifications();
                updatePersetujuanDosenTable();
                updateDropdownOptions();
            } else {
                alert('Username atau password salah atau akun tidak aktif!');
            }
        }
        
        function logoutDosen() {
            clearSession('dosen');
            document.getElementById('loginDosen').classList.remove('hidden');
            document.getElementById('portalDosen').classList.add('hidden');
            document.getElementById('usernameDosen').value = '';
            document.getElementById('passwordDosen').value = '';
        }

        // Manajemen login functions
        function loginManajemen() {
            const username = document.getElementById('usernameManajemen').value;
            const password = document.getElementById('passwordManajemen').value;
            
            if (!username || !password) {
                alert('Mohon masukkan username dan password!');
                return;
            }
            
            // Demo admin credentials
            if (username === 'admin' && password === 'admin123') {
                // Create new session
                createSession('manajemen', username, { username: username, nama: 'Administrator' });
                
                document.getElementById('loginManajemen').classList.add('hidden');
                document.getElementById('portalManajemen').classList.remove('hidden');
                document.getElementById('welcomeManajemen').textContent = `Selamat datang, Administrator`;
                showManajemenTab('mahasiswa');
            } else {
                alert('Username atau password salah! (Demo: admin/admin123)');
            }
        }
        
        function logoutManajemen() {
            clearSession('manajemen');
            document.getElementById('loginManajemen').classList.remove('hidden');
            document.getElementById('portalManajemen').classList.add('hidden');
            document.getElementById('usernameManajemen').value = '';
            document.getElementById('passwordManajemen').value = '';
        }

        // Tab management for manajemen
        function showManajemenTab(tabName) {
            // Prevent default behavior if called from event
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.add('hidden'));
            
            // Show selected tab
            document.getElementById('tab' + tabName.charAt(0).toUpperCase() + tabName.slice(1)).classList.remove('hidden');
            
            // Update tab buttons safely
            if (event && event.target) {
                const tabButtons = document.querySelectorAll('.tab-btn');
                tabButtons.forEach(btn => {
                    btn.classList.remove('border-blue-500', 'text-blue-600');
                    btn.classList.add('border-transparent', 'text-gray-500');
                });
                
                event.target.classList.remove('border-transparent', 'text-gray-500');
                event.target.classList.add('border-blue-500', 'text-blue-600');
            }
        }

        // Account management functions
        async function tambahMahasiswa() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const nim = document.getElementById('newNim').value;
            const nama = document.getElementById('newNamaMhs').value;
            
            if (!nim || !nama) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Check if NIM already exists
            if (accounts.mahasiswa.find(m => m.nim === nim)) {
                alert('NIM sudah terdaftar!');
                return;
            }
            
            const newMahasiswa = { nim, nama, status: 'aktif', createdAt: new Date() };
            
            try {
                // Save to Firebase
                const docRef = await addDoc(collection(db, 'accounts_mahasiswa'), newMahasiswa);
                
                // Add to local array with Firebase ID
                accounts.mahasiswa.push({ id: docRef.id, ...newMahasiswa });
                
                alert('Akun mahasiswa berhasil ditambahkan!');
            } catch (error) {
                console.log('Firebase error, saving locally');
                accounts.mahasiswa.push(newMahasiswa);
                saveLocalData();
                alert('Akun mahasiswa berhasil ditambahkan!');
            }
            
            // Update displays
            updateMahasiswaTable();
            updateDropdownOptions();
            updateDashboardStats();
            
            // Clear form
            document.getElementById('newNim').value = '';
            document.getElementById('newNamaMhs').value = '';
        }

        async function tambahProdi() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const username = document.getElementById('newUsernameProdi').value;
            const password = document.getElementById('newPasswordProdi').value;
            const nama = document.getElementById('newNamaProdi').value;
            
            if (!username || !password || !nama) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Check if username already exists
            if (accounts.prodi.find(p => p.username === username)) {
                alert('Username sudah terdaftar!');
                return;
            }
            
            const newProdi = { username, password, nama, status: 'aktif', createdAt: new Date() };
            
            try {
                // Save to Firebase
                const docRef = await addDoc(collection(db, 'accounts_prodi'), newProdi);
                
                // Add to local array with Firebase ID
                accounts.prodi.push({ id: docRef.id, ...newProdi });
                
                alert('Akun program studi berhasil ditambahkan!');
            } catch (error) {
                console.log('Firebase error, saving locally');
                accounts.prodi.push(newProdi);
                saveLocalData();
                alert('Akun program studi berhasil ditambahkan!');
            }
            
            // Update table
            updateProdiTable();
            
            // Clear form
            document.getElementById('newUsernameProdi').value = '';
            document.getElementById('newPasswordProdi').value = '';
            document.getElementById('newNamaProdi').value = '';
        }

        async function tambahDosen() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const username = document.getElementById('newUsernameDosen').value;
            const password = document.getElementById('newPasswordDosen').value;
            const nama = document.getElementById('newNamaDosen').value;
            
            if (!username || !password || !nama) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Check if username already exists
            if (accounts.dosen.find(d => d.username === username)) {
                alert('Username sudah terdaftar!');
                return;
            }
            
            const newDosen = { username, password, nama, status: 'aktif', createdAt: new Date() };
            
            try {
                // Save to Firebase
                const docRef = await addDoc(collection(db, 'accounts_dosen'), newDosen);
                
                // Add to local array with Firebase ID
                accounts.dosen.push({ id: docRef.id, ...newDosen });
                
                alert('Akun dosen berhasil ditambahkan!');
            } catch (error) {
                console.log('Firebase error, saving locally');
                accounts.dosen.push(newDosen);
                saveLocalData();
                alert('Akun dosen berhasil ditambahkan!');
            }
            
            // Update displays
            updateDosenTable();
            updateDropdownOptions();
            
            // Clear form
            document.getElementById('newUsernameDosen').value = '';
            document.getElementById('newPasswordDosen').value = '';
            document.getElementById('newNamaDosen').value = '';
        }

        // Update table functions
        function updateMahasiswaTable() {
            const tbody = document.getElementById('mahasiswaTable');
            tbody.innerHTML = '';
            
            accounts.mahasiswa.forEach(mhs => {
                const row = document.createElement('tr');
                const statusClass = mhs.status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const toggleText = mhs.status === 'aktif' ? 'Nonaktifkan' : 'Aktifkan';
                const toggleClass = mhs.status === 'aktif' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${mhs.nim}</td>
                    <td class="px-4 py-3 text-sm">${mhs.nama}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${mhs.status.charAt(0).toUpperCase() + mhs.status.slice(1)}</span></td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editMahasiswa('${mhs.nim}')" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Edit</button>
                            <button onclick="toggleStatusMahasiswa('${mhs.nim}', '${mhs.status}')" class="px-3 py-1 ${toggleClass} text-white rounded text-xs">${toggleText}</button>
                            <button onclick="hapusMahasiswa('${mhs.nim}')" class="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">Hapus</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateProdiTable() {
            const tbody = document.getElementById('prodiTable');
            tbody.innerHTML = '';
            
            accounts.prodi.forEach(prodi => {
                const row = document.createElement('tr');
                const statusClass = prodi.status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const toggleText = prodi.status === 'aktif' ? 'Nonaktifkan' : 'Aktifkan';
                const toggleClass = prodi.status === 'aktif' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${prodi.username}</td>
                    <td class="px-4 py-3 text-sm">${prodi.nama}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${prodi.status.charAt(0).toUpperCase() + prodi.status.slice(1)}</span></td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editProdi('${prodi.username}')" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Edit</button>
                            <button onclick="toggleStatusProdi('${prodi.username}', '${prodi.status}')" class="px-3 py-1 ${toggleClass} text-white rounded text-xs">${toggleText}</button>
                            <button onclick="hapusProdi('${prodi.username}')" class="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">Hapus</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function updateDosenTable() {
            const tbody = document.getElementById('dosenTable');
            tbody.innerHTML = '';
            
            accounts.dosen.forEach(dosen => {
                const row = document.createElement('tr');
                const statusClass = dosen.status === 'aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const toggleText = dosen.status === 'aktif' ? 'Nonaktifkan' : 'Aktifkan';
                const toggleClass = dosen.status === 'aktif' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${dosen.username}</td>
                    <td class="px-4 py-3 text-sm">${dosen.nama}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${dosen.status.charAt(0).toUpperCase() + dosen.status.slice(1)}</span></td>
                    <td class="px-4 py-3">
                        <div class="flex space-x-2">
                            <button onclick="editDosen('${dosen.username}')" class="px-3 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700">Edit</button>
                            <button onclick="toggleStatusDosen('${dosen.username}', '${dosen.status}')" class="px-3 py-1 ${toggleClass} text-white rounded text-xs">${toggleText}</button>
                            <button onclick="hapusDosen('${dosen.username}')" class="px-3 py-1 bg-gray-600 text-white rounded text-xs hover:bg-gray-700">Hapus</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Action functions
        function editMahasiswa(nim) {
            const mahasiswa = accounts.mahasiswa.find(m => m.nim === nim);
            if (mahasiswa) {
                const newNama = prompt('Edit nama mahasiswa:', mahasiswa.nama);
                if (newNama && newNama !== mahasiswa.nama) {
                    mahasiswa.nama = newNama;
                    updateMahasiswaTable();
                    updateDropdownOptions();
                    alert('Data mahasiswa berhasil diupdate!');
                }
            }
        }

        function toggleStatusMahasiswa(nim, currentStatus) {
            const mahasiswa = accounts.mahasiswa.find(m => m.nim === nim);
            if (mahasiswa) {
                mahasiswa.status = currentStatus === 'aktif' ? 'nonaktif' : 'aktif';
                updateMahasiswaTable();
                updateDropdownOptions();
                alert(`Status mahasiswa berhasil diubah menjadi ${mahasiswa.status}!`);
            }
        }

        function hapusMahasiswa(nim) {
            if (confirm('Yakin ingin menghapus akun mahasiswa ini?')) {
                accounts.mahasiswa = accounts.mahasiswa.filter(m => m.nim !== nim);
                updateMahasiswaTable();
                updateDropdownOptions();
                alert('Akun mahasiswa berhasil dihapus!');
            }
        }

        function editProdi(username) {
            const prodi = accounts.prodi.find(p => p.username === username);
            if (prodi) {
                const newNama = prompt('Edit nama:', prodi.nama);
                const newPassword = prompt('Edit password:', prodi.password);
                if (newNama) prodi.nama = newNama;
                if (newPassword) prodi.password = newPassword;
                updateProdiTable();
                alert('Data program studi berhasil diupdate!');
            }
        }

        function toggleStatusProdi(username, currentStatus) {
            const prodi = accounts.prodi.find(p => p.username === username);
            if (prodi) {
                prodi.status = currentStatus === 'aktif' ? 'nonaktif' : 'aktif';
                updateProdiTable();
                alert(`Status akun berhasil diubah menjadi ${prodi.status}!`);
            }
        }

        function hapusProdi(username) {
            if (confirm('Yakin ingin menghapus akun program studi ini?')) {
                accounts.prodi = accounts.prodi.filter(p => p.username !== username);
                updateProdiTable();
                alert('Akun program studi berhasil dihapus!');
            }
        }

        function editDosen(username) {
            const dosen = accounts.dosen.find(d => d.username === username);
            if (dosen) {
                const newNama = prompt('Edit nama:', dosen.nama);
                const newPassword = prompt('Edit password:', dosen.password);
                if (newNama) dosen.nama = newNama;
                if (newPassword) dosen.password = newPassword;
                updateDosenTable();
                updateDropdownOptions();
                alert('Data dosen berhasil diupdate!');
            }
        }

        function toggleStatusDosen(username, currentStatus) {
            const dosen = accounts.dosen.find(d => d.username === username);
            if (dosen) {
                dosen.status = currentStatus === 'aktif' ? 'nonaktif' : 'aktif';
                updateDosenTable();
                updateDropdownOptions();
                alert(`Status akun berhasil diubah menjadi ${dosen.status}!`);
            }
        }

        function hapusDosen(username) {
            if (confirm('Yakin ingin menghapus akun dosen ini?')) {
                accounts.dosen = accounts.dosen.filter(d => d.username !== username);
                updateDosenTable();
                updateDropdownOptions();
                alert('Akun dosen berhasil dihapus!');
            }
        }

        // Navigation functionality
        function showPage(pageId) {
            // Prevent default behavior if called from event
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            // Hide all pages
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(pageId).classList.remove('hidden');
            
            // Check login status when switching pages with session validation
            if (pageId === 'mahasiswa') {
                if (validateSession('mahasiswa')) {
                    const mahasiswaLogin = sessionStorage.getItem('mahasiswaLogin');
                    const mahasiswa = accounts.mahasiswa.find(m => m.nim === mahasiswaLogin);
                    if (mahasiswa) {
                        document.getElementById('loginMahasiswa').classList.add('hidden');
                        document.getElementById('portalMahasiswa').classList.remove('hidden');
                        document.getElementById('welcomeMahasiswa').textContent = `Selamat datang, ${mahasiswa.nama}`;
                        updateMahasiswaNotifications();
                    } else {
                        document.getElementById('loginMahasiswa').classList.remove('hidden');
                        document.getElementById('portalMahasiswa').classList.add('hidden');
                    }
                } else {
                    document.getElementById('loginMahasiswa').classList.remove('hidden');
                    document.getElementById('portalMahasiswa').classList.add('hidden');
                }
            } else if (pageId === 'prodi') {
                if (validateSession('prodi')) {
                    const prodiLogin = sessionStorage.getItem('prodiLogin');
                    const prodi = accounts.prodi.find(p => p.username === prodiLogin);
                    if (prodi) {
                        document.getElementById('loginProdi').classList.add('hidden');
                        document.getElementById('portalProdi').classList.remove('hidden');
                        document.getElementById('welcomeProdi').textContent = `Selamat datang, ${prodi.nama}`;
                        updateJudulValidasiTable();
                    } else {
                        document.getElementById('loginProdi').classList.remove('hidden');
                        document.getElementById('portalProdi').classList.add('hidden');
                    }
                } else {
                    document.getElementById('loginProdi').classList.remove('hidden');
                    document.getElementById('portalProdi').classList.add('hidden');
                }
            } else if (pageId === 'dosen') {
                if (validateSession('dosen')) {
                    const dosenLogin = sessionStorage.getItem('dosenLogin');
                    const dosen = accounts.dosen.find(d => d.username === dosenLogin);
                    if (dosen) {
                        document.getElementById('loginDosen').classList.add('hidden');
                        document.getElementById('portalDosen').classList.remove('hidden');
                        document.getElementById('welcomeDosen').textContent = `Selamat datang, ${dosen.nama}`;
                        updateDosenNotifications();
                        updatePersetujuanDosenTable();
                    } else {
                        document.getElementById('loginDosen').classList.remove('hidden');
                        document.getElementById('portalDosen').classList.add('hidden');
                    }
                } else {
                    document.getElementById('loginDosen').classList.remove('hidden');
                    document.getElementById('portalDosen').classList.add('hidden');
                }
            } else if (pageId === 'manajemen') {
                if (validateSession('manajemen')) {
                    document.getElementById('loginManajemen').classList.add('hidden');
                    document.getElementById('portalManajemen').classList.remove('hidden');
                    document.getElementById('welcomeManajemen').textContent = `Selamat datang, Administrator`;
                    showManajemenTab('mahasiswa');
                } else {
                    document.getElementById('loginManajemen').classList.remove('hidden');
                    document.getElementById('portalManajemen').classList.add('hidden');
                }
            }
            
            // Update navigation buttons safely
            if (event && event.target) {
                const navButtons = document.querySelectorAll('.nav-btn');
                navButtons.forEach(btn => {
                    btn.classList.remove('bg-blue-600', 'text-white');
                    btn.classList.add('text-gray-600', 'hover:bg-blue-50');
                });
                
                event.target.classList.remove('text-gray-600', 'hover:bg-blue-50');
                event.target.classList.add('bg-blue-600', 'text-white');
            }
        }

        // Mahasiswa functions
        async function submitJudul() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const form = event ? event.target.closest('form') : document.querySelector('#portalMahasiswa form');
            const nim = form.querySelector('input[placeholder="Masukkan NIM"]').value;
            const nama = form.querySelector('input[placeholder="Masukkan nama lengkap"]').value;
            const judul = form.querySelector('textarea[placeholder="Masukkan judul skripsi yang diajukan"]').value;
            const latarBelakang = form.querySelector('textarea[placeholder="Jelaskan latar belakang penelitian"]').value;
            
            if (!nim || !nama || !judul) {
                alert('Mohon lengkapi semua field yang wajib diisi!');
                return;
            }
            
            // Add to local storage
            const newSubmission = {
                id: Date.now().toString(),
                nim: nim,
                nama: nama,
                judul: judul,
                latarBelakang: latarBelakang,
                status: 'Menunggu',
                tanggalPengajuan: new Date().toLocaleDateString('id-ID')
            };
            
            submissions.judulSkripsi.push(newSubmission);
            
            try {
                await addDoc(collection(db, 'pengajuan_judul'), {
                    nim: nim,
                    nama: nama,
                    judul: judul,
                    latarBelakang: latarBelakang,
                    status: 'Menunggu',
                    tanggalPengajuan: new Date().toISOString(),
                    timestamp: new Date()
                });
            } catch (error) {
                console.log('Demo mode - data saved locally');
            }
            
            alert('Judul skripsi berhasil diajukan! Menunggu validasi dari Program Studi.');
            form.reset();
            
            // Update status display
            const statusDiv = document.getElementById('statusPengajuan');
            statusDiv.innerHTML = `
                <div class="p-4 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium text-yellow-800">Menunggu Validasi Prodi</p>
                            <p class="text-sm text-yellow-600">Diajukan: ${new Date().toLocaleDateString('id-ID')}</p>
                        </div>
                        <span class="px-3 py-1 bg-yellow-200 text-yellow-800 rounded-full text-sm">Pending</span>
                    </div>
                </div>
            `;
            
            // Update prodi table if prodi is logged in
            updateJudulValidasiTable();
        }

        async function submitSeminar() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const nim = document.getElementById('nimSeminar').value;
            const tanggal = document.getElementById('tanggalSeminar').value;
            const catatanProposal = document.getElementById('catatanProposal').value;
            
            if (!nim || !tanggal || !catatanProposal) {
                alert('Mohon lengkapi semua field yang wajib diisi!');
                return;
            }
            
            // Find mahasiswa name
            const mahasiswa = accounts.mahasiswa.find(m => m.nim === nim);
            if (!mahasiswa) {
                alert('NIM tidak ditemukan!');
                return;
            }
            
            // Create pengajuan seminar
            const pengajuanBaru = {
                id: Date.now().toString(),
                nim: nim,
                nama: mahasiswa.nama,
                tanggalPengajuan: tanggal,
                tanggalSubmit: new Date().toLocaleDateString('id-ID'),
                catatanProposal: catatanProposal,
                status: 'Menunggu Penjadwalan'
            };
            
            // Add to local storage
            submissions.pengajuanSeminar.push(pengajuanBaru);
            
            // Add notification for prodi
            submissions.notifikasi.prodi.push({
                id: Date.now().toString(),
                type: 'pengajuan_seminar',
                message: 'Pengajuan seminar proposal baru',
                nim: nim,
                nama: mahasiswa.nama,
                tanggal: new Date().toLocaleDateString('id-ID'),
                waktu: new Date().toLocaleTimeString('id-ID')
            });
            
            try {
                await addDoc(collection(db, 'pengajuan_seminar'), pengajuanBaru);
                
                alert('Pengajuan seminar proposal berhasil disubmit! Menunggu penjadwalan dari Program Studi.');
            } catch (error) {
                console.log('Demo mode - data saved locally');
                alert('Pengajuan seminar proposal berhasil disubmit! Menunggu penjadwalan dari Program Studi.');
            }
            
            // Clear form
            document.getElementById('nimSeminar').value = '';
            document.getElementById('tanggalSeminar').value = '';
            document.getElementById('catatanProposal').value = '';
            
            // Update rekapitulasi and notifications
            updateRekapPengajuanSeminar();
            updateProdiNotifications();
        }

        async function submitMunaqosyah() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const form = event ? event.target.closest('form') : document.querySelector('#portalMahasiswa form:last-of-type');
            const nim = form.querySelector('input[placeholder="Masukkan NIM"]').value;
            const jumlahBimbingan = form.querySelector('input[type="number"]').value;
            const catatanSkripsi = document.getElementById('catatanSkripsi').value;
            const catatanKartuBimbingan = document.getElementById('catatanKartuBimbingan').value;
            
            if (!nim || !jumlahBimbingan || jumlahBimbingan < 12) {
                alert('Mohon lengkapi semua field dan pastikan minimal 12 kali bimbingan!');
                return;
            }
            
            // Find mahasiswa name
            const mahasiswa = accounts.mahasiswa.find(m => m.nim === nim);
            if (!mahasiswa) {
                alert('NIM tidak ditemukan!');
                return;
            }
            
            // Create munaqosyah submission
            const munaqosyahBaru = {
                id: Date.now().toString(),
                nim: nim,
                nama: mahasiswa.nama,
                jumlahBimbingan: parseInt(jumlahBimbingan),
                catatanSkripsi: catatanSkripsi,
                catatanKartuBimbingan: catatanKartuBimbingan,
                status: 'Menunggu Penjadwalan',
                tanggalPengajuan: new Date().toLocaleDateString('id-ID'),
                timestamp: new Date()
            };
            
            // Add to local storage
            submissions.munaqosyah.push(munaqosyahBaru);
            
            // Add notification for prodi
            submissions.notifikasi.prodi.push({
                id: Date.now().toString(),
                type: 'pengajuan_munaqosyah',
                message: 'Pengajuan sidang munaqosyah baru',
                nim: nim,
                nama: mahasiswa.nama,
                tanggal: new Date().toLocaleDateString('id-ID'),
                waktu: new Date().toLocaleTimeString('id-ID')
            });
            
            try {
                await addDoc(collection(db, 'pengajuan_munaqosyah'), munaqosyahBaru);
                
                // Save notification to Firebase
                await addDoc(collection(db, 'notifikasi'), {
                    type: 'pengajuan_munaqosyah',
                    message: 'Pengajuan sidang munaqosyah baru',
                    nim: nim,
                    nama: mahasiswa.nama,
                    timestamp: new Date()
                });
                
                alert('Pengajuan sidang munaqosyah berhasil disubmit! Menunggu penjadwalan dari Program Studi.');
            } catch (error) {
                console.log('Demo mode - data saved locally');
                saveLocalData();
                alert('Pengajuan sidang munaqosyah berhasil disubmit! Menunggu penjadwalan dari Program Studi.');
            }
            
            form.reset();
            
            // Update prodi notifications
            updateProdiNotifications();
        }

        // Program Studi functions
        async function validasiJudul(status, docId) {
            // Prevent default behavior
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            let message = '';
            let statusText = '';
            let statusClass = '';
            let catatan = '';
            
            if (status === 'terima') {
                message = 'Judul skripsi disetujui!';
                statusText = 'Disetujui';
                statusClass = 'bg-green-100 text-green-800';
            } else if (status === 'perbaiki') {
                catatan = prompt('Masukkan catatan perbaikan untuk mahasiswa:');
                if (!catatan) return;
                message = 'Judul perlu diperbaiki. Catatan telah dikirim ke mahasiswa.';
                statusText = 'Perlu Perbaikan';
                statusClass = 'bg-yellow-100 text-yellow-800';
            } else {
                catatan = prompt('Masukkan alasan penolakan:');
                if (!catatan) return;
                message = 'Judul ditolak. Alasan telah dikirim ke mahasiswa.';
                statusText = 'Ditolak';
                statusClass = 'bg-red-100 text-red-800';
            }
            
            // Get mahasiswa info from table row
            const row = event ? event.target.closest('tr') : null;
            if (!row) return;
            
            const nim = row.querySelector('td:nth-child(2)').textContent;
            const nama = row.querySelector('td:nth-child(3)').textContent;
            
            // Update local storage
            const submission = submissions.judulSkripsi.find(s => s.id === docId || s.nim === nim);
            if (submission) {
                submission.status = statusText;
                submission.tanggalValidasi = new Date().toLocaleDateString('id-ID');
                submission.validator = 'Program Studi';
                submission.catatan = catatan;
            }
            
            // Add notification for mahasiswa
            if (!submissions.notifikasi.mahasiswa[nim]) {
                submissions.notifikasi.mahasiswa[nim] = [];
            }
            submissions.notifikasi.mahasiswa[nim].push({
                id: Date.now().toString(),
                type: 'validasi_judul',
                status: statusText,
                message: `Judul skripsi Anda ${statusText.toLowerCase()}`,
                catatan: catatan,
                tanggal: new Date().toLocaleDateString('id-ID'),
                waktu: new Date().toLocaleTimeString('id-ID')
            });
            
            try {
                // Save to Firebase
                await updateDoc(doc(db, 'pengajuan_judul', docId), {
                    status: statusText,
                    tanggalValidasi: new Date().toISOString(),
                    validator: 'Program Studi',
                    catatan: catatan
                });
                
                // Save notification to Firebase
                await addDoc(collection(db, 'notifikasi'), {
                    nim: nim,
                    nama: nama,
                    type: 'validasi_judul',
                    status: statusText,
                    message: `Judul skripsi Anda ${statusText.toLowerCase()}`,
                    catatan: catatan,
                    timestamp: new Date()
                });
            } catch (error) {
                console.log('Demo mode - validation saved locally');
            }
            
            alert(message);
            
            // Update table status
            const statusCell = row.querySelector('td:nth-child(4)');
            statusCell.innerHTML = `<span class="px-2 py-1 ${statusClass} rounded-full text-xs">${statusText}</span>`;
            
            // Update action buttons
            const actionCell = row.querySelector('td:nth-child(5)');
            actionCell.innerHTML = `<span class="text-gray-500 text-xs">Sudah divalidasi</span>`;
            
            // Update mahasiswa notifications if logged in
            updateMahasiswaNotifications();
        }

        // Checkbox functions
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.judul-checkbox');
            
            checkboxes.forEach(checkbox => {
                if (!checkbox.disabled) {
                    checkbox.checked = selectAll.checked;
                }
            });
        }
        
        function validasiMassal(status) {
            const checkboxes = document.querySelectorAll('.judul-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Pilih minimal satu pengajuan untuk divalidasi!');
                return;
            }
            
            let catatan = '';
            if (status === 'tolak') {
                catatan = prompt('Masukkan alasan penolakan untuk semua pengajuan yang dipilih:');
                if (!catatan) return;
            }
            
            const selectedData = [];
            checkboxes.forEach(checkbox => {
                const nim = checkbox.getAttribute('data-nim');
                const nama = checkbox.getAttribute('data-nama');
                selectedData.push({ nim, nama });
            });
            
            // Process validation
            selectedData.forEach(data => {
                // Update local storage
                const submission = submissions.judulSkripsi.find(s => s.nim === data.nim);
                if (submission) {
                    submission.status = status === 'terima' ? 'Disetujui' : 'Ditolak';
                    submission.tanggalValidasi = new Date().toLocaleDateString('id-ID');
                    submission.validator = 'Program Studi';
                    submission.catatan = catatan;
                }
                
                // Add notification for mahasiswa
                if (!submissions.notifikasi.mahasiswa[data.nim]) {
                    submissions.notifikasi.mahasiswa[data.nim] = [];
                }
                submissions.notifikasi.mahasiswa[data.nim].push({
                    id: Date.now().toString() + data.nim,
                    type: 'validasi_judul',
                    status: status === 'terima' ? 'Disetujui' : 'Ditolak',
                    message: `Judul skripsi Anda ${status === 'terima' ? 'disetujui' : 'ditolak'}`,
                    catatan: catatan,
                    tanggal: new Date().toLocaleDateString('id-ID'),
                    waktu: new Date().toLocaleTimeString('id-ID')
                });
            });
            
            const statusText = status === 'terima' ? 'disetujui' : 'ditolak';
            alert(`${selectedData.length} pengajuan berhasil ${statusText}!`);
            
            // Update table
            updateJudulValidasiTable();
            updateMahasiswaNotifications();
            
            // Uncheck select all
            document.getElementById('selectAll').checked = false;
        }

        function updateJudulValidasiTable() {
            const tbody = document.getElementById('judulTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (submissions.judulSkripsi.length > 0) {
                submissions.judulSkripsi.forEach(submission => {
                    const row = document.createElement('tr');
                    let statusClass = 'bg-yellow-100 text-yellow-800';
                    if (submission.status === 'Disetujui') statusClass = 'bg-green-100 text-green-800';
                    else if (submission.status === 'Ditolak') statusClass = 'bg-red-100 text-red-800';
                    else if (submission.status === 'Perlu Perbaikan') statusClass = 'bg-yellow-100 text-yellow-800';
                    
                    const checkboxHtml = `<input type="checkbox" class="judul-checkbox" data-nim="${submission.nim}" data-nama="${submission.nama}" data-id="${submission.id}">`;
                    
                    row.innerHTML = `
                        <td class="px-4 py-3">${checkboxHtml}</td>
                        <td class="px-4 py-3 text-sm">${submission.nim}</td>
                        <td class="px-4 py-3 text-sm">${submission.nama}</td>
                        <td class="px-4 py-3 text-sm">${submission.judul}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${submission.status}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Belum ada pengajuan judul skripsi</td></tr>';
            }
        }

        async function buatJadwalSeminar() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const form = event ? event.target.closest('form') : document.querySelector('#portalProdi form');
            const mahasiswa = form.querySelector('select').value;
            const tanggal = form.querySelector('input[type="datetime-local"]').value;
            const ruangan = form.querySelector('input[placeholder="Ruang 101"]').value;
            const penguji1 = form.querySelectorAll('select')[1].value;
            const penguji2 = form.querySelectorAll('select')[2].value;
            
            if (!mahasiswa || !tanggal || !ruangan || !penguji1 || !penguji2) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Extract NIM from mahasiswa string (format: "Nama (NIM)")
            const nimMatch = mahasiswa.match(/\((\d+)\)/);
            const nim = nimMatch ? nimMatch[1] : '';
            const nama = mahasiswa.split(' (')[0];
            
            // Create jadwal object
            const jadwalBaru = {
                id: Date.now().toString(),
                mahasiswa: mahasiswa,
                nim: nim,
                nama: nama,
                tanggal: tanggal,
                ruangan: ruangan,
                penguji1: penguji1,
                penguji2: penguji2,
                status: 'Terjadwal',
                tanggalBuat: new Date().toLocaleDateString('id-ID')
            };
            
            // Add to local storage
            submissions.jadwalSeminar.push(jadwalBaru);
            
            // Add notification for mahasiswa
            if (!submissions.notifikasi.mahasiswa[nim]) {
                submissions.notifikasi.mahasiswa[nim] = [];
            }
            submissions.notifikasi.mahasiswa[nim].push({
                id: Date.now().toString(),
                type: 'jadwal_seminar',
                message: 'Jadwal seminar proposal Anda telah ditetapkan',
                tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                waktu: new Date(tanggal).toLocaleTimeString('id-ID'),
                ruangan: ruangan,
                penguji1: penguji1,
                penguji2: penguji2,
                tanggalNotif: new Date().toLocaleDateString('id-ID')
            });
            
            // Add notification for dosen
            [penguji1, penguji2].forEach(dosen => {
                if (!submissions.notifikasi.dosen[dosen]) {
                    submissions.notifikasi.dosen[dosen] = [];
                }
                submissions.notifikasi.dosen[dosen].push({
                    id: Date.now().toString(),
                    type: 'jadwal_seminar',
                    message: `Anda ditugaskan sebagai penguji seminar proposal`,
                    mahasiswa: nama,
                    nim: nim,
                    tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                    waktu: new Date(tanggal).toLocaleTimeString('id-ID'),
                    ruangan: ruangan,
                    tanggalNotif: new Date().toLocaleDateString('id-ID')
                });
            });
            
            try {
                // Save to Firebase
                await addDoc(collection(db, 'jadwal_seminar'), jadwalBaru);
                
                // Save notifications to Firebase
                await addDoc(collection(db, 'notifikasi'), {
                    nim: nim,
                    nama: nama,
                    type: 'jadwal_seminar',
                    message: 'Jadwal seminar proposal Anda telah ditetapkan',
                    tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                    waktu: new Date(tanggal).toLocaleTimeString('id-ID'),
                    ruangan: ruangan,
                    penguji1: penguji1,
                    penguji2: penguji2,
                    timestamp: new Date()
                });
            } catch (error) {
                console.log('Demo mode - jadwal saved locally');
            }
            
            alert(`Jadwal seminar proposal berhasil dibuat!\n\nMahasiswa: ${mahasiswa}\nTanggal: ${new Date(tanggal).toLocaleString('id-ID')}\nRuangan: ${ruangan}\nPenguji 1: ${penguji1}\nPenguji 2: ${penguji2}\n\nNotifikasi telah dikirim ke mahasiswa dan dosen penguji.`);
            form.reset();
            
            // Update rekapitulasi table
            updateRekapJadwalSeminar();
            
            // Update notifications
            updateMahasiswaNotifications();
            updateDosenNotifications();
        }

        // Search mahasiswa functions for penetapan pembimbing
        function showMahasiswaOptions() {
            const dropdown = document.getElementById('mahasiswaOptions');
            const input = document.getElementById('mahasiswaSearchInput');
            
            if (!dropdown || !input) return;
            
            // Get active mahasiswa
            const activeMahasiswa = accounts.mahasiswa.filter(m => m.status === 'aktif');
            
            dropdown.innerHTML = '';
            
            if (activeMahasiswa.length > 0) {
                activeMahasiswa.forEach(mahasiswa => {
                    if (mahasiswa.nama.toLowerCase().includes(input.value.toLowerCase())) {
                        const option = document.createElement('div');
                        option.className = 'px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm';
                        option.textContent = `${mahasiswa.nama} (${mahasiswa.nim})`;
                        option.onclick = () => selectMahasiswaOption(mahasiswa.nim, mahasiswa.nama);
                        dropdown.appendChild(option);
                    }
                });
            } else {
                const option = document.createElement('div');
                option.className = 'px-3 py-2 text-gray-500 text-sm';
                option.textContent = 'Belum ada data mahasiswa';
                dropdown.appendChild(option);
            }
            
            dropdown.classList.remove('hidden');
        }

        function searchMahasiswa() {
            const input = document.getElementById('mahasiswaSearchInput');
            const dropdown = document.getElementById('mahasiswaOptions');
            
            if (!input || !dropdown) return;
            
            const searchTerm = input.value.toLowerCase();
            
            // Get active mahasiswa
            const activeMahasiswa = accounts.mahasiswa.filter(m => m.status === 'aktif');
            
            dropdown.innerHTML = '';
            
            if (activeMahasiswa.length > 0) {
                const filteredMahasiswa = activeMahasiswa.filter(mahasiswa => 
                    mahasiswa.nama.toLowerCase().includes(searchTerm) || 
                    mahasiswa.nim.includes(searchTerm)
                );
                
                if (filteredMahasiswa.length > 0) {
                    filteredMahasiswa.forEach(mahasiswa => {
                        const option = document.createElement('div');
                        option.className = 'px-3 py-2 hover:bg-blue-50 cursor-pointer text-sm';
                        option.textContent = `${mahasiswa.nama} (${mahasiswa.nim})`;
                        option.onclick = () => selectMahasiswaOption(mahasiswa.nim, mahasiswa.nama);
                        dropdown.appendChild(option);
                    });
                } else {
                    const option = document.createElement('div');
                    option.className = 'px-3 py-2 text-gray-500 text-sm';
                    option.textContent = 'Tidak ada mahasiswa yang cocok';
                    dropdown.appendChild(option);
                }
            } else {
                const option = document.createElement('div');
                option.className = 'px-3 py-2 text-gray-500 text-sm';
                option.textContent = 'Belum ada data mahasiswa';
                dropdown.appendChild(option);
            }
            
            dropdown.classList.remove('hidden');
        }

        function selectMahasiswaOption(nim, nama) {
            const input = document.getElementById('mahasiswaSearchInput');
            const dropdown = document.getElementById('mahasiswaOptions');
            const nimHidden = document.getElementById('selectedMahasiswaNim');
            const namaHidden = document.getElementById('selectedMahasiswaNama');
            
            if (input) input.value = `${nama} (${nim})`;
            if (dropdown) dropdown.classList.add('hidden');
            if (nimHidden) nimHidden.value = nim;
            if (namaHidden) namaHidden.value = nama;
        }

        async function terbitkanSK() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const nim = document.getElementById('selectedMahasiswaNim').value;
            const nama = document.getElementById('selectedMahasiswaNama').value;
            const nomorSK = document.getElementById('nomorSKInput').value;
            const pembimbing1 = document.getElementById('pembimbing1Select').value;
            const pembimbing2 = document.getElementById('pembimbing2Select').value;
            
            if (!nim || !nama || !nomorSK || !pembimbing1 || !pembimbing2) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Check if mahasiswa already has pembimbing
            const existingPembimbing = submissions.pembimbing.find(p => p.nim === nim);
            if (existingPembimbing) {
                alert('Mahasiswa ini sudah memiliki pembimbing yang ditetapkan!');
                return;
            }
            
            // Create pembimbing data
            const pembimbingBaru = {
                id: Date.now().toString(),
                nim: nim,
                nama: nama,
                nomorSK: nomorSK,
                pembimbing1: pembimbing1,
                pembimbing2: pembimbing2,
                tanggalSK: new Date().toLocaleDateString('id-ID'),
                status: 'Aktif',
                timestamp: new Date()
            };
            
            // Add to local storage
            submissions.pembimbing.push(pembimbingBaru);
            
            try {
                // Save to Firebase
                await addDoc(collection(db, 'penetapan_pembimbing'), pembimbingBaru);
            } catch (error) {
                console.log('Demo mode - data saved locally');
                saveLocalData();
            }
            
            alert(`SK Pembimbing berhasil diterbitkan!\n\nNomor SK: ${nomorSK}\nMahasiswa: ${nama} (${nim})\nPembimbing 1: ${pembimbing1}\nPembimbing 2: ${pembimbing2}\n\nDokumen akan dikirim ke dosen pembimbing.`);
            
            // Clear form
            document.getElementById('mahasiswaSearchInput').value = '';
            document.getElementById('selectedMahasiswaNim').value = '';
            document.getElementById('selectedMahasiswaNama').value = '';
            document.getElementById('nomorSKInput').value = '';
            document.getElementById('pembimbing1Select').value = '';
            document.getElementById('pembimbing2Select').value = '';
            
            // Update rekapitulasi table
            updateRekapPembimbingTable();
            
            // Update dosen dropdown options
            updateDosenDropdownOptions();
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('mahasiswaOptions');
            const input = document.getElementById('mahasiswaSearchInput');
            
            if (dropdown && input && !dropdown.contains(event.target) && event.target !== input) {
                dropdown.classList.add('hidden');
            }
        });

        // Dosen functions
        async function tandatanganiForm(nim) {
            // Prevent default behavior
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            // Find submission and update approval status
            const submission = submissions.judulSkripsi.find(s => s.nim === nim);
            if (submission) {
                submission.dosenWaliApproval = true;
                submission.tanggalPersetujuanDosen = new Date().toLocaleDateString('id-ID');
                
                try {
                    // Update in Firebase if available
                    if (submission.id) {
                        await updateDoc(doc(db, 'pengajuan_judul', submission.id), {
                            dosenWaliApproval: true,
                            tanggalPersetujuanDosen: new Date().toISOString()
                        });
                    }
                } catch (error) {
                    console.log('Demo mode - approval saved locally');
                    saveLocalData();
                }
                
                alert('Form pengajuan judul berhasil ditandatangani!');
                
                // Update table display
                updatePersetujuanDosenTable();
            }
        }

        async function simpanBimbingan() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const form = event ? event.target.closest('form') : document.querySelector('#portalDosen form');
            const mahasiswa = document.getElementById('bimbinganMahasiswaSelect').value;
            const tanggal = form.querySelector('input[type="date"]').value;
            const materi = form.querySelector('textarea[placeholder="Jelaskan materi yang dibimbing"]').value;
            const catatan = form.querySelector('textarea[placeholder="Catatan dan saran untuk mahasiswa"]').value;
            
            if (!mahasiswa || !tanggal || !materi || !catatan) {
                alert('Mohon lengkapi semua field bimbingan!');
                return;
            }
            
            // Get dosen name from login
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            const dosenNama = dosen ? dosen.nama : 'Dosen Pembimbing';
            
            // Add to local storage
            const newBimbingan = {
                id: Date.now().toString(),
                mahasiswa: mahasiswa,
                tanggal: tanggal,
                materi: materi,
                catatan: catatan,
                pembimbing: dosenNama,
                timestamp: new Date()
            };
            
            submissions.bimbingan.push(newBimbingan);
            
            try {
                await addDoc(collection(db, 'bimbingan'), newBimbingan);
            } catch (error) {
                console.log('Demo mode - data saved locally');
                saveLocalData();
            }
            
            alert('Data bimbingan berhasil disimpan!');
            form.reset();
            
            // Auto-select the mahasiswa in filter if not already selected
            if (!selectedMahasiswaFilter) {
                selectMahasiswa(mahasiswa);
            } else if (selectedMahasiswaFilter === mahasiswa) {
                // Update riwayat bimbingan with current filter
                updateRiwayatBimbingan(null, selectedMahasiswaFilter);
            } else {
                // Update riwayat bimbingan display without filter
                updateRiwayatBimbingan();
            }
        }

        // Update dropdown options based on accounts
        function updateDropdownOptions() {
            // Update mahasiswa dropdowns
            const mahasiswaSelects = document.querySelectorAll('#mahasiswaSelect, #munaqosyahMahasiswaSelect, select[id*="mahasiswa"]');
            mahasiswaSelects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">Pilih Mahasiswa</option>';
                accounts.mahasiswa.forEach(mhs => {
                    if (mhs.status === 'aktif') {
                        const option = document.createElement('option');
                        option.value = `${mhs.nama} (${mhs.nim})`;
                        option.textContent = `${mhs.nama} (${mhs.nim})`;
                        if (option.value === currentValue) option.selected = true;
                        select.appendChild(option);
                    }
                });
            });
            
            // Update dosen dropdowns for penguji/pembimbing
            const dosenSelects = document.querySelectorAll('#penguji1Select, #penguji2Select, #pembimbing1Select, #pembimbing2Select, #munaqosyahPenguji1, #munaqosyahPenguji2, select[id*="pembimbing"], select[id*="penguji"]');
            dosenSelects.forEach(select => {
                const currentValue = select.value;
                let placeholder = 'Pilih Dosen';
                if (select.id.includes('penguji1') || select.id.includes('pembimbing1')) placeholder = 'Pilih Pembimbing 1';
                else if (select.id.includes('penguji2') || select.id.includes('pembimbing2')) placeholder = 'Pilih Pembimbing 2';
                else if (select.id.includes('munaqosyahPenguji1')) placeholder = 'Pilih Penguji 1';
                else if (select.id.includes('munaqosyahPenguji2')) placeholder = 'Pilih Penguji 2';
                
                select.innerHTML = `<option value="">${placeholder}</option>`;
                accounts.dosen.forEach(dosen => {
                    if (dosen.status === 'aktif') {
                        const option = document.createElement('option');
                        option.value = dosen.nama;
                        option.textContent = dosen.nama;
                        if (option.value === currentValue) option.selected = true;
                        select.appendChild(option);
                    }
                });
            });

            // Update dosen dropdown in bimbingan form - only show mahasiswa with assigned pembimbing
            updateDosenDropdownOptions();
        }

        // Update dosen dropdown options to show only assigned mahasiswa
        function updateDosenDropdownOptions() {
            const bimbinganMahasiswaSelect = document.getElementById('bimbinganMahasiswaSelect');
            if (!bimbinganMahasiswaSelect) return;
            
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            if (!dosenLogin) return;
            
            // Find dosen name from accounts
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            if (!dosen) return;
            
            const currentValue = bimbinganMahasiswaSelect.value;
            bimbinganMahasiswaSelect.innerHTML = '<option value="">Pilih Mahasiswa</option>';
            
            // Get mahasiswa that are assigned to this dosen as pembimbing
            const assignedMahasiswa = submissions.pembimbing.filter(p => 
                p.pembimbing1 === dosen.nama || p.pembimbing2 === dosen.nama
            );
            
            if (assignedMahasiswa.length > 0) {
                assignedMahasiswa.forEach(pembimbing => {
                    const option = document.createElement('option');
                    option.value = `${pembimbing.nama} (${pembimbing.nim})`;
                    option.textContent = `${pembimbing.nama} (${pembimbing.nim})`;
                    if (option.value === currentValue) option.selected = true;
                    bimbinganMahasiswaSelect.appendChild(option);
                });
            }
            
            // Update filter dropdown for riwayat bimbingan
            updateFilterDropdownOptions();
        }

        // Munaqosyah scheduling function
        async function buatJadwalMunaqosyah() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const mahasiswa = document.getElementById('munaqosyahMahasiswaSelect').value;
            const tanggal = document.getElementById('munaqosyahDateTime').value;
            const ruangan = document.getElementById('munaqosyahRuangan').value;
            const penguji1 = document.getElementById('munaqosyahPenguji1').value;
            const penguji2 = document.getElementById('munaqosyahPenguji2').value;
            
            if (!mahasiswa || !tanggal || !ruangan || !penguji1 || !penguji2) {
                alert('Mohon lengkapi semua field!');
                return;
            }
            
            // Extract NIM from mahasiswa string (format: "Nama (NIM)")
            const nimMatch = mahasiswa.match(/\((\d+)\)/);
            const nim = nimMatch ? nimMatch[1] : '';
            const nama = mahasiswa.split(' (')[0];
            
            // Create jadwal object
            const jadwalBaru = {
                id: Date.now().toString(),
                mahasiswa: mahasiswa,
                nim: nim,
                nama: nama,
                tanggal: tanggal,
                ruangan: ruangan,
                penguji1: penguji1,
                penguji2: penguji2,
                status: 'Terjadwal',
                tanggalBuat: new Date().toLocaleDateString('id-ID')
            };
            
            // Add to local storage
            submissions.jadwalMunaqosyah.push(jadwalBaru);
            
            // Add notification for mahasiswa
            if (!submissions.notifikasi.mahasiswa[nim]) {
                submissions.notifikasi.mahasiswa[nim] = [];
            }
            submissions.notifikasi.mahasiswa[nim].push({
                id: Date.now().toString(),
                type: 'jadwal_munaqosyah',
                message: 'Jadwal sidang munaqosyah Anda telah ditetapkan',
                tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                waktu: new Date(tanggal).toLocaleTimeString('id-ID'),
                ruangan: ruangan,
                penguji1: penguji1,
                penguji2: penguji2,
                tanggalNotif: new Date().toLocaleDateString('id-ID')
            });
            
            // Add notification for dosen
            [penguji1, penguji2].forEach(dosen => {
                if (!submissions.notifikasi.dosen[dosen]) {
                    submissions.notifikasi.dosen[dosen] = [];
                }
                submissions.notifikasi.dosen[dosen].push({
                    id: Date.now().toString() + dosen,
                    type: 'jadwal_munaqosyah',
                    message: `Anda ditugaskan sebagai penguji sidang munaqosyah`,
                    mahasiswa: nama,
                    nim: nim,
                    tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                    waktu: new Date(tanggal).toLocaleTimeString('id-ID'),
                    ruangan: ruangan,
                    tanggalNotif: new Date().toLocaleDateString('id-ID')
                });
            });
            
            try {
                // Save to Firebase
                await addDoc(collection(db, 'jadwal_munaqosyah'), jadwalBaru);
                
                // Save notifications to Firebase
                await addDoc(collection(db, 'notifikasi'), {
                    nim: nim,
                    nama: nama,
                    type: 'jadwal_munaqosyah',
                    message: 'Jadwal sidang munaqosyah Anda telah ditetapkan',
                    tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                    waktu: new Date(tanggal).toLocaleTimeString('id-ID'),
                    ruangan: ruangan,
                    penguji1: penguji1,
                    penguji2: penguji2,
                    timestamp: new Date()
                });
            } catch (error) {
                console.log('Demo mode - jadwal saved locally');
                saveLocalData();
            }
            
            alert(`Jadwal sidang munaqosyah berhasil dibuat!\n\nMahasiswa: ${mahasiswa}\nTanggal: ${new Date(tanggal).toLocaleString('id-ID')}\nRuangan: ${ruangan}\nPenguji 1: ${penguji1}\nPenguji 2: ${penguji2}\n\nNotifikasi telah dikirim ke mahasiswa dan dosen penguji.`);
            
            // Clear form
            document.getElementById('munaqosyahMahasiswaSelect').value = '';
            document.getElementById('munaqosyahDateTime').value = '';
            document.getElementById('munaqosyahRuangan').value = '';
            document.getElementById('munaqosyahPenguji1').value = '';
            document.getElementById('munaqosyahPenguji2').value = '';
            
            // Update rekapitulasi table
            updateRekapJadwalMunaqosyah();
            
            // Update notifications
            updateMahasiswaNotifications();
            updateDosenNotifications();
        }

        // Update filter dropdown options for riwayat bimbingan
        function updateFilterDropdownOptions() {
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            if (!dosenLogin) return;
            
            // Find dosen name from accounts
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            if (!dosen) return;
            
            // Get mahasiswa that are assigned to this dosen as pembimbing
            const assignedMahasiswa = submissions.pembimbing.filter(p => 
                p.pembimbing1 === dosen.nama || p.pembimbing2 === dosen.nama
            );
            
            // Update the mahasiswa list for filter dropdown
            window.assignedMahasiswaList = assignedMahasiswa.map(p => `${p.nama} (${p.nim})`);
        }

        // Update rekapitulasi pembimbing table
        function updateRekapPembimbingTable() {
            const tbody = document.getElementById('rekapPembimbingTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (submissions.pembimbing.length > 0) {
                submissions.pembimbing.forEach(pembimbing => {
                    const row = document.createElement('tr');
                    const statusClass = pembimbing.status === 'Aktif' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const checkboxHtml = `<input type="checkbox" class="pembimbing-checkbox" data-id="${pembimbing.id}" data-nim="${pembimbing.nim}">`;
                    
                    row.innerHTML = `
                        <td class="px-4 py-3">${checkboxHtml}</td>
                        <td class="px-4 py-3 text-sm">${pembimbing.nim}</td>
                        <td class="px-4 py-3 text-sm">${pembimbing.nama}</td>
                        <td class="px-4 py-3 text-sm">${pembimbing.nomorSK}</td>
                        <td class="px-4 py-3 text-sm">${pembimbing.pembimbing1}</td>
                        <td class="px-4 py-3 text-sm">${pembimbing.pembimbing2}</td>
                        <td class="px-4 py-3 text-sm">${pembimbing.tanggalSK}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${pembimbing.status}</span></td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-500">Belum ada penetapan pembimbing</td></tr>';
            }
        }

        // Update notification functions
        function updateMahasiswaNotifications() {
            const nimLogin = sessionStorage.getItem('mahasiswaLogin');
            if (!nimLogin) return;
            
            const statusDiv = document.getElementById('statusPengajuan');
            const notifikasiDiv = document.getElementById('notifikasiSeminar');
            if (!statusDiv || !notifikasiDiv) return;
            
            // Update status pengajuan
            const submission = submissions.judulSkripsi.find(s => s.nim === nimLogin);
            if (submission) {
                let statusClass = 'bg-yellow-100 text-yellow-800 border-yellow-400';
                if (submission.status === 'Disetujui') statusClass = 'bg-green-100 text-green-800 border-green-400';
                else if (submission.status === 'Ditolak') statusClass = 'bg-red-100 text-red-800 border-red-400';
                
                statusDiv.innerHTML = `
                    <div class="p-4 ${statusClass} border-l-4 rounded">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-medium">${submission.status}</p>
                                <p class="text-sm">Diajukan: ${submission.tanggalPengajuan}</p>
                                ${submission.catatan ? `<p class="text-sm mt-1 font-medium">Catatan: ${submission.catatan}</p>` : ''}
                            </div>
                            <span class="px-3 py-1 bg-white bg-opacity-50 rounded-full text-sm">${submission.status}</span>
                        </div>
                    </div>
                `;
            }
            
            // Update notifikasi seminar
            const notifikasi = submissions.notifikasi.mahasiswa[nimLogin] || [];
            const jadwalNotif = notifikasi.filter(n => n.type === 'jadwal_seminar');
            
            if (jadwalNotif.length > 0) {
                notifikasiDiv.innerHTML = jadwalNotif.map(notif => `
                    <div class="p-4 bg-blue-50 border-l-4 border-blue-400 rounded">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-medium text-blue-800">üìÖ ${notif.message}</p>
                                <p class="text-sm text-blue-600">Tanggal: ${notif.tanggal} - ${notif.waktu}</p>
                                <p class="text-sm text-blue-600">Ruangan: ${notif.ruangan}</p>
                                <p class="text-sm text-blue-600">Penguji 1: ${notif.penguji1}</p>
                                <p class="text-sm text-blue-600">Penguji 2: ${notif.penguji2}</p>
                            </div>
                            <span class="px-2 py-1 bg-blue-200 text-blue-800 rounded-full text-xs">Baru</span>
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function updateDosenNotifications() {
            const dosenLogin = sessionStorage.getItem('dosenLogin');
            if (!dosenLogin) return;
            
            const notifikasiDiv = document.getElementById('notifikasiJadwalDosen');
            if (!notifikasiDiv) return;
            
            // Find dosen name from accounts
            const dosen = accounts.dosen.find(d => d.username === dosenLogin);
            if (!dosen) return;
            
            const notifikasi = submissions.notifikasi.dosen[dosen.nama] || [];
            
            if (notifikasi.length > 0) {
                notifikasiDiv.innerHTML = notifikasi.map(notif => {
                    const bgColor = notif.type === 'jadwal_munaqosyah' ? 'bg-indigo-50 border-indigo-400' : 'bg-purple-50 border-purple-400';
                    const textColor = notif.type === 'jadwal_munaqosyah' ? 'text-indigo-800' : 'text-purple-800';
                    const textColorLight = notif.type === 'jadwal_munaqosyah' ? 'text-indigo-600' : 'text-purple-600';
                    const badgeColor = notif.type === 'jadwal_munaqosyah' ? 'bg-indigo-200 text-indigo-800' : 'bg-purple-200 text-purple-800';
                    const icon = notif.type === 'jadwal_munaqosyah' ? 'üéì' : 'üìÖ';
                    
                    return `
                        <div class="p-4 ${bgColor} border-l-4 rounded">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium ${textColor}">${icon} ${notif.message}</p>
                                    <p class="text-sm ${textColorLight}">Mahasiswa: ${notif.mahasiswa} (${notif.nim})</p>
                                    <p class="text-sm ${textColorLight}">Tanggal: ${notif.tanggal} - ${notif.waktu}</p>
                                    <p class="text-sm ${textColorLight}">Ruangan: ${notif.ruangan}</p>
                                </div>
                                <span class="px-2 py-1 ${badgeColor} rounded-full text-xs">Baru</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                notifikasiDiv.innerHTML = '<p class="text-gray-500 text-sm">Belum ada jadwal yang ditugaskan.</p>';
            }
        }

        function updatePersetujuanDosenTable() {
            const tbody = document.getElementById('persetujuanDosenTable');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get approved titles that need dosen wali approval
            const approvedTitles = submissions.judulSkripsi.filter(s => s.status === 'Disetujui');
            
            if (approvedTitles.length > 0) {
                approvedTitles.forEach(submission => {
                    const row = document.createElement('tr');
                    const statusClass = submission.dosenWaliApproval ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';
                    const statusText = submission.dosenWaliApproval ? 'Disetujui Dosen Wali' : 'Menunggu Persetujuan';
                    const actionHtml = submission.dosenWaliApproval ? 
                        '<span class="text-green-600 text-xs">‚úì Sudah Ditandatangani</span>' :
                        `<button onclick="tandatanganiForm('${submission.nim}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs hover:bg-blue-700">Tandatangani</button>`;
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm">${submission.nim}</td>
                        <td class="px-4 py-3 text-sm">${submission.nama}</td>
                        <td class="px-4 py-3 text-sm">${submission.judul}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 ${statusClass} rounded-full text-xs">${statusText}</span></td>
                        <td class="px-4 py-3">${actionHtml}</td>
                    `;
                    tbody.appendChild(row);
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Belum ada judul yang perlu persetujuan dosen wali</td></tr>';
            }
        }
        
        function updateRekapJadwalSeminar() {
            const tbody = document.getElementById('rekapJadwalSeminar');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Use filtered data if available, otherwise use all data
            const dataToShow = filteredJadwalSeminar.length > 0 ? filteredJadwalSeminar : submissions.jadwalSeminar;
            
            dataToShow.forEach(jadwal => {
                const row = document.createElement('tr');
                const checkboxHtml = `<input type="checkbox" class="jadwal-seminar-checkbox" data-id="${jadwal.id}" data-nim="${jadwal.nim}">`;
                
                row.innerHTML = `
                    <td class="px-4 py-3">${checkboxHtml}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.mahasiswa}</td>
                    <td class="px-4 py-3 text-sm">${new Date(jadwal.tanggal).toLocaleString('id-ID')}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.ruangan}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.penguji1}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.penguji2}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">${jadwal.status}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            if (dataToShow.length === 0) {
                const filterDate = document.getElementById('filterTanggalSeminar')?.value;
                const message = filterDate ? 'Tidak ada jadwal pada tanggal yang dipilih' : 'Belum ada jadwal seminar yang dibuat';
                tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">${message}</td></tr>`;
            }
        }

        function updateRekapJadwalMunaqosyah() {
            const tbody = document.getElementById('rekapJadwalMunaqosyah');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Use filtered data if available, otherwise use all data
            const dataToShow = filteredJadwalMunaqosyah.length > 0 ? filteredJadwalMunaqosyah : submissions.jadwalMunaqosyah;
            
            dataToShow.forEach(jadwal => {
                const row = document.createElement('tr');
                const checkboxHtml = `<input type="checkbox" class="jadwal-munaqosyah-checkbox" data-id="${jadwal.id}" data-nim="${jadwal.nim}">`;
                
                row.innerHTML = `
                    <td class="px-4 py-3">${checkboxHtml}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.mahasiswa}</td>
                    <td class="px-4 py-3 text-sm">${new Date(jadwal.tanggal).toLocaleString('id-ID')}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.ruangan}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.penguji1}</td>
                    <td class="px-4 py-3 text-sm">${jadwal.penguji2}</td>
                    <td class="px-4 py-3"><span class="px-2 py-1 bg-purple-100 text-purple-800 rounded-full text-xs">${jadwal.status}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            if (dataToShow.length === 0) {
                const filterDate = document.getElementById('filterTanggalMunaqosyah')?.value;
                const message = filterDate ? 'Tidak ada jadwal pada tanggal yang dipilih' : 'Belum ada jadwal munaqosyah yang dibuat';
                tbody.innerHTML = `<tr><td colspan="7" class="px-4 py-8 text-center text-gray-500">${message}</td></tr>`;
            }
        }

        function updateProdiNotifications() {
            const notifikasiDiv = document.getElementById('notifikasiProdi');
            if (!notifikasiDiv) return;
            
            const notifikasi = submissions.notifikasi.prodi || [];
            
            if (notifikasi.length > 0) {
                notifikasiDiv.innerHTML = notifikasi.map(notif => {
                    let icon = 'üìù';
                    let bgColor = 'bg-blue-50 border-blue-400';
                    let textColor = 'text-blue-800';
                    let textColorLight = 'text-blue-600';
                    let badgeColor = 'bg-blue-200 text-blue-800';
                    
                    if (notif.type === 'pengajuan_munaqosyah') {
                        icon = 'üéì';
                        bgColor = 'bg-purple-50 border-purple-400';
                        textColor = 'text-purple-800';
                        textColorLight = 'text-purple-600';
                        badgeColor = 'bg-purple-200 text-purple-800';
                    } else if (notif.type === 'pengajuan_seminar') {
                        icon = 'üìã';
                        bgColor = 'bg-green-50 border-green-400';
                        textColor = 'text-green-800';
                        textColorLight = 'text-green-600';
                        badgeColor = 'bg-green-200 text-green-800';
                    }
                    
                    return `
                        <div class="p-4 ${bgColor} border-l-4 rounded">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-medium ${textColor}">${icon} ${notif.message}</p>
                                    <p class="text-sm ${textColorLight}">Mahasiswa: ${notif.nama} (${notif.nim})</p>
                                    <p class="text-sm ${textColorLight}">Waktu: ${notif.tanggal} - ${notif.waktu}</p>
                                </div>
                                <span class="px-2 py-1 ${badgeColor} rounded-full text-xs">Baru</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                notifikasiDiv.innerHTML = '<p class="text-gray-500 text-sm">Belum ada notifikasi baru.</p>';
            }
        }

        function updateRekapPengajuanSeminar() {
            // Update for mahasiswa
            const tbodyMahasiswa = document.getElementById('rekapSeminarMahasiswa');
            if (tbodyMahasiswa) {
                const nimLogin = sessionStorage.getItem('mahasiswaLogin');
                tbodyMahasiswa.innerHTML = '';
                
                const pengajuanMahasiswa = submissions.pengajuanSeminar.filter(p => p.nim === nimLogin);
                
                if (pengajuanMahasiswa.length > 0) {
                    pengajuanMahasiswa.forEach(pengajuan => {
                        const row = document.createElement('tr');
                        const checkboxHtml = `<input type="checkbox" class="seminar-mhs-checkbox" data-id="${pengajuan.id}" data-nim="${pengajuan.nim}">`;
                        
                        row.innerHTML = `
                            <td class="px-4 py-3">${checkboxHtml}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.nim}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.nama}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.tanggalSubmit}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${pengajuan.status}</span></td>
                        `;
                        tbodyMahasiswa.appendChild(row);
                    });
                } else {
                    tbodyMahasiswa.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Belum ada pengajuan seminar proposal</td></tr>';
                }
            }
            
            // Update for prodi
            const tbodyProdi = document.getElementById('rekapSeminarProdi');
            if (tbodyProdi) {
                tbodyProdi.innerHTML = '';
                
                if (submissions.pengajuanSeminar.length > 0) {
                    submissions.pengajuanSeminar.forEach(pengajuan => {
                        const row = document.createElement('tr');
                        const checkboxHtml = `<input type="checkbox" class="seminar-checkbox" data-id="${pengajuan.id}" data-nim="${pengajuan.nim}">`;
                        
                        row.innerHTML = `
                            <td class="px-4 py-3">${checkboxHtml}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.nim}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.nama}</td>
                            <td class="px-4 py-3 text-sm">${pengajuan.tanggalSubmit}</td>
                            <td class="px-4 py-3"><span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs">${pengajuan.status}</span></td>
                        `;
                        tbodyProdi.appendChild(row);
                    });
                } else {
                    tbodyProdi.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Belum ada pengajuan seminar proposal</td></tr>';
                }
            }
        }

        // Function to handle Google Drive link with comprehensive popup blocker solution
        function openGoogleDrive() {
            const driveUrl = 'https://drive.google.com/drive/folders/1OUW7LhUaQ20ubFQ6h8zADqGCu5CX21Lh?usp=drive_link';
            
            // Show loading indicator
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="opacity-25"></circle><path fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z" class="opacity-75"></path></svg>Membuka...';
            button.disabled = true;
            
            // Try to open in new window/tab
            const newWindow = window.open(driveUrl, '_blank', 'noopener,noreferrer');
            
            // Reset button after short delay
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            }, 2000);
            
            // Check if popup was blocked (with delay to ensure proper detection)
            setTimeout(() => {
                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    // Popup was blocked, show comprehensive solution
                    showPopupBlockedSolution(driveUrl);
                } else {
                    // Popup opened successfully, show success message briefly
                    showSuccessMessage();
                }
            }, 100);
        }

        // Show popup blocked solution with multiple options
        function showPopupBlockedSolution(driveUrl) {
            const alternativeDiv = document.getElementById('alternativeLink');
            if (alternativeDiv) {
                // Update content with comprehensive solution
                alternativeDiv.innerHTML = `
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3 flex-1">
                                <h3 class="text-sm font-medium text-yellow-800 mb-2">
                                    Browser memblokir popup - Pilih cara akses:
                                </h3>
                                
                                <!-- Option 1: Direct link -->
                                <div class="mb-3">
                                    <button onclick="window.open('${driveUrl}', '_blank')" 
                                            class="inline-flex items-center px-3 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 transition-colors">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                                        </svg>
                                        Coba Buka Lagi
                                    </button>
                                    <span class="ml-2 text-xs text-yellow-700">(Klik "Izinkan popup" jika muncul)</span>
                                </div>
                                
                                <!-- Option 2: Copy link -->
                                <div class="mb-3">
                                    <div class="flex items-center space-x-2">
                                        <input type="text" value="${driveUrl}" readonly 
                                               class="flex-1 px-2 py-1 text-xs border border-gray-300 rounded bg-gray-50" 
                                               id="driveUrlInput">
                                        <button onclick="copyDriveUrl()" 
                                                class="px-3 py-1 bg-green-600 text-white text-xs font-medium rounded hover:bg-green-700 transition-colors">
                                            üìã Copy
                                        </button>
                                    </div>
                                    <p class="text-xs text-yellow-700 mt-1">Copy link dan paste di tab browser baru</p>
                                </div>
                                
                                <!-- Option 3: Same tab -->
                                <div class="mb-3">
                                    <button onclick="goToGoogleDrive('${driveUrl}')" 
                                            class="inline-flex items-center px-3 py-2 bg-orange-600 text-white text-sm font-medium rounded-md hover:bg-orange-700 transition-colors">
                                        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                                        </svg>
                                        Buka di Tab Ini
                                    </button>
                                    <span class="ml-2 text-xs text-yellow-700">(Akan meninggalkan halaman ini)</span>
                                </div>
                                
                                <!-- Instructions -->
                                <div class="mt-3 p-2 bg-blue-50 rounded text-xs text-blue-800">
                                    <strong>üí° Tips:</strong> Untuk menghindari masalah ini di masa depan, izinkan popup untuk situs ini di pengaturan browser Anda.
                                </div>
                                
                                <!-- Close button -->
                                <button onclick="hideAlternativeLink()" 
                                        class="mt-2 text-xs text-yellow-600 hover:text-yellow-800 underline">
                                    Tutup pesan ini
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                alternativeDiv.classList.remove('hidden');
                
                // Auto-hide after 30 seconds (longer time for user to choose)
                setTimeout(() => {
                    if (!alternativeDiv.classList.contains('hidden')) {
                        alternativeDiv.classList.add('hidden');
                    }
                }, 30000);
            }
        }

        // Show success message when popup opens successfully
        function showSuccessMessage() {
            const alternativeDiv = document.getElementById('alternativeLink');
            if (alternativeDiv) {
                alternativeDiv.innerHTML = `
                    <div class="p-3 bg-green-50 border border-green-200 rounded-lg">
                        <div class="flex items-center">
                            <svg class="h-5 w-5 text-green-400 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-sm font-medium text-green-800">
                                ‚úÖ Google Drive berhasil dibuka di tab baru!
                            </span>
                        </div>
                    </div>
                `;
                alternativeDiv.classList.remove('hidden');
                
                // Auto-hide success message after 3 seconds
                setTimeout(() => {
                    alternativeDiv.classList.add('hidden');
                }, 3000);
            }
        }

        // Copy drive URL to clipboard
        function copyDriveUrl() {
            const input = document.getElementById('driveUrlInput');
            if (input) {
                input.select();
                input.setSelectionRange(0, 99999); // For mobile devices
                
                try {
                    document.execCommand('copy');
                    
                    // Show copy success feedback
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = '‚úÖ Copied!';
                    button.classList.remove('bg-green-600', 'hover:bg-green-700');
                    button.classList.add('bg-green-700');
                    
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-700');
                        button.classList.add('bg-green-600', 'hover:bg-green-700');
                    }, 2000);
                    
                } catch (err) {
                    // Fallback for browsers that don't support execCommand
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(input.value).then(() => {
                            const button = event.target;
                            const originalText = button.textContent;
                            button.textContent = '‚úÖ Copied!';
                            setTimeout(() => {
                                button.textContent = originalText;
                            }, 2000);
                        });
                    } else {
                        alert('Link copied! Paste di browser: ' + input.value);
                    }
                }
            }
        }

        // Navigate to Google Drive in same tab
        function goToGoogleDrive(url) {
            if (confirm('Anda akan meninggalkan halaman ini dan pergi ke Google Drive. Pastikan Anda sudah menyimpan pekerjaan. Lanjutkan?')) {
                window.location.href = url;
            }
        }

        // Hide alternative link manually
        function hideAlternativeLink() {
            const alternativeDiv = document.getElementById('alternativeLink');
            if (alternativeDiv) {
                alternativeDiv.classList.add('hidden');
            }
        }

        // New functions for delete functionality and filters
        
        // Toggle select all functions for different tables
        function toggleSelectAllSeminar() {
            const selectAll = document.getElementById('selectAllSeminar');
            const checkboxes = document.querySelectorAll('.seminar-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        
        function toggleSelectAllJadwalSeminar() {
            const selectAll = document.getElementById('selectAllJadwalSeminar');
            const checkboxes = document.querySelectorAll('.jadwal-seminar-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        
        function toggleSelectAllJadwalMunaqosyah() {
            const selectAll = document.getElementById('selectAllJadwalMunaqosyah');
            const checkboxes = document.querySelectorAll('.jadwal-munaqosyah-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        
        function toggleSelectAllPembimbing() {
            const selectAll = document.getElementById('selectAllPembimbing');
            const checkboxes = document.querySelectorAll('.pembimbing-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        
        function toggleSelectAllBimbingan() {
            const selectAll = document.getElementById('selectAllBimbingan');
            const checkboxes = document.querySelectorAll('.bimbingan-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        
        function toggleSelectAllSeminarMhs() {
            const selectAll = document.getElementById('selectAllSeminarMhs');
            const checkboxes = document.querySelectorAll('.seminar-mhs-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }
        
        // Delete selected data function
        async function hapusDataTerpilih(type) {
            // Prevent default behavior
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            let checkboxes, dataArray, collectionName, message, updateFunction;
            
            switch(type) {
                case 'judul':
                    checkboxes = document.querySelectorAll('.judul-checkbox:checked');
                    dataArray = submissions.judulSkripsi;
                    collectionName = 'pengajuan_judul';
                    message = 'pengajuan judul';
                    updateFunction = updateJudulValidasiTable;
                    break;
                case 'seminar':
                    checkboxes = document.querySelectorAll('.seminar-checkbox:checked');
                    dataArray = submissions.pengajuanSeminar;
                    collectionName = 'pengajuan_seminar';
                    message = 'pengajuan seminar';
                    updateFunction = updateRekapPengajuanSeminar;
                    break;
                case 'jadwalSeminar':
                    checkboxes = document.querySelectorAll('.jadwal-seminar-checkbox:checked');
                    dataArray = submissions.jadwalSeminar;
                    collectionName = 'jadwal_seminar';
                    message = 'jadwal seminar';
                    updateFunction = updateRekapJadwalSeminar;
                    break;
                case 'jadwalMunaqosyah':
                    checkboxes = document.querySelectorAll('.jadwal-munaqosyah-checkbox:checked');
                    dataArray = submissions.jadwalMunaqosyah;
                    collectionName = 'jadwal_munaqosyah';
                    message = 'jadwal munaqosyah';
                    updateFunction = updateRekapJadwalMunaqosyah;
                    break;
                case 'pembimbing':
                    checkboxes = document.querySelectorAll('.pembimbing-checkbox:checked');
                    dataArray = submissions.pembimbing;
                    collectionName = 'penetapan_pembimbing';
                    message = 'penetapan pembimbing';
                    updateFunction = updateRekapPembimbingTable;
                    break;
                case 'bimbingan':
                    checkboxes = document.querySelectorAll('.bimbingan-checkbox:checked');
                    dataArray = submissions.bimbingan;
                    collectionName = 'bimbingan';
                    message = 'data bimbingan';
                    updateFunction = () => updateRiwayatBimbingan(null, selectedMahasiswaFilter);
                    break;
                case 'seminarMhs':
                    checkboxes = document.querySelectorAll('.seminar-mhs-checkbox:checked');
                    dataArray = submissions.pengajuanSeminar;
                    collectionName = 'pengajuan_seminar';
                    message = 'pengajuan seminar';
                    updateFunction = updateRekapPengajuanSeminar;
                    break;
            }
            
            if (!checkboxes || checkboxes.length === 0) {
                alert('Pilih minimal satu data untuk dihapus!');
                return;
            }
            
            if (!confirm(`Yakin ingin menghapus ${checkboxes.length} ${message} yang dipilih? Data yang dihapus tidak dapat dikembalikan.`)) {
                return;
            }
            
            // Get selected IDs and NIMs
            const selectedItems = [];
            checkboxes.forEach(checkbox => {
                const id = checkbox.getAttribute('data-id');
                const nim = checkbox.getAttribute('data-nim');
                const mahasiswa = checkbox.getAttribute('data-mahasiswa');
                
                // Ensure we have valid identifiers
                if (id || nim || mahasiswa) {
                    selectedItems.push({ id, nim, mahasiswa });
                }
            });
            
            if (selectedItems.length === 0) {
                alert('Tidak ada data valid yang dipilih untuk dihapus!');
                return;
            }
            
            // Remove from local array with enhanced matching
            let deletedCount = 0;
            selectedItems.forEach(item => {
                let index = -1;
                
                // Enhanced matching logic for different data types
                if (type === 'bimbingan') {
                    // For bimbingan, try multiple matching strategies
                    if (item.id && item.id !== 'undefined' && item.id !== 'null') {
                        index = dataArray.findIndex(d => d.id === item.id);
                    }
                    if (index === -1 && item.mahasiswa) {
                        index = dataArray.findIndex(d => d.mahasiswa === item.mahasiswa);
                    }
                } else {
                    // For other types, prioritize ID matching
                    if (item.id && item.id !== 'undefined' && item.id !== 'null') {
                        index = dataArray.findIndex(d => d.id === item.id);
                    }
                    // Fallback to NIM matching
                    if (index === -1 && item.nim) {
                        index = dataArray.findIndex(d => d.nim === item.nim);
                    }
                    // Additional fallback for name matching in some cases
                    if (index === -1 && item.mahasiswa && (type === 'jadwalSeminar' || type === 'jadwalMunaqosyah')) {
                        index = dataArray.findIndex(d => d.mahasiswa === item.mahasiswa || d.nama === item.mahasiswa);
                    }
                }
                
                if (index > -1) {
                    dataArray.splice(index, 1);
                    deletedCount++;
                }
            });
            
            // Save to localStorage as fallback
            saveLocalData();
            
            try {
                // Remove from Firebase if available
                for (const item of selectedItems) {
                    if (item.id && item.id !== 'undefined' && item.id !== 'null' && window.db) {
                        await window.deleteDoc(window.doc(window.db, collectionName, item.id));
                    }
                }
            } catch (error) {
                console.log('Firebase error or demo mode - data deleted locally');
            }
            
            alert(`${deletedCount} ${message} berhasil dihapus!`);
            
            // Update specific display function
            if (updateFunction) {
                updateFunction();
            }
            
            // Also update dashboard stats
            updateDashboardStats();
            
            // Uncheck select all checkboxes
            const selectAllCheckboxes = [
                'selectAll',
                'selectAllSeminar', 
                'selectAllJadwalSeminar',
                'selectAllJadwalMunaqosyah',
                'selectAllPembimbing',
                'selectAllBimbingan',
                'selectAllSeminarMhs'
            ];
            
            selectAllCheckboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
        }
        
        // Filter functions for schedule tables
        let filteredJadwalSeminar = [];
        let filteredJadwalMunaqosyah = [];
        
        function filterJadwalSeminar() {
            const filterDate = document.getElementById('filterTanggalSeminar').value;
            if (!filterDate) {
                filteredJadwalSeminar = [...submissions.jadwalSeminar];
            } else {
                const filterDateObj = new Date(filterDate);
                filteredJadwalSeminar = submissions.jadwalSeminar.filter(jadwal => {
                    const jadwalDate = new Date(jadwal.tanggal);
                    return jadwalDate.toDateString() === filterDateObj.toDateString();
                });
            }
            updateRekapJadwalSeminar();
        }
        
        function clearFilterSeminar() {
            document.getElementById('filterTanggalSeminar').value = '';
            filteredJadwalSeminar = [...submissions.jadwalSeminar];
            updateRekapJadwalSeminar();
        }
        
        function filterJadwalMunaqosyah() {
            const filterDate = document.getElementById('filterTanggalMunaqosyah').value;
            if (!filterDate) {
                filteredJadwalMunaqosyah = [...submissions.jadwalMunaqosyah];
            } else {
                const filterDateObj = new Date(filterDate);
                filteredJadwalMunaqosyah = submissions.jadwalMunaqosyah.filter(jadwal => {
                    const jadwalDate = new Date(jadwal.tanggal);
                    return jadwalDate.toDateString() === filterDateObj.toDateString();
                });
            }
            updateRekapJadwalMunaqosyah();
        }
        
        function clearFilterMunaqosyah() {
            document.getElementById('filterTanggalMunaqosyah').value = '';
            filteredJadwalMunaqosyah = [...submissions.jadwalMunaqosyah];
            updateRekapJadwalMunaqosyah();
        }
        
        // Print functions for schedules
        function printJadwalSeminar() {
            const dataToShow = filteredJadwalSeminar.length > 0 ? filteredJadwalSeminar : submissions.jadwalSeminar;
            const filterDate = document.getElementById('filterTanggalSeminar').value;
            const titleSuffix = filterDate ? ` - ${new Date(filterDate).toLocaleDateString('id-ID')}` : '';
            
            printSchedule(dataToShow, 'Jadwal Seminar Proposal' + titleSuffix, 'seminar');
        }
        
        function printJadwalMunaqosyah() {
            const dataToShow = filteredJadwalMunaqosyah.length > 0 ? filteredJadwalMunaqosyah : submissions.jadwalMunaqosyah;
            const filterDate = document.getElementById('filterTanggalMunaqosyah').value;
            const titleSuffix = filterDate ? ` - ${new Date(filterDate).toLocaleDateString('id-ID')}` : '';
            
            printSchedule(dataToShow, 'Jadwal Sidang Munaqosyah' + titleSuffix, 'munaqosyah');
        }
        
        function printSchedule(scheduleData, title, type) {
            if (scheduleData.length === 0) {
                alert('Tidak ada data jadwal untuk dicetak!');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const bgColor = type === 'munaqosyah' ? '#7c3aed' : '#2563eb';
            
            let tableRows = '';
            scheduleData.forEach((jadwal, index) => {
                tableRows += `
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 12px; text-align: center; border-right: 1px solid #ddd;">${index + 1}</td>
                        <td style="padding: 12px; border-right: 1px solid #ddd;">${jadwal.nama || jadwal.mahasiswa}</td>
                        <td style="padding: 12px; border-right: 1px solid #ddd;">${jadwal.nim || ''}</td>
                        <td style="padding: 12px; border-right: 1px solid #ddd;">${new Date(jadwal.tanggal).toLocaleString('id-ID')}</td>
                        <td style="padding: 12px; border-right: 1px solid #ddd;">${jadwal.ruangan}</td>
                        <td style="padding: 12px; border-right: 1px solid #ddd;">${jadwal.penguji1}</td>
                        <td style="padding: 12px;">${jadwal.penguji2}</td>
                    </tr>
                `;
            });
            
            const printContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${title} - STAI Al-Mas'udiyah</title>
                    <style>
                        @page {
                            size: A4 landscape;
                            margin: 1.5cm;
                        }
                        
                        * {
                            margin: 0;
                            padding: 0;
                            box-sizing: border-box;
                        }
                        
                        body {
                            font-family: 'Times New Roman', serif;
                            font-size: 11pt;
                            line-height: 1.4;
                            color: #000;
                            background: white;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 25px;
                            border-bottom: 2px solid ${bgColor};
                            padding-bottom: 15px;
                        }
                        
                        .header h1 {
                            font-size: 16pt;
                            font-weight: bold;
                            margin-bottom: 5px;
                            color: ${bgColor};
                        }
                        
                        .header h2 {
                            font-size: 14pt;
                            font-weight: normal;
                            margin-bottom: 5px;
                        }
                        
                        .header h3 {
                            font-size: 12pt;
                            font-weight: bold;
                            color: ${bgColor};
                        }
                        
                        .schedule-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                            border: 2px solid ${bgColor};
                        }
                        
                        .schedule-table th {
                            background-color: ${bgColor};
                            color: white;
                            padding: 12px 8px;
                            text-align: center;
                            font-weight: bold;
                            border-right: 1px solid white;
                        }
                        
                        .schedule-table th:last-child {
                            border-right: none;
                        }
                        
                        .schedule-table td {
                            vertical-align: top;
                        }
                        
                        .footer {
                            margin-top: 30px;
                            display: flex;
                            justify-content: space-between;
                            align-items: flex-start;
                        }
                        
                        .signature-box {
                            text-align: center;
                            width: 45%;
                        }
                        
                        .signature-line {
                            border-top: 1px solid #000;
                            margin-top: 80px;
                            padding-top: 5px;
                        }
                        
                        .print-info {
                            margin-top: 20px;
                            text-align: center;
                            font-size: 9pt;
                            color: #666;
                        }
                        
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${title.toUpperCase()}</h1>
                        <h2>STAI AL-MAS'UDIYAH SUKABUMI</h2>
                        <h3>TAHUN AKADEMIK 2024/2025</h3>
                    </div>
                    
                    <table class="schedule-table">
                        <thead>
                            <tr>
                                <th style="width: 5%;">No</th>
                                <th style="width: 20%;">Nama Mahasiswa</th>
                                <th style="width: 10%;">NIM</th>
                                <th style="width: 20%;">Tanggal & Waktu</th>
                                <th style="width: 10%;">Ruangan</th>
                                <th style="width: 17.5%;">Penguji 1</th>
                                <th style="width: 17.5%;">Penguji 2</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    
                    <div class="footer">
                        <div class="signature-box">
                            <p>Mengetahui,</p>
                            <p style="margin-top: 10px;">Ketua Program Studi</p>
                            <div class="signature-line">
                                <p style="font-weight: bold;">Dr. H. Ahmad Syukri, M.Pd.I</p>
                                <p style="font-size: 9pt;">NIDN. 2108067801</p>
                            </div>
                        </div>
                        <div class="signature-box">
                            <p>Sukabumi, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                            <p style="margin-top: 10px;">Koordinator ${type === 'munaqosyah' ? 'Munaqosyah' : 'Seminar'}</p>
                            <div class="signature-line">
                                <p style="font-weight: bold;">Dr. H. Muhammad Ridwan, M.Pd.I</p>
                                <p style="font-size: 9pt;">NIDN. 2108067803</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="print-info">
                        <p>Dicetak pada: ${new Date().toLocaleString('id-ID')} | Total: ${scheduleData.length} jadwal</p>
                        <p>Sistem Manajemen Skripsi - STAI Al-Mas'udiyah Sukabumi</p>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // Wait for content to load then print
            printWindow.onload = function() {
                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    // Don't auto-close to allow user to save as PDF
                }, 500);
            };
        }

        // Status Skripsi Management Functions
        async function updateStatusSkripsi() {
            // Prevent default form submission
            if (event && event.preventDefault) {
                event.preventDefault();
            }
            
            const mahasiswaSelect = document.getElementById('statusMahasiswaSelect').value;
            const status = document.getElementById('statusSkripsiSelect').value;
            const catatan = document.getElementById('statusCatatan').value;
            
            if (!mahasiswaSelect || !status) {
                alert('Mohon pilih mahasiswa dan status skripsi!');
                return;
            }
            
            // Extract NIM from mahasiswa string (format: "Nama (NIM)")
            const nimMatch = mahasiswaSelect.match(/\((\d+)\)/);
            const nim = nimMatch ? nimMatch[1] : '';
            const nama = mahasiswaSelect.split(' (')[0];
            
            if (!nim) {
                alert('Format mahasiswa tidak valid!');
                return;
            }
            
            // Check if status already exists for this mahasiswa
            const existingIndex = submissions.statusSkripsi.findIndex(s => s.nim === nim);
            
            const statusData = {
                id: existingIndex >= 0 ? submissions.statusSkripsi[existingIndex].id : Date.now().toString(),
                nim: nim,
                nama: nama,
                status: status,
                catatan: catatan,
                tanggalUpdate: new Date().toLocaleDateString('id-ID'),
                timestamp: new Date()
            };
            
            if (existingIndex >= 0) {
                // Update existing status
                submissions.statusSkripsi[existingIndex] = statusData;
            } else {
                // Add new status
                submissions.statusSkripsi.push(statusData);
            }
            
            try {
                // Save to Firebase
                if (existingIndex >= 0) {
                    await updateDoc(doc(db, 'status_skripsi', statusData.id), statusData);
                } else {
                    await addDoc(collection(db, 'status_skripsi'), statusData);
                }
            } catch (error) {
                console.log('Demo mode - status saved locally');
                saveLocalData();
            }
            
            alert(`Status skripsi ${nama} berhasil diupdate menjadi "${status}"!`);
            
            // Clear form
            document.getElementById('statusMahasiswaSelect').value = '';
            document.getElementById('statusSkripsiSelect').value = '';
            document.getElementById('statusCatatan').value = '';
            
            // Update displays
            updateRekapStatusSkripsi();
            updateDashboardStats();
        }
        
        function updateRekapStatusSkripsi() {
            const container = document.getElementById('rekapStatusSkripsi');
            const countSelesai = document.getElementById('countSelesai');
            const countProses = document.getElementById('countProses');
            const countBelum = document.getElementById('countBelum');
            
            if (!container) return;
            
            container.innerHTML = '';
            
            // Count status
            let selesai = 0, proses = 0, belum = 0;
            
            if (submissions.statusSkripsi.length > 0) {
                submissions.statusSkripsi.forEach(status => {
                    const div = document.createElement('div');
                    let statusClass = 'bg-gray-100 text-gray-800';
                    let statusIcon = '‚è≥';
                    
                    if (status.status === 'Selesai') {
                        statusClass = 'bg-green-100 text-green-800';
                        statusIcon = '‚úÖ';
                        selesai++;
                    } else if (status.status === 'Dalam Proses') {
                        statusClass = 'bg-yellow-100 text-yellow-800';
                        statusIcon = 'üîÑ';
                        proses++;
                    } else {
                        statusIcon = '‚è∏Ô∏è';
                        belum++;
                    }
                    
                    div.className = 'p-3 border border-gray-200 rounded-lg';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-medium text-sm">${status.nama} (${status.nim})</div>
                                <div class="text-xs text-gray-500 mt-1">Update: ${status.tanggalUpdate}</div>
                                ${status.catatan ? `<div class="text-xs text-gray-600 mt-1 italic">"${status.catatan}"</div>` : ''}
                            </div>
                            <span class="px-2 py-1 ${statusClass} rounded-full text-xs font-medium ml-2">
                                ${statusIcon} ${status.status}
                            </span>
                        </div>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<div class="p-3 text-center text-gray-500 text-sm">Belum ada data status skripsi</div>';
            }
            
            // Update counters
            if (countSelesai) countSelesai.textContent = selesai;
            if (countProses) countProses.textContent = proses;
            if (countBelum) countBelum.textContent = belum;
        }
        
        function updateStatusDropdownOptions() {
            const statusMahasiswaSelect = document.getElementById('statusMahasiswaSelect');
            if (!statusMahasiswaSelect) return;
            
            const currentValue = statusMahasiswaSelect.value;
            statusMahasiswaSelect.innerHTML = '<option value="">Pilih Mahasiswa</option>';
            
            // Add all active mahasiswa
            accounts.mahasiswa.forEach(mhs => {
                if (mhs.status === 'aktif') {
                    const option = document.createElement('option');
                    option.value = `${mhs.nama} (${mhs.nim})`;
                    option.textContent = `${mhs.nama} (${mhs.nim})`;
                    if (option.value === currentValue) option.selected = true;
                    statusMahasiswaSelect.appendChild(option);
                }
            });
        }

        // Add demo data for testing
        function addDemoData() {
            // Demo accounts
            if (accounts.mahasiswa.length === 0) {
                accounts.mahasiswa = [
                    { nim: '2021001', nama: 'Ahmad Fauzi', status: 'aktif' },
                    { nim: '2021002', nama: 'Siti Nurhaliza', status: 'aktif' },
                    { nim: '2021003', nama: 'Muhammad Rizki', status: 'aktif' }
                ];
            }
            
            if (accounts.dosen.length === 0) {
                accounts.dosen = [
                    { username: 'dosen1', password: 'dosen123', nama: 'Dr. H. Abdullah, M.Pd.I', status: 'aktif' },
                    { username: 'dosen2', password: 'dosen123', nama: 'Dr. Hj. Fatimah, M.Ag', status: 'aktif' },
                    { username: 'dosen3', password: 'dosen123', nama: 'Dr. H. Muhammad Ali, M.Pd.I', status: 'aktif' }
                ];
            }
            
            if (accounts.prodi.length === 0) {
                accounts.prodi = [
                    { username: 'prodi', password: 'prodi123', nama: 'Program Studi PAI', status: 'aktif' }
                ];
            }
            
            // Demo submissions
            if (submissions.judulSkripsi.length === 0) {
                submissions.judulSkripsi = [
                    {
                        id: 'judul_1',
                        nim: '2021001',
                        nama: 'Ahmad Fauzi',
                        judul: 'Implementasi Pendidikan Karakter dalam Pembelajaran PAI',
                        latarBelakang: 'Pentingnya pendidikan karakter di era modern',
                        status: 'Menunggu',
                        tanggalPengajuan: new Date().toLocaleDateString('id-ID'),
                        timestamp: new Date()
                    }
                ];
            }
            
            if (submissions.pengajuanSeminar.length === 0) {
                submissions.pengajuanSeminar = [
                    {
                        id: 'seminar_1',
                        nim: '2021001',
                        nama: 'Ahmad Fauzi',
                        tanggalPengajuan: '2025-02-01',
                        tanggalSubmit: new Date().toLocaleDateString('id-ID'),
                        catatanProposal: 'Proposal sudah siap untuk diseminarkan',
                        status: 'Menunggu Penjadwalan',
                        timestamp: new Date()
                    }
                ];
            }
            
            if (submissions.pembimbing.length === 0) {
                submissions.pembimbing = [
                    {
                        id: 'pembimbing_1',
                        nim: '2021001',
                        nama: 'Ahmad Fauzi',
                        nomorSK: 'SK/001/2025',
                        pembimbing1: 'Dr. H. Abdullah, M.Pd.I',
                        pembimbing2: 'Dr. Hj. Fatimah, M.Ag',
                        tanggalSK: new Date().toLocaleDateString('id-ID'),
                        status: 'Aktif',
                        timestamp: new Date()
                    }
                ];
            }
            
            if (submissions.bimbingan.length === 0) {
                submissions.bimbingan = [
                    {
                        id: 'bimbingan_1',
                        mahasiswa: 'Ahmad Fauzi (2021001)',
                        tanggal: '2025-01-15',
                        materi: 'Pembahasan BAB I - Pendahuluan',
                        catatan: 'Perbaiki latar belakang masalah',
                        pembimbing: 'Dr. H. Abdullah, M.Pd.I',
                        timestamp: new Date()
                    },
                    {
                        id: 'bimbingan_2',
                        mahasiswa: 'Ahmad Fauzi (2021001)',
                        tanggal: '2025-01-20',
                        materi: 'Review BAB II - Landasan Teori',
                        catatan: 'Tambahkan referensi terbaru',
                        pembimbing: 'Dr. H. Abdullah, M.Pd.I',
                        timestamp: new Date()
                    }
                ];
            }
            
            if (submissions.statusSkripsi.length === 0) {
                submissions.statusSkripsi = [
                    {
                        id: 'status_1',
                        nim: '2021001',
                        nama: 'Ahmad Fauzi',
                        status: 'Dalam Proses',
                        catatan: 'Sedang menyelesaikan BAB III',
                        tanggalUpdate: new Date().toLocaleDateString('id-ID'),
                        timestamp: new Date()
                    },
                    {
                        id: 'status_2',
                        nim: '2021002',
                        nama: 'Siti Nurhaliza',
                        status: 'Selesai',
                        catatan: 'Lulus dengan nilai A',
                        tanggalUpdate: new Date().toLocaleDateString('id-ID'),
                        timestamp: new Date()
                    }
                ];
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize without triggering events
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById('dashboard').classList.remove('hidden');
            
            // Set initial navigation state
            const navButtons = document.querySelectorAll('.nav-btn');
            navButtons.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600', 'hover:bg-blue-50');
            });
            navButtons[0].classList.remove('text-gray-600', 'hover:bg-blue-50');
            navButtons[0].classList.add('bg-blue-600', 'text-white');
            
            // Initialize filter arrays
            filteredJadwalSeminar = [];
            filteredJadwalMunaqosyah = [];
            
            // Add demo data first
            addDemoData();
            
            // Load data from Firebase
            loadData();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98014440614897fb',t:'MTc1ODAzNTE3NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
